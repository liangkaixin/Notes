
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>èƒŒæ™¯ä»‹ç» ä¼˜æƒ åˆ¸è¥é”€ï¼šæå‡è·å®¢ä¸ç”¨æˆ·å¤è´­çš„å…³é”®ç­–ç•¥ &#8212; My book title</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
  
    <p class="title logo__title">My book title</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    èƒŒæ™¯ä»‹ç» ä¼˜æƒ åˆ¸è¥é”€ï¼šæå‡è·å®¢ä¸ç”¨æˆ·å¤è´­çš„å…³é”®ç­–ç•¥
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>èƒŒæ™¯ä»‹ç» ä¼˜æƒ åˆ¸è¥é”€ï¼šæå‡è·å®¢ä¸ç”¨æˆ·å¤è´­çš„å…³é”®ç­–ç•¥</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">èƒŒæ™¯ä»‹ç» <strong>ä¼˜æƒ åˆ¸è¥é”€ï¼šæå‡è·å®¢ä¸ç”¨æˆ·å¤è´­çš„å…³é”®ç­–ç•¥</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"><strong>ä¼˜æƒ åˆ¸çš„ä¸»è¦åˆ†ç±»</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"><strong>1ï¸âƒ£ æŒ‰ä½¿ç”¨é—¨æ§›åˆ’åˆ†</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"><strong>2ï¸âƒ£ æŒ‰ä¼˜æƒ æ–¹å¼åˆ’åˆ†</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><strong>3ï¸âƒ£ æŒ‰ä½¿ç”¨èŒƒå›´åˆ’åˆ†</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6"><strong>ä¼˜æƒ åˆ¸çš„æŒ‘æˆ˜ä¸ä¼˜åŒ–æ–¹å‘</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7"><strong>âœ… è§£å†³æ–¹æ¡ˆï¼šä¸ªæ€§åŒ–ç²¾å‡†æŠ•æ”¾</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">ğŸ“Š <strong>æ•°æ®é›†è¯´æ˜</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">æè¿°æ€§ç»Ÿè®¡(æ–‡å­—)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">æè¿°æ€§ç»Ÿè®¡(å›¾)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">ä¼˜æƒ åˆ¸é‡‘é¢ä¸é—¨æ§›é‡‘é¢åˆ†å¸ƒå¯¹æ¯”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">ä¼˜æƒ åˆ¸ç±»å‹åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">æè¿°æ€§ç»Ÿè®¡</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">åˆ†ç±»ä¾æ®</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kmeans">é€‰æ‹©1 Kmeansåˆ†ç±»</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">é€‰æ‹©2 é˜ˆå€¼åˆ†ç±»</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">åˆ†ç±»ä¾æ®(å›¾)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">å®é™…ä¼˜æƒ é‡‘é¢ä¸å®ä»˜é‡‘é¢å¯¹æ¯”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">è¶‹åŠ¿åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">äººå‡ä½¿ç”¨ä¼˜æƒ åˆ¸æ¬¡æ•°</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">é¢†åˆ¸æ€»æ•°åˆ†å¸ƒ</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">æ¼æ–—æ¨¡å‹</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">åˆ†æç›®çš„</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">ç”¨æˆ·è½¬åŒ–åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">ç”¨æˆ·å¤è´­è½¬åŒ–ç‡åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">é€šè¿‡å¤è´­ç‡å¯¹ä¼˜æƒ åˆ¸åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">é€šè¿‡ä½¿ç”¨é€Ÿåº¦åˆ†å±‚</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm">RFMç”¨æˆ·ä»·å€¼åˆ†æ</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">1ï¸âƒ£ RFM æ•°æ®åˆ†å¸ƒï¼šç›´æ–¹å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">2ï¸âƒ£ RFM ä¸‰å˜é‡å…³ç³»ï¼šæ•£ç‚¹å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm-k-means">3ï¸âƒ£ RFM åˆ†ç¾¤ï¼šK-Means èšç±»</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">4ï¸âƒ£ å„ç¾¤ä½“çš„ RFM æŒ‡æ ‡ç®±çº¿å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">5ï¸âƒ£ RFM å¾—åˆ†çƒ­åŠ›å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">ç”¨æˆ·ä»·å€¼åˆ†ç±»ç»Ÿè®¡</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">RFM + ç”¨æˆ·è½¬åŒ–åˆ†æ</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">ä¸åŒä»·å€¼æ—ç¾¤çš„è½¬åŒ–æ¼æ–—</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤çš„æ¶ˆè´¹åˆ†å¸ƒ</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">ä¼˜æƒ åˆ¸RFM</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹å æ¯”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#top1unkown">ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹å æ¯”(å»é™¤top1å’ŒUnkown)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">ç»“è®º</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">é£æ§</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">æ¨¡å‹</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1">Part 1 æ¦‚è¿°</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">æ ‡ç­¾</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">ä¼˜æƒ åˆ¸ç‰¹å¾</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">ç”¨æˆ·ç‰¹å¾</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2">Part 2 æ ‡ç­¾æ„å»º</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3">Part 3 ç‰¹å¾å·¥ç¨‹</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4">Part 4 æ¨¡å‹</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.font_manager</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">matplotlib_fname</span><span class="p">())</span>  <span class="c1"># æ˜¾ç¤º Matplotlib é…ç½®æ–‡ä»¶è·¯å¾„</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">())</span> 

<span class="o">!</span>cp<span class="w"> </span>/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/SimHei.ttf<span class="w"> </span>/Users/liangkaixin/Documents/Notes/å•†ä¸šåˆ†æ/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf

<span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
        

<span class="c1"># **1. æŒ‡å®šå­—ä½“æ–‡ä»¶è·¯å¾„**ï¼ˆä¿®æ”¹ä¸ºä½ çš„å®é™…è·¯å¾„ï¼‰</span>
<span class="n">font_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/SimHei.ttf&quot;</span>  <span class="c1"># ä¾‹å¦‚æ”¾åœ¨é¡¹ç›®çš„ fonts ç›®å½•ä¸‹</span>

<span class="c1"># **2. åŠ è½½å­—ä½“**</span>
<span class="n">my_font</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">font_path</span><span class="p">)</span>

<span class="c1"># **3. è®¾ç½® Matplotlib ä½¿ç”¨è¯¥å­—ä½“**</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_font</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.unicode_minus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è§£å†³è´Ÿå· &#39;-&#39; æ˜¾ç¤ºé—®é¢˜</span>

<span class="c1"># æŒ‡å®šä¸€ä¸ªæ”¯æŒä¸­æ–‡çš„å­—ä½“ (å¦‚ SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># æˆ– &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/liangkaixin/Documents/Notes/å•†ä¸šåˆ†æ/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/matplotlibrc
/Users/liangkaixin/.matplotlib
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>èƒŒæ™¯ä»‹ç» <strong>ä¼˜æƒ åˆ¸è¥é”€ï¼šæå‡è·å®¢ä¸ç”¨æˆ·å¤è´­çš„å…³é”®ç­–ç•¥</strong><a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>ä¼˜æƒ åˆ¸è¥é”€æ˜¯äº’è”ç½‘è¡Œä¸šè¿›è¡Œ<strong>è·å®¢</strong>å’Œ<strong>æå‡ç”¨æˆ·å¤è´­</strong>çš„é‡è¦æ‰‹æ®µä¹‹ä¸€ï¼Œè¢«å¹¿æ³›åº”ç”¨äº<strong>ç”µå•†é›¶å”®</strong>å’Œ<strong>ç”Ÿæ´»æœåŠ¡è¡Œä¸š</strong>ã€‚åœ¨æ‹‰æ–°è¿‡ç¨‹ä¸­ï¼Œä¼ä¸šé€šå¸¸ä¼šå‘æ–°ç”¨æˆ·æä¾›<strong>å¤§é¢ä¼˜æƒ åˆ¸</strong>ï¼Œä»¥é™ä½é¦–æ¬¡å°é²œé—¨æ§›ï¼Œä¿ƒæˆäº¤æ˜“å¹¶å»ºç«‹ç”¨æˆ·å¿ƒæ™ºï¼Œå®ç°ä¸šåŠ¡çš„å¿«é€Ÿå¢é•¿ã€‚</p>
<hr class="docutils" />
<section id="id2">
<h2><strong>ä¼˜æƒ åˆ¸çš„ä¸»è¦åˆ†ç±»</strong><a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>åœ¨è¡Œä¸šå¤šå¹´çš„å®è·µå’Œæ¢ç´¢ä¸­ï¼Œä¼˜æƒ åˆ¸çš„è¥é”€ç©æ³•ä¸æ–­è¿­ä»£ã€‚ä»åˆ†ç±»è§’åº¦æ¥çœ‹ï¼Œä¼˜æƒ åˆ¸ä¸»è¦å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p>
<section id="id3">
<h3><strong>1ï¸âƒ£ æŒ‰ä½¿ç”¨é—¨æ§›åˆ’åˆ†</strong><a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>æ— é—¨æ§›åˆ¸</strong>ï¼šé€‚ç”¨äº<strong>æ‹‰æ–°</strong>ï¼Œè®©æ–°ç”¨æˆ·ä»¥<strong>ä½æˆæœ¬ä½“éªŒäº§å“</strong>ï¼Œæœ‰åŠ©äºå»ºç«‹å“ç‰Œå¿ƒæ™ºã€‚</p></li>
<li><p><strong>æœ‰é—¨æ§›åˆ¸</strong>ï¼šèƒ½å¤Ÿ<strong>æå‡ç”¨æˆ·å®¢å•ä»·</strong>ï¼Œä¿ƒè¿›ä½å®¢å•ä»·ç”¨æˆ·çš„æ¶ˆè´¹æ¬²æœ›ã€‚</p></li>
</ul>
</section>
<section id="id4">
<h3><strong>2ï¸âƒ£ æŒ‰ä¼˜æƒ æ–¹å¼åˆ’åˆ†</strong><a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>æ»¡å‡åˆ¸</strong>ï¼šç”¨æˆ·éœ€è¦å‡‘å•è¾¾åˆ°ä¸€å®šé‡‘é¢æ‰èƒ½ä½¿ç”¨ï¼Œèƒ½å¤Ÿ<strong>åˆºæ¿€ç”¨æˆ·æ¶ˆè´¹</strong>ï¼Œæé«˜è®¢å•é‡‘é¢ã€‚</p></li>
<li><p><strong>æŠ˜æ‰£åˆ¸</strong>ï¼šé€‚ç”¨äº<strong>æ¶ˆè´¹é‡‘é¢å›ºå®š</strong>ä½†å¯é€‰æ‹©ä¸åŒå“ç‰Œæˆ–å¹³å°çš„åœºæ™¯ï¼Œå¦‚<strong>å‡ºè¡Œæ‰“è½¦</strong>ç­‰ï¼Œå¢å¼ºç”¨æˆ·å¯¹å¹³å°çš„ç²˜æ€§ã€‚</p></li>
</ul>
</section>
<section id="id5">
<h3><strong>3ï¸âƒ£ æŒ‰ä½¿ç”¨èŒƒå›´åˆ’åˆ†</strong><a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>ç‰¹å®šèŒƒå›´åˆ¸</strong>ï¼ˆå“ç±»åˆ¸ï¼‰ï¼šé€‚ç”¨äº<strong>å‚ç›´ä¸šåŠ¡å®šå‘è¿è¥</strong>ï¼Œå¦‚æŸç±»å•†å“çš„ä¸“å±æŠ˜æ‰£ã€‚</p></li>
<li><p><strong>é€šç”¨åˆ¸</strong>ï¼šé€‚ç”¨äº<strong>å¹³å°çº§è¿è¥</strong>ï¼Œæå‡æ•´ä½“ç”¨æˆ·æ´»è·ƒåº¦å’Œç•™å­˜ç‡ã€‚</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="id6">
<h2><strong>ä¼˜æƒ åˆ¸çš„æŒ‘æˆ˜ä¸ä¼˜åŒ–æ–¹å‘</strong><a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>è¿‘å¹´æ¥ï¼Œç”±äºè¥é”€æ‰‹æ®µçš„<strong>è¿‡åº¦ä½¿ç”¨</strong>ï¼Œ<strong>ä¼˜æƒ åˆ¸çš„å‘æ”¾é‡è¿œè¶…ç”¨æˆ·å®é™…éœ€æ±‚</strong>ï¼Œå¯¼è‡´ï¼š</p>
<ul class="simple">
<li><p><strong>ç”¨æˆ·çš„â€œä¼˜æƒ æ„Ÿâ€å‡å¼±</strong>ï¼Œå½±å“ä¿ƒé”€æ•ˆæœã€‚</p></li>
<li><p><strong>å•†å®¶å’Œå¹³å°çš„è¥é”€æŠ•å…¥å›æŠ¥é™ä½</strong>ã€‚</p></li>
<li><p><strong>éƒ¨åˆ†ç”¨æˆ·â€œè–…ç¾Šæ¯›â€è¡Œä¸ºåŠ å‰§</strong>ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·ä½“éªŒã€‚</p></li>
</ul>
<section id="id7">
<h3><strong>âœ… è§£å†³æ–¹æ¡ˆï¼šä¸ªæ€§åŒ–ç²¾å‡†æŠ•æ”¾</strong><a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p><strong>é€šè¿‡æ•°æ®åˆ†æä¼˜åŒ–æŠ•æ”¾ç­–ç•¥</strong>ï¼Œå¯æœ‰æ•ˆæå‡è¥é”€æ•ˆæœï¼š</p>
<ul class="simple">
<li><p><strong>ç²¾å‡†ç­›é€‰ç›®æ ‡ç”¨æˆ·</strong>ï¼šåˆ†æç”¨æˆ·æ”¶åˆ°ä¼˜æƒ åˆ¸å<strong>æ ¸é”€ä½¿ç”¨çš„å¯èƒ½æ€§</strong>ï¼Œæ‰¾åˆ°æœ€ä¼˜æŠ•æ”¾ç¾¤ä½“ã€‚</p></li>
<li><p><strong>å‡å°‘ä½æ•ˆå‘æ”¾</strong>ï¼šé¿å…æ— æ•ˆæŠ•æ”¾ï¼Œé™ä½ä¼˜æƒ åˆ¸æµªè´¹ï¼Œæé«˜ROIï¼ˆæŠ•èµ„å›æŠ¥ç‡ï¼‰ã€‚</p></li>
<li><p><strong>æå‡ç”¨æˆ·ä½“éªŒ</strong>ï¼šå°†ä¼˜æƒ åˆ¸ç²¾å‡†åŒ¹é…ç»™<strong>çœŸæ­£æœ‰éœ€æ±‚</strong>çš„ç”¨æˆ·ï¼Œå®ç°æ›´å¥½çš„è¥é”€æ•ˆæœã€‚</p></li>
</ul>
<p>é€šè¿‡ç²¾å‡†æŠ•æ”¾ï¼Œ<strong>ç”¨æˆ·</strong>èƒ½è·å¾—çœŸæ­£é€‚åˆè‡ªå·±çš„ä¼˜æƒ ï¼Œ<strong>å•†å®¶</strong>èƒ½è·å¾—æ›´é«˜è½¬åŒ–ç‡ï¼Œ<strong>å¹³å°</strong>åˆ™èƒ½æå‡æ•´ä½“äº¤æ˜“è§„æ¨¡ï¼Œä»è€Œå®ç°<strong>ç”¨æˆ·ã€å•†å®¶ã€å¹³å°ä¸‰èµ¢</strong>çš„å±€é¢ã€‚ ğŸš€</p>
<p>åˆ†æç›®æ ‡</p>
<p>é€šè¿‡åˆ†æå»ºæ¨¡åˆ†æé¢„æµ‹å¹³å°å‘åˆ¸åç”¨æˆ·çš„æ ¸é”€ä½¿ç”¨ç‡ï¼Œä»¥ä¿ƒè¿›å¹³å°å’Œå•†æˆ·æ›´åŠ ç²¾å‡†çš„å¼€å±•è¥é”€æŠ•æ”¾åŠ¨ä½œï¼Œæå‡äº¤æ˜“è½¬åŒ–ã€‚</p>
<p>è¯†åˆ«æ½œåœ¨ä¸šåŠ¡æ¼æ´åŠè–…ç¾Šæ¯›è¡Œä¸ºï¼ŒåŠ©åŠ›é£æ§è§„åˆ™çš„è¿­ä»£åŠæ½œåœ¨é£æ§å¯¹è±¡çš„æŒ–æ˜ã€‚</p>
<p>å…¶ä»–ä¸æœ¬è¯¾é¢˜ç ”ç©¶å†…å®¹ç›¸å…³çš„ä¸šåŠ¡ç›®æ ‡å‡å¯ã€‚</p>
<p><strong>è®¢å•æ•°æ®(order_detail)</strong></p>
<p>ç”¨æˆ·IDã€è®¢å•IDã€ä¸šåŠ¡çº¿åç§°ã€ç”¨æˆ·æ”¯ä»˜æ—¥æœŸã€ç”¨æˆ·å®ä»˜äº¤æ˜“é¢ã€è¡¥è´´é‡‘é¢ç­‰å­—æ®µä¿¡æ¯ã€‚</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>å­—æ®µå</p></th>
<th class="head"><p>å­—æ®µè¯´æ˜</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>User_id</p></td>
<td><p>ç”¨æˆ·ç™»å½•åçš„å”¯ä¸€ç”¨æˆ·ID</p></td>
</tr>
<tr class="row-odd"><td><p>Shop_id</p></td>
<td><p>å•†æˆ·ID</p></td>
</tr>
<tr class="row-even"><td><p>Order_id</p></td>
<td><p>è®¢å•ID</p></td>
</tr>
<tr class="row-odd"><td><p>Coupon_id</p></td>
<td><p>æœ¬æ¬¡ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ID</p></td>
</tr>
<tr class="row-even"><td><p>Coupon_type</p></td>
<td><p>æœ¬æ¬¡ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹</p></td>
</tr>
<tr class="row-odd"><td><p>Biz_code</p></td>
<td><p>ä¸šåŠ¡çº¿åç§°</p></td>
</tr>
<tr class="row-even"><td><p>Pay_date</p></td>
<td><p>ç”¨æˆ·æ”¯ä»˜æ—¥æœŸ</p></td>
</tr>
<tr class="row-odd"><td><p>Actual_pay</p></td>
<td><p>ç”¨æˆ·å®ä»˜äº¤æ˜“é¢</p></td>
</tr>
<tr class="row-even"><td><p>Reduce_amount</p></td>
<td><p>è¡¥è´´é‡‘é¢</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>ç”¨æˆ·æ´»è·ƒ(user_visit_detail)</strong></p>
<p>ç”¨æˆ·åœ¨ç¾å›¢å„ç«¯ï¼ˆAppã€å°ç¨‹åºç­‰ï¼‰çš„æ´»è·ƒæ—¥æœŸã€ç”¨æˆ·IDç­‰å­—æ®µä¿¡æ¯</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>å­—æ®µå</p></th>
<th class="head"><p>å­—æ®µè¯´æ˜</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Visit_date</p></td>
<td><p>ç”¨æˆ·åœ¨ç¾å›¢å„ç«¯ï¼ˆAppã€å°ç¨‹åºç­‰ï¼‰çš„æ´»è·ƒæ—¥æœŸï¼ŒåŒ…æ‹¬ç¾å›¢ã€ç¾å›¢å¤–å–ç­‰å„åº”ç”¨ã€‚</p></td>
</tr>
<tr class="row-odd"><td><p>User_id</p></td>
<td><p>ç”¨æˆ·ç™»å½•åçš„å”¯ä¸€ç”¨æˆ·ID</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>ç”¨æˆ·è·åˆ¸æ•°æ®(user_coupon_receive)</strong></p>
<p>åŒ…æ‹¬ç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…é€šè¿‡è´­ä¹°ã€ä¸»åŠ¨é¢†å–å’Œå¹³å°ä¸»åŠ¨å‘æ”¾çš„å„ç±»ä¼˜æƒ åˆ¸ã€‚å…¶ä¸­å•†å“ç«‹å‡ç­‰éä¼˜æƒ åˆ¸è¡¥è´´æ–¹å¼æœªæ¶µç›–åœ¨æ­¤æ•°æ®ä¸­ã€‚</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>å­—æ®µå</p></th>
<th class="head"><p>å­—æ®µè¯´æ˜</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>User_id</p></td>
<td><p>ç”¨æˆ·ç™»å½•åçš„å”¯ä¸€ç”¨æˆ·ID</p></td>
</tr>
<tr class="row-odd"><td><p>Coupon_id</p></td>
<td><p>ä¼˜æƒ åˆ¸ID</p></td>
</tr>
<tr class="row-even"><td><p>Coupon_status</p></td>
<td><p>åˆ¸çŠ¶æ€(1-æœªä½¿ç”¨ 2-å·²ä½¿ç”¨ 3-å…¶ä»–)</p></td>
</tr>
<tr class="row-odd"><td><p>Coupon_amt</p></td>
<td><p>åˆ¸é¢é¢(å•ä½ï¼šå…ƒ)</p></td>
</tr>
<tr class="row-even"><td><p>Receive_time</p></td>
<td><p>åˆ¸è·å–æ—¶é—´(yyyy-MM-dd )</p></td>
</tr>
<tr class="row-odd"><td><p>Start_time</p></td>
<td><p>åˆ¸ç”Ÿæ•ˆå¼€å§‹æ—¶é—´(yyyy-MM-dd)</p></td>
</tr>
<tr class="row-even"><td><p>End_time</p></td>
<td><p>åˆ¸è¿‡æœŸæ—¶é—´(yyyy-MM-dd)</p></td>
</tr>
<tr class="row-odd"><td><p>Price_limit</p></td>
<td><p>åˆ¸ä½¿ç”¨é—¨æ§›(å•ä½ï¼šå…ƒ)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id8">
<h1>ğŸ“Š <strong>æ•°æ®é›†è¯´æ˜</strong><a class="headerlink" href="#id8" title="Link to this heading">#</a></h1>
<p>æœ¬æ•°æ®é›†æä¾›çš„æ‰€æœ‰æ•°æ®å‡æ¥è‡ª<strong>çœŸå®ä¸šåŠ¡</strong>ï¼Œå¹¶ç»è¿‡<strong>è„±æ•å¤„ç†</strong>ï¼Œç¡®ä¿ä¸æ¶‰åŠç”¨æˆ·éšç§ä¿¡æ¯ã€‚æ•°æ®æ¶µç›–äº†<strong>2023å¹´1æœˆ1æ—¥ è‡³ 2023å¹´6æœˆ30æ—¥</strong>çš„è®¢å•åŠç”¨æˆ·è¡Œä¸ºä¿¡æ¯ï¼Œå…±åŒ…å«<strong>5ä¸‡åç”¨æˆ·</strong>çš„æ•°æ®ã€‚</p>
<p>æ•°æ®å­˜å‚¨åœ¨<strong>3ä¸ªæ–‡ä»¶</strong>ä¸­ï¼Œå…·ä½“å­—æ®µåŠæè¿°å¦‚ä¸‹ï¼š</p>
<section id="id9">
<h2>æè¿°æ€§ç»Ÿè®¡(æ–‡å­—)<a class="headerlink" href="#id9" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/order_detail.csv&#39;</span><span class="p">)</span>
<span class="n">user_visit_detail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/user_visit_detail.csv&#39;</span><span class="p">)</span>
<span class="n">user_coupon_receive</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/user_coupon_receive.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">order_detail</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 1543536 entries, 0 to 1543535
Data columns (total 9 columns):
 #   Column         Non-Null Count    Dtype  
---  ------         --------------    -----  
 0   User_id        1543536 non-null  object 
 1   Shop_id        1522799 non-null  object 
 2   Order_id       1543536 non-null  object 
 3   Coupon_id      639960 non-null   object 
 4   Coupon_type    639830 non-null   float64
 5   Biz_code       1543536 non-null  object 
 6   Pay_date       1543536 non-null  object 
 7   Actual_pay     1543536 non-null  float64
 8   Reduce_amount  1543536 non-null  float64
dtypes: float64(3), object(6)
memory usage: 106.0+ MB
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 2815177 entries, 0 to 2815176
Data columns (total 2 columns):
 #   Column      Dtype 
---  ------      ----- 
 0   User_id     object
 1   Visit_date  object
dtypes: object(2)
memory usage: 43.0+ MB
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 2179387 entries, 0 to 2179386
Data columns (total 8 columns):
 #   Column         Dtype  
---  ------         -----  
 0   User_id        object 
 1   Coupon_id      object 
 2   Coupon_status  float64
 3   Coupon_amt     float64
 4   Receive_date   object 
 5   Start_date     object 
 6   End_date       object 
 7   Price_limit    float64
dtypes: float64(3), object(5)
memory usage: 133.0+ MB
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">order_detail</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Shop_id</th>
      <th>Order_id</th>
      <th>Coupon_id</th>
      <th>Coupon_type</th>
      <th>Biz_code</th>
      <th>Pay_date</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1f434874e1371f4651011aec29e463a6</td>
      <td>a6900d0b0e94121a05b8f076d793b36a</td>
      <td>cf215ea951d8a8dc09002cd9e5b2d9ec</td>
      <td>7e4ae1565cc015a44f10263d7ffe4dc0</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-02-10</td>
      <td>30.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>fe845ad183d4ba6ebed2138dfa5fc933</td>
      <td>4e08575cf11cfb11b9719e21bae525b0</td>
      <td>1f8e69ba356e3c786e3e4de600db4f8a</td>
      <td>0a52ebb2f236b558eb5deb0bb73c2613</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-03-26</td>
      <td>22.3000000000</td>
      <td>6.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>56a8a58c7fa83d67862af639c9c5e63f</td>
      <td>c89b4088551c6c98ba02c502b478a824</td>
      <td>bb4ae29d7962a312adc450fe4c7f4965</td>
      <td>20dd5ba437c64f36dfc0f71705324665</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-06-07</td>
      <td>20.2000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>e24374a1fa8e24ed2a39ff614373735e</td>
      <td>f4c9dd2982c4c4192b2e92b1928c502d</td>
      <td>3f0912b08f064f50c571b0e91d7cf059</td>
      <td>161aedbed0ff7ba4d5d204cfeb02ef1c</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-03-17</td>
      <td>43.0000000000</td>
      <td>4.0000000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>91ae4cda5ece690f65317eaa64f5c6d2</td>
      <td>c7e657fc94b2c7316b5164569dc49834</td>
      <td>6ffa6bf214d4e1ef20fec6ecf3a0c9ce</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-02-15</td>
      <td>21.7000000000</td>
      <td>0.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Visit_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>32a91327f9b7362967b7d16514635e16</td>
      <td>2023-03-18</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9ca8a9d70ce07addf37204b70bf2246d</td>
      <td>2023-02-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>dc07b6243f082052cd7b97c8034bab65</td>
      <td>2023-05-03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b836e40c1d6e2e2ebc432fb3c66af8cb</td>
      <td>2023-06-30</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aeee21d421b1c625c4e4432ffb2fb088</td>
      <td>2023-02-01</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Coupon_id</th>
      <th>Coupon_status</th>
      <th>Coupon_amt</th>
      <th>Receive_date</th>
      <th>Start_date</th>
      <th>End_date</th>
      <th>Price_limit</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>198f3736deb018366b7e76a00ca61a24</td>
      <td>61ce2f87cf1edf6e5f31520cda09b89a</td>
      <td>2.0000000000</td>
      <td>10.0000000000</td>
      <td>2023-04-26</td>
      <td>2023-04-26</td>
      <td>2023-04-26</td>
      <td>25.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c962d8f6542b0ec14a2cef371cf2f9b2</td>
      <td>3aa11cc0f8698d5a2c9ce34bbf3bf919</td>
      <td>3.0000000000</td>
      <td>7.0000000000</td>
      <td>2023-04-11</td>
      <td>2023-04-11</td>
      <td>2023-04-14</td>
      <td>20.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9e9ffb33c7e434e0db6a599300860121</td>
      <td>4d404e8b2765a960705288d5e16da562</td>
      <td>3.0000000000</td>
      <td>1.0000000000</td>
      <td>2023-02-10</td>
      <td>2023-02-10</td>
      <td>2023-02-11</td>
      <td>5.0000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>f4e5fd8d8a7e6eb033e1e488a93827ae</td>
      <td>31f89b13f0023f8d0a88eed43a64fb4a</td>
      <td>3.0000000000</td>
      <td>3.0000000000</td>
      <td>2023-04-06</td>
      <td>2023-04-06</td>
      <td>2023-04-09</td>
      <td>12.0000000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>870c5425bc174a7b578185cff9701ebd</td>
      <td>3e2e32d8aac9adf7748698cb58e9ebd4</td>
      <td>1.0000000000</td>
      <td>5.0000000000</td>
      <td>2023-05-17</td>
      <td>2023-05-17</td>
      <td>2023-05-24</td>
      <td>30.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">()</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 8 entries, count to max
Data columns (total 3 columns):
 #   Column         Non-Null Count  Dtype  
---  ------         --------------  -----  
 0   Coupon_status  8 non-null      float64
 1   Coupon_amt     8 non-null      float64
 2   Price_limit    8 non-null      float64
dtypes: float64(3)
memory usage: 256.0+ bytes
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coupon_type</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>639830.0000000000</td>
      <td>1543536.0000000000</td>
      <td>1543536.0000000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>277.6431208290</td>
      <td>38.9114167276</td>
      <td>1.4435685404</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2004.7185017906</td>
      <td>70.9594274593</td>
      <td>5.2437157963</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.0000000000</td>
      <td>17.4000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1.0000000000</td>
      <td>24.4000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.0000000000</td>
      <td>38.3000000000</td>
      <td>2.0000000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>20014.0000000000</td>
      <td>41840.0000000000</td>
      <td>1599.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id10">
<h2>æè¿°æ€§ç»Ÿè®¡(å›¾)<a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Count the occurrences of each value in &#39;Coupon_status&#39;</span>
<span class="c1"># Map the numeric Coupon_status to categories</span>

<span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span>  <span class="c1"># 1: æœªä½¿ç”¨</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span>  <span class="c1"># 2: å·²ä½¿ç”¨</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;#ffab00&#39;</span>   <span class="c1"># 3: å…¶ä»–</span>
<span class="p">}</span>


<span class="n">status_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;æœªä½¿ç”¨&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;å·²ä½¿ç”¨&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;å…¶ä»–&#39;</span><span class="p">}</span>
<span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status_trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">status_mapping</span><span class="p">)</span>
<span class="n">coupon_status_counts</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status_trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Coupon_status&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">]</span>
<span class="c1"># é¢œè‰²æ˜ å°„</span>
<span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;æœªä½¿ç”¨&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span>  
    <span class="s1">&#39;å·²ä½¿ç”¨&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span>  
    <span class="s1">&#39;å…¶ä»–&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffab00&#39;</span>   
<span class="p">}</span>

<span class="c1"># ç»Ÿè®¡ä¼˜æƒ åˆ¸çŠ¶æ€æ•°é‡</span>
<span class="n">coupon_status_counts</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status_trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># è®¾ç½®ç”»å¸ƒ</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># ç»˜åˆ¶æŸ±çŠ¶å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># è®¾ç½®æ ‡é¢˜å’Œæ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸çŠ¶æ€åˆ†å¸ƒ&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸çŠ¶æ€&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;æ•°é‡&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºæ•°å€¼æ ‡ç­¾</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/87eee662b8f31da317a316655cae74da39c409d808bea24ad309d49adcbf3395.png" src="_images/87eee662b8f31da317a316655cae74da39c409d808bea24ad309d49adcbf3395.png" />
</div>
</div>
</section>
<section id="id11">
<h2>ä¼˜æƒ åˆ¸é‡‘é¢ä¸é—¨æ§›é‡‘é¢åˆ†å¸ƒå¯¹æ¯”<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è®¾ç½®ç”»å¸ƒå¤§å°</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># ç»˜åˆ¶ ä¼˜æƒ åˆ¸é‡‘é¢ çš„ç›´æ–¹å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_amt&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ä¼˜æƒ åˆ¸é‡‘é¢&#39;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ é—¨æ§›é‡‘é¢ çš„ç›´æ–¹å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Price_limit&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32CD32&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;é—¨æ§›é‡‘é¢&#39;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®å¯¹æ•° y è½´</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®å›¾è¡¨æ ‡é¢˜å’Œæ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸é‡‘é¢ä¸é—¨æ§›é‡‘é¢åˆ†å¸ƒå¯¹æ¯”&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;é‡‘é¢&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;é¢‘æ¬¡&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾ä¾‹</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fcef0293cdf58d46b671a956283bdfb5823e6523e8211d3636e867f4504f8e81.png" src="_images/fcef0293cdf58d46b671a956283bdfb5823e6523e8211d3636e867f4504f8e81.png" />
</div>
</div>
</section>
<section id="id12">
<h2>ä¼˜æƒ åˆ¸ç±»å‹åˆ†æ<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
</section>
<section id="id13">
<h2>æè¿°æ€§ç»Ÿè®¡<a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<p>æ— é—¨æ§›ä¼˜æƒ åˆ¸ Price_limit = 0</p>
<p>æœ‰é—¨æ§›ä¼˜æƒ åˆ¸ Price_limit &gt; 0</p>
<p>æŠ˜æ‰£åˆ¸: æ— é¢å€¼</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        coupon_type,      </span>
<span class="s1">        count(*) as é¢†åˆ¸æ¬¡æ•°,</span>
<span class="s1">        sum(Coupon_amt) / count(*) as åˆ¸å‡é¢å€¼,</span>
<span class="s1">        sum(End_date::date - Start_date::date) / count(*) as åˆ¸å‡æœ‰æ•ˆæœŸé•¿åº¦,  </span>
<span class="s1">        sum(Price_limit) / count(*) as åˆ¸å‡ä½¿ç”¨é—¨æ§›</span>
<span class="s1">from user_coupon_receive</span>
<span class="s1">left join (select distinct coupon_id, coupon_type from order_detail) using(coupon_id)        </span>
<span class="s1">group by 1</span>
<span class="s1">order by Coupon_type</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coupon_type</th>
      <th>é¢†åˆ¸æ¬¡æ•°</th>
      <th>åˆ¸å‡é¢å€¼</th>
      <th>åˆ¸å‡æœ‰æ•ˆæœŸé•¿åº¦</th>
      <th>åˆ¸å‡ä½¿ç”¨é—¨æ§›</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000000000</td>
      <td>126</td>
      <td>12.8888888889</td>
      <td>45.4841269841</td>
      <td>75.9448412698</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0000000000</td>
      <td>97542</td>
      <td>5.8741960386</td>
      <td>12.2196387197</td>
      <td>16.2389124685</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0000000000</td>
      <td>847</td>
      <td>11.4271546635</td>
      <td>8.8831168831</td>
      <td>1.8158205431</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0000000000</td>
      <td>926</td>
      <td>68.7073434125</td>
      <td>10.7721382289</td>
      <td>1113.4665226782</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0000000000</td>
      <td>1406</td>
      <td>519.5199146515</td>
      <td>18.7816500711</td>
      <td>22.0583214794</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.0000000000</td>
      <td>200</td>
      <td>5.9550000000</td>
      <td>28.0400000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9.0000000000</td>
      <td>18</td>
      <td>6.9444444444</td>
      <td>2.3333333333</td>
      <td>28.4444444444</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10.0000000000</td>
      <td>77</td>
      <td>3.8437662338</td>
      <td>1.0129870130</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10010.0000000000</td>
      <td>1097</td>
      <td>NaN</td>
      <td>5.1804922516</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10012.0000000000</td>
      <td>49</td>
      <td>NaN</td>
      <td>1.2857142857</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10015.0000000000</td>
      <td>38</td>
      <td>NaN</td>
      <td>0.8157894737</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11</th>
      <td>NaN</td>
      <td>2077061</td>
      <td>41.3829318831</td>
      <td>6.1974790341</td>
      <td>48.5356758083</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        coupon_type,</span>
<span class="s1">        AVG(Actual_pay + Reduce_amount)::INT AS å•†å“å¹³å‡ä»·æ ¼,</span>
<span class="s1">        sum(reduce_amount) / count(*) as åˆ¸å‡ä¼˜æƒ ä»·æ ¼,</span>
<span class="s1">        sum(reduce_amount) * 100 / sum(actual_pay + reduce_amount) as ä¼˜æƒ æ¯”ä¾‹,</span>
<span class="s1">        count(*) / (select count(*) from order_detail where coupon_type is not null) * 100 as ä½¿ç”¨æ¯”ä¾‹,</span>
<span class="s1">        count(*) ä½¿ç”¨æ¬¡æ•°</span>
<span class="s1">from order_detail       </span>
<span class="s1">where coupon_type is not null</span>
<span class="s1">group by 1</span>
<span class="s1">order by Coupon_type</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># åˆ›å»ºç”»å¸ƒ</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># ç»˜åˆ¶ åˆ¸å‡ä¼˜æƒ ä»·æ ¼ çš„æ¡å½¢å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;å„ä¼˜æƒ åˆ¸ç±»å‹çš„åˆ¸å‡ä¼˜æƒ ä»·æ ¼&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸ç±»å‹&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ ä¼˜æƒ æ¯”ä¾‹ çš„æ¡å½¢å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;å„ä¼˜æƒ åˆ¸ç±»å‹çš„ä¼˜æƒ æ¯”ä¾‹&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸ç±»å‹&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ æ¯”ä¾‹ (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ ä½¿ç”¨æ¬¡æ•° çš„æ¡å½¢å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;å„ä¼˜æƒ åˆ¸ç±»å‹çš„ä½¿ç”¨æ¬¡æ•°&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸ç±»å‹&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ä½¿ç”¨æ¬¡æ•°&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>


<span class="c1"># ç»˜åˆ¶ ä½¿ç”¨æ¬¡æ•° çš„æ¡å½¢å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;log_ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;å„ä¼˜æƒ åˆ¸ç±»å‹çš„ä½¿ç”¨æ¬¡æ•°ï¼ˆå–å¯¹æ•°ï¼‰&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸ç±»å‹&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ä½¿ç”¨æ¬¡æ•°å¯¹æ•°&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># è°ƒæ•´å¸ƒå±€</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coupon_type</th>
      <th>å•†å“å¹³å‡ä»·æ ¼</th>
      <th>åˆ¸å‡ä¼˜æƒ ä»·æ ¼</th>
      <th>ä¼˜æƒ æ¯”ä¾‹</th>
      <th>ä½¿ç”¨æ¯”ä¾‹</th>
      <th>ä½¿ç”¨æ¬¡æ•°</th>
      <th>log_ä½¿ç”¨æ¬¡æ•°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000000000</td>
      <td>246</td>
      <td>2.6240681576</td>
      <td>1.0671126828</td>
      <td>0.1467577325</td>
      <td>939</td>
      <td>6.8458798753</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0000000000</td>
      <td>34</td>
      <td>2.3050967231</td>
      <td>6.7622172465</td>
      <td>89.1554006533</td>
      <td>570443</td>
      <td>13.2541702840</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0000000000</td>
      <td>33</td>
      <td>3.0172434766</td>
      <td>9.0978488660</td>
      <td>0.7966178516</td>
      <td>5097</td>
      <td>8.5366035849</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0000000000</td>
      <td>133</td>
      <td>7.0602147385</td>
      <td>5.2943713727</td>
      <td>3.6245565228</td>
      <td>23191</td>
      <td>10.0515626706</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0000000000</td>
      <td>191</td>
      <td>1.8468000936</td>
      <td>0.9679794784</td>
      <td>1.3353547036</td>
      <td>8544</td>
      <td>9.0531015955</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.0000000000</td>
      <td>55</td>
      <td>8.1893552995</td>
      <td>14.9355591872</td>
      <td>0.2034915524</td>
      <td>1302</td>
      <td>7.1724245771</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6.0000000000</td>
      <td>43</td>
      <td>0.0595479536</td>
      <td>0.1390072039</td>
      <td>2.5584920995</td>
      <td>16370</td>
      <td>9.7032667559</td>
    </tr>
    <tr>
      <th>7</th>
      <td>9.0000000000</td>
      <td>46</td>
      <td>8.9276344086</td>
      <td>19.2073417587</td>
      <td>0.0145351109</td>
      <td>93</td>
      <td>4.5432947823</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10.0000000000</td>
      <td>56</td>
      <td>3.8614691943</td>
      <td>6.8875066781</td>
      <td>0.0659550193</td>
      <td>422</td>
      <td>6.0473721790</td>
    </tr>
    <tr>
      <th>9</th>
      <td>11.0000000000</td>
      <td>76</td>
      <td>3.5571428571</td>
      <td>4.6605648829</td>
      <td>0.0010940406</td>
      <td>7</td>
      <td>2.0794415417</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10010.0000000000</td>
      <td>87</td>
      <td>6.5483901378</td>
      <td>7.4927503471</td>
      <td>1.2931559946</td>
      <td>8274</td>
      <td>9.0209942002</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10012.0000000000</td>
      <td>136</td>
      <td>14.6184203297</td>
      <td>10.7296729289</td>
      <td>0.1137802229</td>
      <td>728</td>
      <td>6.5916737320</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10015.0000000000</td>
      <td>5</td>
      <td>4.8580813953</td>
      <td>98.9965168353</td>
      <td>0.0268821406</td>
      <td>172</td>
      <td>5.1532915945</td>
    </tr>
    <tr>
      <th>13</th>
      <td>20011.0000000000</td>
      <td>132</td>
      <td>9.0185556578</td>
      <td>6.8071339026</td>
      <td>0.1698888767</td>
      <td>1087</td>
      <td>6.9920964274</td>
    </tr>
    <tr>
      <th>14</th>
      <td>20013.0000000000</td>
      <td>46</td>
      <td>2.5482352941</td>
      <td>5.5075864624</td>
      <td>0.0185986903</td>
      <td>119</td>
      <td>4.7874917428</td>
    </tr>
    <tr>
      <th>15</th>
      <td>20014.0000000000</td>
      <td>46</td>
      <td>0.2454207758</td>
      <td>0.5364929385</td>
      <td>0.4754387884</td>
      <td>3042</td>
      <td>8.0205991499</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/6b93c9b627b90a003842335cc49398dcfea157c1c370179984062437815753b3.png" src="_images/6b93c9b627b90a003842335cc49398dcfea157c1c370179984062437815753b3.png" />
</div>
</div>
<p>è¦å¯¹è¿™äº›ä¼˜æƒ åˆ¸æ•°æ®è¿›è¡Œåˆ†ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒçš„ç‰¹å¾å€¼ï¼ˆå¦‚ï¼šåˆ¸å‡ä¼˜æƒ ä»·æ ¼ã€ä¼˜æƒ æ¯”ä¾‹ç­‰ï¼‰æ¥å®šä¹‰ä¸åŒçš„ç±»åˆ«ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¯èƒ½çš„åˆ†ç±»æ–¹å¼ï¼š</p>
<ol class="arabic simple">
<li><p>æŒ‰ä¼˜æƒ æ¯”ä¾‹åˆ†ç±»
æ ¹æ®â€œä¼˜æƒ æ¯”ä¾‹â€æ¥è¿›è¡Œåˆ†ç±»ã€‚å¯ä»¥æŒ‰ç…§ä¼˜æƒ æ¯”ä¾‹çš„ä¸åŒåˆ’åˆ†æˆå‡ ç±»ã€‚ä¾‹å¦‚ï¼š</p></li>
</ol>
<p>é«˜ä¼˜æƒ ï¼šä¼˜æƒ æ¯”ä¾‹å¤§äºæŸä¸ªé˜ˆå€¼ï¼ˆä¾‹å¦‚ï¼Œ10%ï¼‰ã€‚</p>
<p>ä¸­ç­‰ä¼˜æƒ ï¼šä¼˜æƒ æ¯”ä¾‹åœ¨æŸä¸ªèŒƒå›´å†…ï¼ˆä¾‹å¦‚ï¼Œ5%-10%ï¼‰ã€‚</p>
<p>ä½ä¼˜æƒ ï¼šä¼˜æƒ æ¯”ä¾‹ä½äºæŸä¸ªé˜ˆå€¼ï¼ˆä¾‹å¦‚ï¼Œ5%ï¼‰ã€‚</p>
<ol class="arabic simple" start="2">
<li><p>æŒ‰åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†ç±»
æ ¹æ®â€œåˆ¸å‡ä¼˜æƒ ä»·æ ¼â€æ¥è¿›è¡Œåˆ†ç±»ã€‚æ¯”å¦‚ï¼š</p></li>
</ol>
<p>é«˜ä»·ä¼˜æƒ åˆ¸ï¼šåˆ¸å‡ä¼˜æƒ ä»·æ ¼è¾ƒé«˜ã€‚</p>
<p>ä½ä»·ä¼˜æƒ åˆ¸ï¼šåˆ¸å‡ä¼˜æƒ ä»·æ ¼è¾ƒä½ã€‚</p>
<ol class="arabic simple" start="3">
<li><p>æŒ‰ä¼˜æƒ åˆ¸ç±»å‹åˆ†ç±»
æ ¹æ®â€œCoupon_typeâ€æ¥å¯¹ä¼˜æƒ åˆ¸è¿›è¡Œç±»åˆ«åˆ’åˆ†ã€‚ä½ å¯ä»¥ä¸ºä¸åŒçš„Coupon_typeèµ‹äºˆä¸åŒçš„ç±»åˆ«æ ‡ç­¾ã€‚</p></li>
<li><p>ç»¼åˆåˆ†ç±»
æ ¹æ®å¤šä¸ªç‰¹å¾ï¼ˆå¦‚ä¼˜æƒ æ¯”ä¾‹å’Œåˆ¸å‡ä¼˜æƒ ä»·æ ¼ï¼‰æ¥ç»¼åˆåˆ†ç±»ï¼Œå¯èƒ½æœ‰ä»¥ä¸‹å‡ ç§ç±»åˆ«ï¼š</p></li>
</ol>
<p>é«˜ä»·å€¼ä¼˜æƒ åˆ¸ï¼šä¼˜æƒ æ¯”ä¾‹å’Œåˆ¸å‡ä¼˜æƒ ä»·æ ¼éƒ½è¾ƒé«˜ã€‚</p>
<p>ä¸­ç­‰ä»·å€¼ä¼˜æƒ åˆ¸ï¼šä¼˜æƒ æ¯”ä¾‹å’Œåˆ¸å‡ä¼˜æƒ ä»·æ ¼éƒ½åœ¨ä¸­é—´ã€‚</p>
<p>ä½ä»·å€¼ä¼˜æƒ åˆ¸ï¼šä¼˜æƒ æ¯”ä¾‹å’Œåˆ¸å‡ä¼˜æƒ ä»·æ ¼éƒ½è¾ƒä½ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;WITH coupon_stats AS (</span>
<span class="s1">    SELECT </span>
<span class="s1">        coupon_type,</span>
<span class="s1">        SUM(reduce_amount) / COUNT(*) AS åˆ¸å‡ä¼˜æƒ ä»·æ ¼,</span>
<span class="s1">        SUM(reduce_amount) * 100.0 / SUM(actual_pay + reduce_amount) AS ä¼˜æƒ æ¯”ä¾‹,</span>
<span class="s1">        COUNT(*) AS ä½¿ç”¨æ¬¡æ•°</span>
<span class="s1">    FROM order_detail       </span>
<span class="s1">    WHERE coupon_type IS NOT NULL</span>
<span class="s1">    GROUP BY 1</span>
<span class="s1">)</span>
<span class="s1">SELECT </span>
<span class="s1">    PERCENTILE_CONT(0.2) WITHIN GROUP (ORDER BY åˆ¸å‡ä¼˜æƒ ä»·æ ¼) AS p20_åˆ¸å‡ä¼˜æƒ ä»·æ ¼,</span>
<span class="s1">    PERCENTILE_CONT(0.2) WITHIN GROUP (ORDER BY ä¼˜æƒ æ¯”ä¾‹) AS p20_ä¼˜æƒ æ¯”ä¾‹,</span>
<span class="s1">    PERCENTILE_CONT(0.2) WITHIN GROUP (ORDER BY ä½¿ç”¨æ¬¡æ•°) AS p20_ä½¿ç”¨æ¬¡æ•°</span>
<span class="s1">FROM coupon_stats;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  p20_åˆ¸å‡ä¼˜æƒ ä»·æ ¼  â”‚    p20_ä¼˜æƒ æ¯”ä¾‹    â”‚ p20_ä½¿ç”¨æ¬¡æ•° â”‚
â”‚       double       â”‚       double       â”‚    double    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2.3050967230731225 â”‚ 1.0671126828117985 â”‚        172.0 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre></div>
</div>
</div>
</div>
</section>
<section id="id14">
<h2>åˆ†ç±»ä¾æ®<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<section id="kmeans">
<h3>é€‰æ‹©1 Kmeansåˆ†ç±»<a class="headerlink" href="#kmeans" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># é€‰æ‹©è¦è¿›è¡Œèšç±»çš„ç‰¹å¾</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">,</span> <span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">,</span> <span class="s1">&#39;log_ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">]]</span>

<span class="c1"># ä½¿ç”¨è‚˜éƒ¨æ³•åˆ™ç¡®å®šèšç±»æ•°</span>
<span class="n">inertia</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># è¯•è¯•1åˆ°10ä¸ªèšç±»</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">inertia</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶è‚˜éƒ¨æ³•åˆ™å›¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;è‚˜éƒ¨æ³•åˆ™ (Elbow Method)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;èšç±»æ•° (K)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SSE (è¯¯å·®å¹³æ–¹å’Œ)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/12f414fcd501d394e78112156d5f1c04e0d385d5567aabc650b0cd8a6ea5c90b.png" src="_images/12f414fcd501d394e78112156d5f1c04e0d385d5567aabc650b0cd8a6ea5c90b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ä»è‚˜éƒ¨æ³•åˆ™å›¾é€‰æ‹©èšç±»æ•°ï¼Œä¾‹å¦‚é€‰æ‹©3ä¸ªèšç±»</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;èšç±»æ ‡ç­¾&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="c1"># è®¾ç½®ç”»å¸ƒ</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶æ•£ç‚¹å›¾</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">],</span> 
                     <span class="n">c</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;èšç±»æ ‡ç­¾&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># æ·»åŠ é¢œè‰²æ¡</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;èšç±»æ ‡ç­¾&quot;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®åæ ‡è½´æ ‡ç­¾</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;log_æ—¥å‡ä½¿ç”¨æ¬¡æ•°&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Kå‡å€¼èšç±»ç»“æœ (ä¼˜æƒ åˆ¸ç±»å‹)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾å½¢</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">Coupon_tag</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="s1">&#39;èšç±»æ ‡ç­¾&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/876375dadfba8d95effa6daa87e65c3fbec925c01d76941816fc7394d708dc4b.png" src="_images/876375dadfba8d95effa6daa87e65c3fbec925c01d76941816fc7394d708dc4b.png" />
</div>
</div>
<p>åœ¨ä½¿ç”¨ Kå‡å€¼èšç±»è¿›è¡Œä¼˜æƒ åˆ¸åˆ†ç±»æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸‰ä¸ªç‰¹å¾æ¥è¿›è¡Œèšç±»ï¼š</p>
<ol class="arabic simple">
<li><p><strong>åˆ¸å‡ä¼˜æƒ ä»·æ ¼</strong>ï¼šæ¯å¼ ä¼˜æƒ åˆ¸çš„å¹³å‡ä¼˜æƒ ä»·æ ¼ã€‚</p></li>
<li><p><strong>ä¼˜æƒ æ¯”ä¾‹</strong>ï¼šä¼˜æƒ åˆ¸çš„ä¼˜æƒ é‡‘é¢ä¸æ€»é‡‘é¢çš„æ¯”ä¾‹ã€‚</p></li>
<li><p><strong>æ—¥å‡ä½¿ç”¨æ¬¡æ•°</strong>ï¼šæ¯ä¸ªä¼˜æƒ åˆ¸ç±»å‹çš„æ—¥å‡ä½¿ç”¨æ¬¡æ•°ã€‚</p></li>
<li><p><strong>èšç±»æ•°çš„é€‰æ‹©</strong>ï¼ˆé€šè¿‡è‚˜éƒ¨æ³•åˆ™ï¼‰ï¼š</p></li>
</ol>
<ul>
<li><p><strong>è‚˜éƒ¨æ³•åˆ™</strong>ï¼šæˆ‘ä»¬é€šè¿‡è‚˜éƒ¨æ³•åˆ™ï¼ˆElbow Methodï¼‰æ¥ç¡®å®šèšç±»æ•°ã€‚è‚˜éƒ¨æ³•åˆ™çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œéšç€èšç±»æ•°å¢å¤šï¼Œè¯¯å·®å¹³æ–¹å’Œï¼ˆSSEï¼‰ä¼šä¸æ–­å‡å°ï¼Œä½†åœ¨æŸä¸ªèšç±»æ•°åï¼Œè¯¯å·®çš„ä¸‹é™é€Ÿåº¦ä¼šæ”¾ç¼“ï¼ˆå½¢æˆâ€œè‚˜éƒ¨â€ï¼‰ã€‚æˆ‘ä»¬é€šå¸¸é€‰æ‹©è¯¥â€œè‚˜éƒ¨â€å¤„çš„èšç±»æ•°ä½œä¸ºæœ€ä½³èšç±»æ•°ã€‚</p>
<ul class="simple">
<li><p><strong>å›¾ç¤ºåˆ†æ</strong>ï¼šä½ ç»˜åˆ¶çš„è‚˜éƒ¨æ³•åˆ™å›¾å±•ç¤ºäº†ä¸åŒèšç±»æ•°ä¸‹çš„è¯¯å·®å¹³æ–¹å’Œï¼ˆSSEï¼‰ã€‚é€šè¿‡æŸ¥çœ‹å›¾å½¢çš„â€œè‚˜éƒ¨â€ä½ç½®ï¼Œå¯ä»¥åˆ¤æ–­åˆé€‚çš„èšç±»æ•°ã€‚</p></li>
<li><p>ä¾‹å¦‚ï¼Œå¦‚æœè‚˜éƒ¨å‡ºç°åœ¨ K=8ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹© K=8ï¼Œæ„å‘³ç€æœ€ä½³çš„èšç±»æ•°ä¸º 8ã€‚</p></li>
</ul>
<p>åœ¨ä½ çš„ä»£ç ä¸­ï¼Œä½ é€‰æ‹©äº† K=8ï¼Œè¡¨ç¤ºä½ æƒ³å°†ä¼˜æƒ åˆ¸åˆ†æˆ 8 ç±»ã€‚è™½ç„¶åœ¨è‚˜éƒ¨æ³•åˆ™ä¸­æ²¡æœ‰æ˜æ˜¾çš„â€œè‚˜éƒ¨â€ä½ç½®ï¼ˆå¯èƒ½æ˜¯å› ä¸ºæ•°æ®æœ¬èº«çš„åˆ†å¸ƒï¼‰ï¼Œé€‰æ‹© K=8 å¯èƒ½æ˜¯åŸºäºä½ çš„å…·ä½“éœ€æ±‚æˆ–å¯¹æ•°æ®çš„å…ˆéªŒç†è§£ã€‚</p>
</li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>èšç±»ä¾æ®</strong>ï¼š
é€‰æ‹©äº†ä¸‰ä¸ªç‰¹å¾ï¼š</p></li>
</ol>
<ul class="simple">
<li><p><strong>åˆ¸å‡ä¼˜æƒ ä»·æ ¼</strong>ï¼šè¡¨æ˜ä¼˜æƒ åˆ¸çš„å¹³å‡ä¼˜æƒ é‡‘é¢ã€‚å¦‚æœè¯¥å€¼è¾ƒé«˜ï¼Œå¯èƒ½è¡¨ç¤ºé«˜ä»·å€¼çš„ä¼˜æƒ åˆ¸ã€‚</p></li>
<li><p><strong>ä¼˜æƒ æ¯”ä¾‹</strong>ï¼šæè¿°äº†ä¼˜æƒ åˆ¸çš„ä¼˜æƒ åŠ›åº¦ã€‚é«˜çš„ä¼˜æƒ æ¯”ä¾‹æ„å‘³ç€è¯¥ä¼˜æƒ åˆ¸çš„æŠ˜æ‰£åŠ›åº¦å¤§ï¼Œå¯èƒ½æ›´å¸å¼•æ¶ˆè´¹è€…ã€‚</p></li>
<li><p><strong>æ—¥å‡ä½¿ç”¨æ¬¡æ•°</strong>ï¼šåæ˜ äº†è¯¥ä¼˜æƒ åˆ¸çš„ä½¿ç”¨é¢‘ç‡ã€‚é¢‘ç¹ä½¿ç”¨çš„ä¼˜æƒ åˆ¸å¯èƒ½å—åˆ°å¹¿æ³›çš„æ¥å—å’Œä½¿ç”¨ã€‚</p></li>
</ul>
<p>åŸºäºè¿™ä¸‰ä¸ªç‰¹å¾ï¼ŒKå‡å€¼ç®—æ³•å°†è¿™äº›ä¼˜æƒ åˆ¸åˆ†ä¸º 8 ç±»ï¼Œæ¯ä¸ªç±»çš„ä¼˜æƒ åˆ¸åœ¨ä¸Šè¿°ç‰¹å¾ä¸Šå…·æœ‰ç›¸ä¼¼æ€§ã€‚</p>
<ol class="arabic simple" start="3">
<li><p><strong>èšç±»é˜ˆå€¼çš„è§£é‡Š</strong>ï¼š
Kå‡å€¼èšç±»é€šè¿‡è®¡ç®—æ¯ä¸ªæ•°æ®ç‚¹ï¼ˆåœ¨è¿™é‡Œæ˜¯æ¯ç§ä¼˜æƒ åˆ¸ï¼‰çš„è·ç¦»ï¼Œå°è¯•å°†æ•°æ®ç‚¹åˆ†é…åˆ°ç¦»å…¶æ›´è¿‘çš„èšç±»ä¸­å¿ƒã€‚å› æ­¤ï¼Œæ¯ä¸ªèšç±»çš„å½¢æˆéƒ½æœ‰å…¶ç‰¹å®šçš„â€œé˜ˆå€¼â€ï¼š</p></li>
</ol>
<ul class="simple">
<li><p>æ¯ä¸€ç±»çš„ä¼˜æƒ åˆ¸åœ¨è¿™ä¸‰ä¸ªç‰¹å¾ä¸Šä¼šæœ‰ä¸€äº›é›†ä¸­è¶‹åŠ¿ã€‚ä¾‹å¦‚ï¼ŒæŸä¸€ç±»å¯èƒ½æœ‰è¾ƒé«˜çš„ä¼˜æƒ æ¯”ä¾‹å’Œè¾ƒä½çš„åˆ¸å‡ä¼˜æƒ ä»·æ ¼ï¼Œè¡¨ç¤ºè¿™ç±»ä¼˜æƒ åˆ¸çš„æŠ˜æ‰£åŠ›åº¦å¤§ï¼Œä½†å•å¼ åˆ¸çš„ä¼˜æƒ é‡‘é¢è¾ƒå°ï¼Œå¯èƒ½é¢‘ç¹ä½¿ç”¨ã€‚</p></li>
<li><p>å¦ä¸€ç±»å¯èƒ½æœ‰è¾ƒä½çš„ä¼˜æƒ æ¯”ä¾‹ï¼Œä½†åˆ¸å‡ä¼˜æƒ ä»·æ ¼è¾ƒé«˜ï¼Œä¸”ä½¿ç”¨é¢‘ç‡è¾ƒä½ï¼Œè¿™å¯èƒ½æ˜¯ä¸€äº›é«˜ä»·å€¼ä½†è¾ƒå°‘ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ã€‚</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>å¦‚ä½•ç†è§£æ¯ä¸ªèšç±»</strong>ï¼š
ä¸€æ—¦ä½ å¾—åˆ°äº†æ¯ä¸ªä¼˜æƒ åˆ¸çš„èšç±»æ ‡ç­¾ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥åˆ†ææ¯ä¸€ç±»ä¼˜æƒ åˆ¸çš„ç‰¹å¾ï¼š</p></li>
</ol>
<ul class="simple">
<li><p><strong>ç±»å†…ç‰¹å¾åˆ†æ</strong>ï¼šæ¯ä¸ªèšç±»å†…çš„ä¼˜æƒ åˆ¸ä¼šåœ¨â€œåˆ¸å‡ä¼˜æƒ ä»·æ ¼â€ã€â€œä¼˜æƒ æ¯”ä¾‹â€å’Œâ€œæ—¥å‡ä½¿ç”¨æ¬¡æ•°â€ä¸Šæœ‰ç›¸ä¼¼æ€§ã€‚å¯ä»¥é€šè¿‡èšç±»åçš„å‡å€¼ã€æ ‡å‡†å·®ç­‰ç»Ÿè®¡é‡æ¥åˆ†ææ¯ä¸€ç±»çš„å…¸å‹ç‰¹å¾ã€‚</p></li>
<li><p><strong>å¯è§†åŒ–</strong>ï¼šé€šè¿‡æ•£ç‚¹å›¾ï¼Œä½ å¯ä»¥å°†ä¸åŒèšç±»ç”¨ä¸åŒé¢œè‰²æ ‡ç¤ºå‡ºæ¥ï¼Œä»è€Œç›´è§‚åœ°çœ‹åˆ°ä¸åŒç±»å‹ä¼˜æƒ åˆ¸åœ¨è¿™ä¸‰ä¸ªç‰¹å¾ç©ºé—´ä¸­çš„åˆ†å¸ƒã€‚</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p><strong>è¿›ä¸€æ­¥åˆ†æå’Œå†³ç­–</strong>ï¼š</p></li>
</ol>
<ul class="simple">
<li><p>ä½ å¯ä»¥æ ¹æ®èšç±»æ ‡ç­¾ï¼Œå¯¹ä¸åŒç±»å‹çš„ä¼˜æƒ åˆ¸è¿›è¡Œä¸åŒçš„ç­–ç•¥ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li><p><strong>é«˜ä¼˜æƒ æ¯”ä¾‹ï¼Œé«˜ä½¿ç”¨é¢‘ç‡</strong>ï¼šè¿™ç§ä¼˜æƒ åˆ¸ç±»å‹å¯èƒ½é€‚åˆåœ¨ä¿ƒé”€æ´»åŠ¨ä¸­å¹¿æ³›å‘æ”¾ï¼Œå› ä¸ºå®ƒä»¬çš„ä½¿ç”¨é¢‘ç‡è¾ƒé«˜ï¼Œä¸”ä¼˜æƒ åŠ›åº¦å¤§ï¼Œå¯èƒ½å¸¦æ¥è¾ƒé«˜çš„å¸å¼•åŠ›ã€‚</p></li>
<li><p><strong>é«˜åˆ¸å‡ä¼˜æƒ ä»·æ ¼ï¼Œä½ä½¿ç”¨é¢‘ç‡</strong>ï¼šè¿™ç§ä¼˜æƒ åˆ¸å¯èƒ½é€‚åˆé’ˆå¯¹ç‰¹å®šç›®æ ‡ç¾¤ä½“ï¼ˆå¦‚é«˜ä»·å€¼å®¢æˆ·ï¼‰ä½¿ç”¨ã€‚</p></li>
</ul>
</li>
</ul>
<p>é€šè¿‡è¿™äº›åˆ†æï¼Œä½ å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–è¥é”€ç­–ç•¥ï¼Œå¹¶æ ¹æ®ä¸åŒç±»åˆ«çš„ä¼˜æƒ åˆ¸åˆ¶å®šä¸ªæ€§åŒ–çš„è¥é”€æ´»åŠ¨ã€‚</p>
<ol class="arabic simple" start="6">
<li><p><strong>æ€»ç»“</strong>ï¼š</p></li>
</ol>
<ul class="simple">
<li><p>é€šè¿‡ Kå‡å€¼èšç±»ï¼Œä½ å·²ç»å°†ä¼˜æƒ åˆ¸ç±»å‹æ ¹æ®å…¶ä¼˜æƒ ä»·æ ¼ã€ä¼˜æƒ æ¯”ä¾‹å’Œæ—¥å‡ä½¿ç”¨æ¬¡æ•°è¿›è¡Œäº†åˆ†ç±»ã€‚</p></li>
<li><p>æ¯ä¸ªèšç±»çš„é˜ˆå€¼æ˜¯åŸºäºå®ƒä»¬åœ¨è¿™äº›ç‰¹å¾ä¸Šçš„é›†ä¸­ç¨‹åº¦è€Œç¡®å®šçš„ï¼Œå³ç›¸ä¼¼çš„ä¼˜æƒ åˆ¸ä¼šè¢«åˆ’åˆ†åˆ°åŒä¸€ç±»ã€‚</p></li>
<li><p>èšç±»ç»“æœçš„å¯è§†åŒ–å¸®åŠ©ä½ æ›´æ¸…æ™°åœ°ç†è§£æ¯ä¸ªç±»åˆ«çš„ç‰¹å¾ï¼Œä»è€Œä¸ºè¥é”€å†³ç­–æä¾›æ”¯æŒã€‚</p></li>
</ul>
</section>
<section id="id15">
<h3>é€‰æ‹©2 é˜ˆå€¼åˆ†ç±»<a class="headerlink" href="#id15" title="Link to this heading">#</a></h3>
<section id="id16">
<h4>åˆ†ç±»ä¾æ®(å›¾)<a class="headerlink" href="#id16" title="Link to this heading">#</a></h4>
<p><strong>ä¼˜æƒ åˆ¸åˆ†ç±»ä¾æ®ï¼šå°äº25åˆ†ä½ä»£è¡¨ä½ä¼˜æƒ ï¼Œå¤§äº25åˆ†ä½ä»£è¡¨é«˜ä¼˜æƒ ï¼Œå…¶ä½™æ˜¯ä¸­ä¼˜æƒ </strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ•°æ®</span>
<span class="n">coupon_price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.548235</span><span class="p">,</span> <span class="mf">9.018556</span><span class="p">,</span> <span class="mf">8.927634</span><span class="p">,</span> <span class="mf">1.846800</span><span class="p">,</span> <span class="mf">4.858081</span><span class="p">,</span> <span class="mf">2.624068</span><span class="p">,</span> <span class="mf">8.189355</span><span class="p">,</span> <span class="mf">3.557143</span><span class="p">,</span> <span class="mf">7.060215</span><span class="p">,</span> <span class="mf">3.017243</span><span class="p">,</span>
                         <span class="mf">3.861469</span><span class="p">,</span> <span class="mf">2.305097</span><span class="p">,</span> <span class="mf">0.245421</span><span class="p">,</span> <span class="mf">6.548390</span><span class="p">,</span> <span class="mf">0.059548</span><span class="p">,</span> <span class="mf">14.618420</span><span class="p">])</span>
<span class="n">discount_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.507586</span><span class="p">,</span> <span class="mf">6.807134</span><span class="p">,</span> <span class="mf">19.207342</span><span class="p">,</span> <span class="mf">0.967979</span><span class="p">,</span> <span class="mf">98.996517</span><span class="p">,</span> <span class="mf">1.067113</span><span class="p">,</span> <span class="mf">14.935559</span><span class="p">,</span> <span class="mf">4.660565</span><span class="p">,</span> <span class="mf">5.294371</span><span class="p">,</span> <span class="mf">9.097849</span><span class="p">,</span>
                           <span class="mf">6.887507</span><span class="p">,</span> <span class="mf">6.762217</span><span class="p">,</span> <span class="mf">0.536493</span><span class="p">,</span> <span class="mf">7.492750</span><span class="p">,</span> <span class="mf">0.139007</span><span class="p">,</span> <span class="mf">10.729673</span><span class="p">])</span>

<span class="c1"># åˆ›å»ºå­å›¾</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># ================== åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†å¸ƒ ==================</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†å¸ƒï¼ˆä½/ä¸­/é«˜ä¼˜æƒ åŒºé—´ï¼‰&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;é¢‘æ•°&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># è®¡ç®—å››åˆ†ä½æ•°</span>
<span class="n">q1_cp</span><span class="p">,</span> <span class="n">median_cp</span><span class="p">,</span> <span class="n">q3_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
<span class="n">min_cp</span><span class="p">,</span> <span class="n">max_cp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">)</span>

<span class="c1"># å¡«å……ä¸åŒä¼˜æƒ åŒºé—´</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">min_cp</span><span class="p">,</span> <span class="n">q1_cp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ä½ä¼˜æƒ  (&lt;Q1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q1_cp</span><span class="p">,</span> <span class="n">q3_cp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightyellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ä¸­ä¼˜æƒ  (Q1-Q3)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q3_cp</span><span class="p">,</span> <span class="n">max_cp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;é«˜ä¼˜æƒ  (&gt;Q3)&#39;</span><span class="p">)</span>

<span class="c1"># æ·»åŠ å››åˆ†ä½çº¿</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">q1_cp</span><span class="p">,</span> <span class="n">median_cp</span><span class="p">,</span> <span class="n">q3_cp</span><span class="p">],</span> 
                            <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># ================== ä¼˜æƒ æ¯”ä¾‹åˆ†å¸ƒ ==================</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;seagreen&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹åˆ†å¸ƒï¼ˆä½/ä¸­/é«˜ä¼˜æƒ åŒºé—´ï¼‰&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹ (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;é¢‘æ•°&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># è®¡ç®—å››åˆ†ä½æ•°</span>
<span class="n">q1_dr</span><span class="p">,</span> <span class="n">median_dr</span><span class="p">,</span> <span class="n">q3_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
<span class="n">min_dr</span><span class="p">,</span> <span class="n">max_dr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">)</span>

<span class="c1"># å¡«å……ä¸åŒä¼˜æƒ åŒºé—´</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">min_dr</span><span class="p">,</span> <span class="n">q1_dr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ä½ä¼˜æƒ  (&lt;Q1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q1_dr</span><span class="p">,</span> <span class="n">q3_dr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightyellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ä¸­ä¼˜æƒ  (Q1-Q3)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q3_dr</span><span class="p">,</span> <span class="n">max_dr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;é«˜ä¼˜æƒ  (&gt;Q3)&#39;</span><span class="p">)</span>

<span class="c1"># æ·»åŠ å››åˆ†ä½çº¿</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">q1_dr</span><span class="p">,</span> <span class="n">median_dr</span><span class="p">,</span> <span class="n">q3_dr</span><span class="p">],</span> 
                            <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># ä¼˜åŒ–å›¾è¡¨å¸ƒå±€</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dc8a03ecf3dfbd577f21c20f09b9f933ceb80352e5bd37f293e06645e9e709bc.png" src="_images/dc8a03ecf3dfbd577f21c20f09b9f933ceb80352e5bd37f293e06645e9e709bc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»ºç¤ºä¾‹æ•°æ®</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Coupon_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">20013.0</span><span class="p">,</span> <span class="mf">20011.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">10015.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">20014.0</span><span class="p">,</span> <span class="mf">10010.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">10012.0</span><span class="p">],</span>
    <span class="s2">&quot;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.548235</span><span class="p">,</span> <span class="mf">9.018556</span><span class="p">,</span> <span class="mf">8.927634</span><span class="p">,</span> <span class="mf">1.846800</span><span class="p">,</span> <span class="mf">4.858081</span><span class="p">,</span> <span class="mf">2.624068</span><span class="p">,</span> <span class="mf">8.189355</span><span class="p">,</span> <span class="mf">3.557143</span><span class="p">,</span> <span class="mf">7.060215</span><span class="p">,</span> <span class="mf">3.017243</span><span class="p">,</span> <span class="mf">3.861469</span><span class="p">,</span> <span class="mf">2.305097</span><span class="p">,</span> <span class="mf">0.245421</span><span class="p">,</span> <span class="mf">6.548390</span><span class="p">,</span> <span class="mf">0.059548</span><span class="p">,</span> <span class="mf">14.618420</span><span class="p">],</span>
    <span class="s2">&quot;ä¼˜æƒ æ¯”ä¾‹&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.507586</span><span class="p">,</span> <span class="mf">6.807134</span><span class="p">,</span> <span class="mf">19.207342</span><span class="p">,</span> <span class="mf">0.967979</span><span class="p">,</span> <span class="mf">98.996517</span><span class="p">,</span> <span class="mf">1.067113</span><span class="p">,</span> <span class="mf">14.935559</span><span class="p">,</span> <span class="mf">4.660565</span><span class="p">,</span> <span class="mf">5.294371</span><span class="p">,</span> <span class="mf">9.097849</span><span class="p">,</span> <span class="mf">6.887507</span><span class="p">,</span> <span class="mf">6.762217</span><span class="p">,</span> <span class="mf">0.536493</span><span class="p">,</span> <span class="mf">7.492750</span><span class="p">,</span> <span class="mf">0.139007</span><span class="p">,</span> <span class="mf">10.729673</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># åˆ›å»º DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># æŒ‰åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†ç±»</span>
<span class="k">def</span><span class="w"> </span><span class="nf">categorize_by_coupon_price</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">7.34</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;é«˜ä»·ä¼˜æƒ åˆ¸&#39;</span>
    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2.49</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;ä½ä»·ä¼˜æƒ åˆ¸&#39;</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span>
    
<span class="c1"># æŒ‰ä¼˜æƒ æ¯”ä¾‹åˆ†ç±»</span>
<span class="k">def</span><span class="w"> </span><span class="nf">categorize_by_discount_ratio</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">9.51</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;é«˜æ¯”ä¾‹ä¼˜æƒ &#39;</span>
    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">3.76</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ &#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ &#39;</span>



<span class="c1"># åˆ›å»ºåˆ†ç±»åˆ—</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹åˆ†ç±»&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">categorize_by_discount_ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†ç±»&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">categorize_by_coupon_price</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># è¾“å‡ºåˆ†ç±»åçš„æ•°æ®</span>
<span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">,</span> <span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">,</span> <span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹åˆ†ç±»&#39;</span><span class="p">,</span> <span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†ç±»&#39;</span><span class="p">]]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹åˆ†ç±»&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼åˆ†ç±»&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;å•†å“å¹³å‡ä»·æ ¼&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;åˆ¸å‡ä¼˜æƒ ä»·æ ¼&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ æ¯”ä¾‹&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># order_detail = pd.merge(order_detail, df[[&#39;Coupon_type&#39;, &#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;]], on=&#39;Coupon_type&#39;, how=&#39;left&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">order_detail</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">matplotlib_fname</span><span class="p">())</span>  <span class="c1"># æ˜¾ç¤º Matplotlib é…ç½®æ–‡ä»¶è·¯å¾„</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">())</span> 

<span class="o">!</span>cp<span class="w"> </span>/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/SimHei.ttf<span class="w"> </span>/Users/liangkaixin/Documents/Notes/å•†ä¸šåˆ†æ/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf

<span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
        

<span class="c1"># **1. æŒ‡å®šå­—ä½“æ–‡ä»¶è·¯å¾„**ï¼ˆä¿®æ”¹ä¸ºä½ çš„å®é™…è·¯å¾„ï¼‰</span>
<span class="n">font_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/liangkaixin/Documents/ä¼˜æƒ åˆ¸æŠ•æ”¾ææ•ˆåˆ†æ/SimHei.ttf&quot;</span>  <span class="c1"># ä¾‹å¦‚æ”¾åœ¨é¡¹ç›®çš„ fonts ç›®å½•ä¸‹</span>

<span class="c1"># **2. åŠ è½½å­—ä½“**</span>
<span class="n">my_font</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">font_path</span><span class="p">)</span>

<span class="c1"># **3. è®¾ç½® Matplotlib ä½¿ç”¨è¯¥å­—ä½“**</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_font</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.unicode_minus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è§£å†³è´Ÿå· &#39;-&#39; æ˜¾ç¤ºé—®é¢˜</span>

<span class="c1"># æŒ‡å®šä¸€ä¸ªæ”¯æŒä¸­æ–‡çš„å­—ä½“ (å¦‚ SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># æˆ– &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/liangkaixin/Documents/Notes/å•†ä¸šåˆ†æ/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/matplotlibrc
/Users/liangkaixin/.matplotlib
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="id17">
<h2>å®é™…ä¼˜æƒ é‡‘é¢ä¸å®ä»˜é‡‘é¢å¯¹æ¯”<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è®¾ç½®ç”»å¸ƒå¤§å°</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># æŒ‡å®šä¸€ä¸ªæ”¯æŒä¸­æ–‡çš„å­—ä½“ (å¦‚ SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># æˆ– &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜</span>

<span class="c1"># ç›´æ–¹å›¾ 1: å®é™…ä¼˜æƒ é‡‘é¢</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;å®é™…ä¼˜æƒ é‡‘é¢åˆ†å¸ƒ&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;å®é™…ä¼˜æƒ é‡‘é¢å–å¯¹æ•°&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;é¢‘æ¬¡&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># ç›´æ–¹å›¾ 2: å®ä»˜é‡‘é¢</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32CD32&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;å®ä»˜é‡‘é¢åˆ†å¸ƒ&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;å®ä»˜é‡‘é¢å–å¯¹æ•°&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;é¢‘æ¬¡&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># è°ƒæ•´å¸ƒå±€</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># æ˜¾ç¤ºå›¾å½¢</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/37f57dae203093db50a2aea96c18b4a6aa52e68f075ad9b71daed14750babc17.png" src="_images/37f57dae203093db50a2aea96c18b4a6aa52e68f075ad9b71daed14750babc17.png" />
</div>
</div>
</section>
<section id="id18">
<h2>è¶‹åŠ¿åˆ†æ<a class="headerlink" href="#id18" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assume data is already loaded into order_detail, user_visit_detail, and user_coupon_receive</span>

<span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">])</span>
<span class="c1"># Calculate total daily payment and reduce amount</span>
<span class="n">daily_payment</span> <span class="o">=</span> <span class="n">order_detail</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">,</span> <span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># Calculate daily active users (unique user count per day)</span>
<span class="n">user_visit_detail</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">])</span>
<span class="n">daily_active_users</span> <span class="o">=</span> <span class="n">user_visit_detail</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[</span><span class="s1">&#39;User_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">daily_active_users</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Active_users&#39;</span><span class="p">]</span>

<span class="c1"># Assuming user_coupon_receive already contains &#39;Receive_date&#39;</span>
<span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">])</span>

<span class="c1"># Calculate daily coupon receipt count</span>
<span class="n">daily_coupon_received</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[</span><span class="s1">&#39;Coupon_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">daily_coupon_received</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_received_count&#39;</span><span class="p">]</span>


<span class="c1"># åˆ›å»ºç”»å¸ƒï¼Œåˆ†ä¸º 2 è¡Œ 2 åˆ—</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ç”¨æˆ·æ€»æ¶ˆè´¹é‡‘é¢è¶‹åŠ¿</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ç”¨æˆ·æ€»æ¶ˆè´¹é‡‘é¢è¶‹åŠ¿&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;é‡‘é¢&quot;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ä¼˜æƒ é‡‘é¢è¶‹åŠ¿</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ é‡‘é¢è¶‹åŠ¿&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;é‡‘é¢&quot;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶æ¯æ—¥æ´»è·ƒç”¨æˆ·æ•°è¶‹åŠ¿</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_active_users</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_active_users</span><span class="p">[</span><span class="s1">&#39;Active_users&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;æ¯æ—¥æ´»è·ƒç”¨æˆ·æ•°&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;æ—¥æœŸ&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ç”¨æˆ·æ•°&quot;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶æ¯æ—¥é¢†å–ä¼˜æƒ åˆ¸æ•°é‡è¶‹åŠ¿</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_coupon_received</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_coupon_received</span><span class="p">[</span><span class="s1">&#39;Coupon_received_count&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;æ¯æ—¥é¢†å–ä¼˜æƒ åˆ¸æ•°é‡&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;æ—¥æœŸ&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;æ•°é‡&quot;</span><span class="p">)</span>

<span class="c1"># è°ƒæ•´å¸ƒå±€ï¼Œé˜²æ­¢æ ‡ç­¾é‡å </span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d5a84c55ae992905b5545999814b5e05c07176240376b0348be3c8e1850b696f.png" src="_images/d5a84c55ae992905b5545999814b5e05c07176240376b0348be3c8e1850b696f.png" />
</div>
</div>
</section>
<section id="id19">
<h2>äººå‡ä½¿ç”¨ä¼˜æƒ åˆ¸æ¬¡æ•°<a class="headerlink" href="#id19" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># å…ˆå°†æ—¥æœŸåˆ—è½¬æ¢ä¸ºæ—¥æœŸç±»å‹</span>
<span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">])</span>

<span class="c1"># è®¡ç®—æ¯ä¸ªç”¨æˆ·ä½¿ç”¨ä¼˜æƒ åˆ¸çš„æ¬¡æ•°</span>
<span class="n">user_coupon_count</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;User_id&#39;</span><span class="p">)[</span><span class="s1">&#39;Coupon_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">user_coupon_count</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_count&#39;</span><span class="p">]</span>

<span class="c1"># è®¡ç®—äººå‡ä½¿ç”¨ä¼˜æƒ åˆ¸æ¬¡æ•°</span>
<span class="n">average_coupon_usage</span> <span class="o">=</span> <span class="n">user_coupon_count</span><span class="p">[</span><span class="s1">&#39;Coupon_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;äººå‡ä½¿ç”¨ä¼˜æƒ åˆ¸æ¬¡æ•°: </span><span class="si">{</span><span class="n">average_coupon_usage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># åˆ›å»ºç”»å¸ƒ</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># ç»˜åˆ¶ç›´æ–¹å›¾ï¼ˆæŸ±çŠ¶å›¾ï¼‰</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">user_coupon_count</span><span class="p">[</span><span class="s1">&#39;Coupon_count&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># è®¾ç½®æ ‡é¢˜å’Œåæ ‡è½´æ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ç”¨æˆ·ä¼˜æƒ åˆ¸ä½¿ç”¨æ¬¡æ•°åˆ†å¸ƒ&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;ä¼˜æƒ åˆ¸ä½¿ç”¨æ¬¡æ•°&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ç”¨æˆ·æ•°é‡&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>  <span class="c1"># è®¾ç½® y è½´ä¸ºå¯¹æ•°åˆ»åº¦</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># æ—‹è½¬ x è½´æ ‡ç­¾é˜²æ­¢é‡å </span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>äººå‡ä½¿ç”¨ä¼˜æƒ åˆ¸æ¬¡æ•°: 44.70
</pre></div>
</div>
<img alt="_images/105d65337e84d3fa9c041ba4f5eebc8ba15d7b09a4848e9fe35404e42a9883d3.png" src="_images/105d65337e84d3fa9c041ba4f5eebc8ba15d7b09a4848e9fe35404e42a9883d3.png" />
</div>
</div>
</section>
<section id="id20">
<h2>é¢†åˆ¸æ€»æ•°åˆ†å¸ƒ<a class="headerlink" href="#id20" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    select count(*) as é¢†åˆ¸æ€»æ•°,User_id AS ç”¨æˆ·ID, Receive_date from user_coupon_receive</span>
<span class="s2">           WHERE Coupon_id IS NOT NULL AND Receive_date IS NOT NULL</span>
<span class="s2">           group by 2, 3</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
<span class="c1"># è®¡ç®—æ¯ä¸ªå€¼çš„é¢‘æ¬¡åŠå…¶å æ¯”</span>
<span class="n">value_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;é¢†åˆ¸æ€»æ•°&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># å°†ç»“æœè½¬æ¢ä¸º DataFrameï¼Œå±•ç¤ºé¢‘æ¬¡å’Œå æ¯”</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;é¢†åˆ¸æ€»æ•°&#39;</span><span class="p">:</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="s1">&#39;äººæ•°&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;é¢†åˆ¸æ€»æ•°&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span>
    <span class="s1">&#39;å æ¯”(%)&#39;</span><span class="p">:</span> <span class="n">value_counts</span><span class="o">*</span><span class="mi">100</span>
<span class="p">})</span>
<span class="c1"># æ˜¾ç¤ºç»“æœ</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;å æ¯”(%)&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="n">custom_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffab00&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff6b00&#39;</span><span class="p">]</span>

<span class="c1"># åˆ›å»ºä¸€ä¸ª &#39;å æ¯”(%)&#39; å°äºæŸä¸ªé˜ˆå€¼çš„å¸ƒå°”æ ‡å¿—</span>
<span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;explode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;å æ¯”(%)&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span>

<span class="c1"># ä½¿ç”¨ plotly åˆ›å»ºäº¤äº’å¼é¥¼å›¾</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
    <span class="n">result_df</span><span class="p">,</span>
    <span class="n">values</span><span class="o">=</span><span class="s1">&#39;å æ¯”(%)&#39;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="s1">&#39;é¢†åˆ¸æ€»æ•°&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;é¢†åˆ¸æ€»æ•°åˆ†å¸ƒçš„é¥¼å›¾&#39;</span><span class="p">,</span>
    <span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">custom_colors</span><span class="p">,</span>
    <span class="n">hole</span><span class="o">=</span><span class="mf">0.3</span>  <span class="c1"># å¦‚æœä½ æƒ³åˆ¶ä½œç”œç”œåœˆå›¾</span>
<span class="p">)</span>

<span class="c1"># æ·»åŠ çˆ†å¼€æ•ˆæœï¼Œä½¿ç”¨é¥¼å›¾è§’åº¦ç»†å¾®è°ƒæ•´å¤§çš„å°çˆ†å¼€æ•ˆæœ</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
    <span class="n">pull</span><span class="o">=</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;explode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id21">
<h1>æ¼æ–—æ¨¡å‹<a class="headerlink" href="#id21" title="Link to this heading">#</a></h1>
<section id="id22">
<h2>åˆ†æç›®çš„<a class="headerlink" href="#id22" title="Link to this heading">#</a></h2>
<p>ä½¿ç”¨<strong>æ¼æ–—æ¨¡å‹</strong>å¯¹ç”¨æˆ·è¿›è¡Œåˆ†æï¼Œå¯¹å„ç¯èŠ‚ç”¨æˆ·è½¬åŒ–ç‡çš„æƒ…å†µè¿›è¡Œæ”¶é›†å¯¹æ¯”ï¼Œ</p>
<p>ä»ä¸­å‘ç°é—®é¢˜å¹¶å¯¹é—®é¢˜å‘ç”Ÿçš„åŸå› è¿›è¡Œåˆ†æï¼Œç„¶åå°è¯•ç»™å‡ºä¸šåŠ¡å»ºè®®ã€‚</p>
<p>ç»§è€Œåˆ©ç”¨<strong>RFMæ¨¡å‹</strong>è¿›è¡Œç”¨æˆ·ä»·å€¼åˆ†æï¼ŒåŠ›å›¾å¯¹ç”¨æˆ·è¿›è¡Œæ›´é«˜æ•ˆçš„ç²¾ç»†åŒ–è¿è¥ï¼Œä¿ƒè¿›ä¼˜æƒ åˆ¸æ ¸é”€ä»¥åŠé”€å”®å¢é•¿ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- æ‰€æœ‰ç”¨æˆ·</span>
<span class="s2">with t1 as </span>
<span class="s2">(</span>
<span class="s2">    select</span>
<span class="s2">         count(distinct User_id) as all_users</span>
<span class="s2">     from </span>
<span class="s2">     (</span>
<span class="s2">      select User_id from order_detail</span>
<span class="s2">      union all</span>
<span class="s2">      select User_id from user_visit_detail</span>
<span class="s2">      union all</span>
<span class="s2">      select User_id from user_coupon_receive</span>
<span class="s2">     )</span>
<span class="s2">),</span>
<span class="s2">-- é¢†åˆ¸ç”¨æˆ·</span>
<span class="s2">t2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as getcoupons_users</span>
<span class="s2">from user_coupon_receive</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">),</span>
<span class="s2">-- é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·</span>
<span class="s2">a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    min(Pay_date) as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">group by User_id),</span>
<span class="s2">-- ç”¨åˆ¸åå¤è´­ç”¨æˆ·</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as second_user</span>
<span class="s2">from a1</span>
<span class="s2">inner join </span>
<span class="s2">(</span>
<span class="s2">    select * from order_detail</span>
<span class="s2">    where Coupon_id is not null</span>
<span class="s2">) as order_detail</span>
<span class="s2">using(User_id)</span>
<span class="s2">where order_detail.Pay_date	&gt;first_date</span>
<span class="s2">)</span>

<span class="s2">select</span>
<span class="s2">    (select all_users from t1) as æ‰€æœ‰ç”¨æˆ·æ•°,</span>
<span class="s2">    (select getcoupons_users from t2) as é¢†åˆ¸ç”¨æˆ·æ•°,</span>
<span class="s2">    (select count(distinct User_id) from a1) as é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·æ•°,</span>
<span class="s2">    (select second_user from a2) as ç”¨åˆ¸åå¤è´­ç”¨æˆ·æ•°</span>
<span class="s2">--where Date_received is not null and Date is not null;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆé‡å‘½ååˆ—ï¼‰</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stage</th>
      <th>number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>æ‰€æœ‰ç”¨æˆ·æ•°</td>
      <td>49965</td>
    </tr>
    <tr>
      <th>1</th>
      <td>é¢†åˆ¸ç”¨æˆ·æ•°</td>
      <td>48760</td>
    </tr>
    <tr>
      <th>2</th>
      <td>é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·æ•°</td>
      <td>34821</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ç”¨åˆ¸åå¤è´­ç”¨æˆ·æ•°</td>
      <td>25924</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id23">
<h2>ç”¨æˆ·è½¬åŒ–åˆ†æ<a class="headerlink" href="#id23" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è®¡ç®—ç›¸å¯¹åˆå§‹å€¼çš„ç™¾åˆ†æ¯”</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;percent_initial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># åˆ›å»ºæ¼æ–—å›¾</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Funnel</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">],</span>  
    <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">],</span>  
    <span class="n">textinfo</span><span class="o">=</span><span class="s2">&quot;value+percent initial&quot;</span><span class="p">,</span>  <span class="c1"># æ˜¾ç¤ºæ•°å€¼ + ç›¸å¯¹åˆå§‹å€¼çš„ç™¾åˆ†æ¯”</span>
    <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;inside&quot;</span><span class="p">,</span>  <span class="c1"># æ–‡æœ¬å±…ä¸­</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="p">{</span>        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffab00&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8000&#39;</span><span class="p">],</span>  <span class="c1"># ä½¿ç”¨è‡ªå®šä¹‰çš„è‰²å·</span>
        <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># æ¯ä¸ªéƒ¨åˆ†çš„è¾¹æ¡†å®½åº¦</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;wheat&#39;</span><span class="p">]</span>  <span class="c1"># è¾¹æ¡†é¢œè‰²</span>
        <span class="p">}</span>
        
        <span class="p">},</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span>  <span class="c1"># é€æ˜åº¦</span>
    <span class="n">connector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># è¿æ¥çº¿æ ·å¼</span>
    <span class="p">)</span>
<span class="p">))</span>

<span class="c1"># è®¾ç½®æ ‡é¢˜å’Œæ•´ä½“æ ·å¼</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;ğŸ“Š ç”¨æˆ·è½¬åŒ–æ¼æ–—å›¾&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkblue&quot;</span><span class="p">)),</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># èƒŒæ™¯è‰²</span>
    <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">),</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># è°ƒæ•´è¾¹è·</span>
<span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>ä»ä¸Šè¿°æ¼æ–—æ¨¡å‹ä¸­æˆ‘ä¸»è¦å‘ç°ä¸‰ä¸ªç°è±¡ï¼š</p>
<p>ç¬¬ä¸€ï¼šç”¨æˆ·é¢†åˆ¸è½¬åŒ–ç‡çº¦ä¸º98%ï¼Œæ•°æ®è¡¨ç°éå¸¸å¥½</p>
<p>ç¬¬äºŒï¼šç”¨æˆ·æ ¸é”€è½¬åŒ–ç‡ä¸º70%ï¼Œæ•ˆæœæ¯”è¾ƒç†æƒ³</p>
<p>ç¬¬ä¸‰ï¼šç”¨æˆ·é¢†åˆ¸åå¤è´­è½¬åŒ–ç‡ä¸º52%ï¼Œè¿˜æœ‰æå‡ç©ºé—´</p>
</section>
<section id="id24">
<h2>ç”¨æˆ·å¤è´­è½¬åŒ–ç‡åˆ†æ<a class="headerlink" href="#id24" title="Link to this heading">#</a></h2>
<p>å¯¹äºç¬¬ä¸‰ä¸ªç°è±¡ï¼Œç”¨åˆ¸æ ¸é”€ç”¨æˆ·å¤è´­è½¬åŒ–ç‡è¾¾åˆ°52%ï¼Œè¯¥éƒ¨åˆ†æ˜¯<strong>ç”¨æˆ·ç•™å­˜</strong>çš„é‡è¦ç¯èŠ‚</p>
<p>ä¸ºäº†ä½“ç°ä¼˜æƒ åˆ¸å¯¹ç”¨æˆ·å¤è´­çš„å½±å“ï¼Œç»Ÿè®¡æœªé¢†åˆ¸æ ¸é”€ä¼˜æƒ åˆ¸çš„ç”¨æˆ·ï¼š</p>
<p>åœ¨è¯¥éƒ¨åˆ†ç”¨æˆ·ä¸­ä»…æœ‰çº¦31%çš„ç”¨æˆ·ä¼šå¤è´­ï¼Œå› æ­¤ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è¯´æ˜ä¼˜æƒ åˆ¸å¯¹ç”¨æˆ·å¤è´­çš„ä¿ƒè¿›ä½œç”¨</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- ç”¨åˆ¸æ ¸é”€ç”¨æˆ·</span>
<span class="s2">with a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    Pay_date::Date as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">where Coupon_id is not null and Pay_date is not null</span>
<span class="s2">),</span>
<span class="s2">-- ç”¨åˆ¸åå¤è´­ç”¨æˆ·</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    first_date,</span>
<span class="s2">    min(Pay_date),</span>
<span class="s2">    min(datediff(&#39;day&#39;, first_date::Date, Pay_date::Date)) as inter</span>
<span class="s2">from a1</span>
<span class="s2">inner join order_detail using(User_id)</span>
<span class="s2">where order_detail.Pay_date::Date&gt;first_date::Date</span>
<span class="s2">group by User_id, first_date),</span>
<span class="s2">a3 as(</span>
<span class="s2">select </span>
<span class="s2">	inter,</span>
<span class="s2">	count(*) as r</span>
<span class="s2">from a2</span>
<span class="s2">group by inter)</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select </span>
<span class="s2">	inter as &#39;å¤è´­å‘¨æœŸ&#39;,</span>
<span class="s2">	r as &#39;å¤è´­ç”¨æˆ·æ•°&#39;,</span>
<span class="s2">  sum(r/(select sum(r) from a3)) over(order by inter) as &#39;åˆè®¡ç™¾åˆ†æ¯”&#39;</span>
<span class="s2">from a3&quot;&quot;&quot;</span>

<span class="n">avg_rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select avg(inter) as &#39;å¹³å‡å¤è´­å‘¨æœŸ&#39;</span>
<span class="s2">from a2</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">avg_rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>å¹³å‡å¤è´­å‘¨æœŸ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.2528839763</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>å¤è´­å‘¨æœŸ</th>
      <th>å¤è´­ç”¨æˆ·æ•°</th>
      <th>åˆè®¡ç™¾åˆ†æ¯”</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>188198</td>
      <td>0.4283808761</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>70697</td>
      <td>0.5893031111</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>39880</td>
      <td>0.6800789395</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>26304</td>
      <td>0.7399527456</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>18296</td>
      <td>0.7815985469</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>14738</td>
      <td>0.8151455418</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>11935</td>
      <td>0.8423122798</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>8208</td>
      <td>0.8609955295</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9</td>
      <td>6251</td>
      <td>0.8752242081</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>5339</td>
      <td>0.8873769701</td>
    </tr>
    <tr>
      <th>10</th>
      <td>11</td>
      <td>4557</td>
      <td>0.8977497246</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>4019</td>
      <td>0.9068978704</td>
    </tr>
    <tr>
      <th>12</th>
      <td>13</td>
      <td>3646</td>
      <td>0.9151969845</td>
    </tr>
    <tr>
      <th>13</th>
      <td>14</td>
      <td>3386</td>
      <td>0.9229042802</td>
    </tr>
    <tr>
      <th>14</th>
      <td>15</td>
      <td>2592</td>
      <td>0.9288042538</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16</td>
      <td>2195</td>
      <td>0.9338005663</td>
    </tr>
    <tr>
      <th>16</th>
      <td>17</td>
      <td>1921</td>
      <td>0.9381731934</td>
    </tr>
    <tr>
      <th>17</th>
      <td>18</td>
      <td>1765</td>
      <td>0.9421907294</td>
    </tr>
    <tr>
      <th>18</th>
      <td>19</td>
      <td>1562</td>
      <td>0.9457461919</td>
    </tr>
    <tr>
      <th>19</th>
      <td>20</td>
      <td>1588</td>
      <td>0.9493608362</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>çŸ­å¤è´­å‘¨æœŸï¼ˆè¾ƒçŸ­çš„å¤è´­é—´éš”ï¼‰
ä¼˜ç‚¹ï¼š</p>
<p>é«˜æ´»è·ƒåº¦ï¼šå®¢æˆ·é¢‘ç¹è´­ä¹°ï¼Œè¯´æ˜ä»–ä»¬å¯¹ä½ çš„äº§å“æˆ–æœåŠ¡æœ‰è¾ƒå¼ºçš„éœ€æ±‚æˆ–å–œå¥½ã€‚</p>
<p>ç°é‡‘æµè¾ƒå¥½ï¼šçŸ­æœŸå†…çš„é¢‘ç¹è´­ä¹°æœ‰åŠ©äºä¿æŒç¨³å®šçš„æ”¶å…¥æµã€‚</p>
<p>å®¢æˆ·ç²˜æ€§å¼ºï¼šè¯´åå®¢æˆ·æ„¿æ„é¢‘ç¹è´­ä¹°</p>
<p>ç¼ºç‚¹ï¼š</p>
<p>ç–²åŠ³æ•ˆåº”ï¼šè¿‡äºé¢‘ç¹çš„è´­ä¹°å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…æ„Ÿåˆ°ç–²åŠ³æˆ–åŒå€¦ï¼Œå°¤å…¶æ˜¯äº§å“æˆ–æœåŠ¡ä¸é€‚åˆé•¿æœŸä½¿ç”¨ã€‚</p>
<p>å¸‚åœºç«äº‰æ¿€çƒˆï¼šçŸ­å‘¨æœŸå¤è´­å¯èƒ½è¯´æ˜ä½ çš„ç«äº‰å¯¹æ‰‹åœ¨ä¸æ–­åˆºæ¿€å®¢æˆ·ï¼Œä¿ƒé”€æ´»åŠ¨é¢‘ç¹ï¼Œè¿™å¯èƒ½åæ˜ å‡ºå¸‚åœºçš„ç«äº‰å‹åŠ›è¾ƒå¤§ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   1543536.0000000000
mean         40.3549852680
std          72.6524987375
min           0.0000000000
25%          18.5000000000
50%          25.4000000000
75%          39.5000000000
max       41860.0000000000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT </span>
<span class="s2">    Coupon_type::INT AS ä¼˜æƒ åˆ¸ç±»å‹, </span>
<span class="s2">    AVG(Actual_pay) AS ç”¨æˆ·å¹³å‡å®ä»˜, </span>
<span class="s2">    AVG(Reduce_amount) AS å¹³å‡ä¼˜æƒ é‡‘é¢, </span>
<span class="s2">    AVG(Actual_pay + Reduce_amount)::INT AS å•†å“å¹³å‡ä»·æ ¼,</span>
<span class="s2">    COUNT(*)::INT AS è®¢å•æ•°</span>
<span class="s2">    </span>
<span class="s2">FROM order_detail</span>
<span class="s2">WHERE Coupon_type IS NOT NULL</span>
<span class="s2">GROUP BY Coupon_type</span>
<span class="s2">ORDER BY è®¢å•æ•° DESC</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">tmp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ä¼˜æƒ åˆ¸ç±»å‹</th>
      <th>ç”¨æˆ·å¹³å‡å®ä»˜</th>
      <th>å¹³å‡ä¼˜æƒ é‡‘é¢</th>
      <th>å•†å“å¹³å‡ä»·æ ¼</th>
      <th>è®¢å•æ•°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>31.7827865711</td>
      <td>2.3050967231</td>
      <td>34</td>
      <td>570443</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>126.2930059075</td>
      <td>7.0602147385</td>
      <td>133</td>
      <td>23191</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6</td>
      <td>42.7784862553</td>
      <td>0.0595479536</td>
      <td>43</td>
      <td>16370</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>188.9423782772</td>
      <td>1.8468000936</td>
      <td>191</td>
      <td>8544</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10010</td>
      <td>80.8479574571</td>
      <td>6.5483901378</td>
      <td>87</td>
      <td>8274</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>30.1471179125</td>
      <td>3.0172434766</td>
      <td>33</td>
      <td>5097</td>
    </tr>
    <tr>
      <th>6</th>
      <td>20014</td>
      <td>45.4999671269</td>
      <td>0.2454207758</td>
      <td>46</td>
      <td>3042</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5</td>
      <td>46.6419047619</td>
      <td>8.1893552995</td>
      <td>55</td>
      <td>1302</td>
    </tr>
    <tr>
      <th>8</th>
      <td>20011</td>
      <td>123.4682704692</td>
      <td>9.0185556578</td>
      <td>132</td>
      <td>1087</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0</td>
      <td>243.2794994675</td>
      <td>2.6240681576</td>
      <td>246</td>
      <td>939</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10012</td>
      <td>121.6245054945</td>
      <td>14.6184203297</td>
      <td>136</td>
      <td>728</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10</td>
      <td>52.2033649289</td>
      <td>3.8614691943</td>
      <td>56</td>
      <td>422</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10015</td>
      <td>0.0492441860</td>
      <td>4.8580813953</td>
      <td>5</td>
      <td>172</td>
    </tr>
    <tr>
      <th>13</th>
      <td>20013</td>
      <td>43.7194957983</td>
      <td>2.5482352941</td>
      <td>46</td>
      <td>119</td>
    </tr>
    <tr>
      <th>14</th>
      <td>9</td>
      <td>37.5526881720</td>
      <td>8.9276344086</td>
      <td>46</td>
      <td>93</td>
    </tr>
    <tr>
      <th>15</th>
      <td>11</td>
      <td>72.7671428571</td>
      <td>3.5571428571</td>
      <td>76</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># åˆ›å»º FacetGridï¼Œæ ¹æ® Coupon_type è¿›è¡Œåˆ†é¢ç»˜å›¾</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">order_detail</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;Coupon_type&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ç›´æ–¹å›¾ï¼Œè‡ªåŠ¨åˆ†ç®±</span>
<span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="s2">&quot;Actual_pay&quot;</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®æ ‡é¢˜å’Œæ ‡ç­¾</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;Actual Pay&quot;</span><span class="p">,</span> <span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_titles</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{col_name}</span><span class="s2"> Coupon Type&quot;</span><span class="p">)</span>  <span class="c1"># æ¯ä¸ªå­å›¾åŠ¨æ€æ ‡é¢˜</span>

<span class="c1"># è®¾ç½®æ•´ä½“æ ‡é¢˜</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>  <span class="c1"># è°ƒæ•´å­å›¾ä¹‹é—´çš„é—´éš™</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Price Distribution by Coupon Type&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bd201cedddd3525937995dc60feca93263d76c963ee62c136e0b03323fb17a0f.png" src="_images/bd201cedddd3525937995dc60feca93263d76c963ee62c136e0b03323fb17a0f.png" />
</div>
</div>
<p>å¤§æ¦‚å¯ä»¥é€šè¿‡æ¶ˆè´¹åˆ¸ç±»å‹åŒºåˆ†å‡ºç”¨æˆ·ç¾¤ä½“ï¼Ÿ</p>
</section>
<section id="id25">
<h2>é€šè¿‡å¤è´­ç‡å¯¹ä¼˜æƒ åˆ¸åˆ†æ<a class="headerlink" href="#id25" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">with a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    Coupon_type,</span>
<span class="s2">    Pay_date as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">qualify row_number()over(partition by User_id order by Pay_date asc) = 1</span>
<span class="s2">),</span>
<span class="s2">-- ç”¨åˆ¸åå¤è´­ç”¨æˆ·</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    a1.*exclude(Coupon_type),</span>
<span class="s2">    a1.Coupon_type as Coupon_type,</span>
<span class="s2">    if(order_detail.User_id is not null, 1, 0) AS æ˜¯å¦å¤è´­</span>
<span class="s2">from a1</span>
<span class="s2">left join </span>
<span class="s2">(</span>
<span class="s2">    select * from order_detail</span>
<span class="s2">    where Coupon_id is not null</span>
<span class="s2">) as order_detail</span>
<span class="s2">on a1.User_id = order_detail.User_id and order_detail.Pay_date	&gt; first_date</span>
<span class="s2">)</span>
<span class="s2">select sum(æ˜¯å¦å¤è´­) * 100 / count(*) as å¤è´­ç‡, count(*) as ä½¿ç”¨æ¬¡æ•°, Coupon_type from a2</span>
<span class="s2">group by 3</span>
<span class="s2">order by 2 desc</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>å¤è´­ç‡</th>
      <th>ä½¿ç”¨æ¬¡æ•°</th>
      <th>Coupon_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>99.0586960818</td>
      <td>546476</td>
      <td>1.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>92.0333649668</td>
      <td>20021</td>
      <td>3.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>95.9482521332</td>
      <td>18165</td>
      <td>6.0000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>96.1189663579</td>
      <td>10255</td>
      <td>4.0000000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>87.0319634703</td>
      <td>4380</td>
      <td>10010.0000000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>98.1132075472</td>
      <td>2756</td>
      <td>2.0000000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>99.5024875622</td>
      <td>1206</td>
      <td>5.0000000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>94.5825932504</td>
      <td>1126</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>82.7225130890</td>
      <td>764</td>
      <td>20014.0000000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>97.2752043597</td>
      <td>734</td>
      <td>10012.0000000000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>99.3920972644</td>
      <td>329</td>
      <td>10.0000000000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>68.2481751825</td>
      <td>274</td>
      <td>10015.0000000000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>95.3781512605</td>
      <td>238</td>
      <td>9.0000000000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>59.1836734694</td>
      <td>196</td>
      <td>20011.0000000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>100.0000000000</td>
      <td>133</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16.6666666667</td>
      <td>6</td>
      <td>20013.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id26">
<h2>é€šè¿‡ä½¿ç”¨é€Ÿåº¦åˆ†å±‚<a class="headerlink" href="#id26" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail_Coupon_info</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SELECT </span>
<span class="sd">       *,</span>
<span class="sd">       LEAST(2, (Pay_date::DATE-GREATEST(Start_date::DATE, Receive_date::DATE))/(End_date::DATE-Pay_date::DATE)) AS speed,</span>
<span class="sd">       case </span>
<span class="sd">       when speed &lt;= 1 or speed = &#39;NAN&#39; then -1</span>
<span class="sd">       when speed &gt; 1 then 1</span>
<span class="sd">       end AS Frequency_consumption</span>
<span class="sd">FROM order_detail</span>
<span class="sd">JOIN user_coupon_receive USING(User_id, Coupon_id)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- ç”¨åˆ¸æ ¸é”€ç”¨æˆ·</span>
<span class="s2">with a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    Pay_date::Date as first_date</span>
<span class="s2">from order_detail_Coupon_info</span>
<span class="s2">where Coupon_id is not null and Pay_date is not null</span>
<span class="s2">),</span>
<span class="s2">-- ç”¨åˆ¸åå¤è´­ç”¨æˆ·</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    first_date,</span>
<span class="s2">    max(Frequency_consumption) as Frequency_consumption,</span>
<span class="s2">    min(Pay_date),</span>
<span class="s2">    min(datediff(&#39;day&#39;, first_date::Date, Pay_date::Date)) as inter</span>
<span class="s2">from a1</span>
<span class="s2">inner join order_detail_Coupon_info using(User_id)</span>
<span class="s2">where order_detail_Coupon_info.Pay_date::Date&gt;first_date::Date</span>
<span class="s2">group by User_id, first_date),</span>
<span class="s2">a3 as(</span>
<span class="s2">select </span>
<span class="s2">	inter,</span>
<span class="s2">    Frequency_consumption,</span>
<span class="s2">	count(*) as r</span>
<span class="s2">from a2</span>
<span class="s2">group by inter,Frequency_consumption)</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select</span>
<span class="s2">    Frequency_consumption,</span>
<span class="s2">	inter as &#39;å¤è´­å‘¨æœŸ&#39;,</span>
<span class="s2">	r as &#39;å¤è´­ç”¨æˆ·æ•°&#39;,</span>
<span class="s2">  sum(r/(select sum(r) from a3)) over(order by inter) as &#39;åˆè®¡ç™¾åˆ†æ¯”&#39;</span>
<span class="s2">from a3</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">avg_rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select Frequency_consumption, avg(inter) as &#39;å¹³å‡å¤è´­å‘¨æœŸ&#39;</span>
<span class="s2">from a2</span>
<span class="s2">group by 1</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">avg_rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Frequency_consumption</th>
      <th>å¹³å‡å¤è´­å‘¨æœŸ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>13.6966538018</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1</td>
      <td>21.1903424190</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Frequency_consumption</th>
      <th>å¤è´­å‘¨æœŸ</th>
      <th>å¤è´­ç”¨æˆ·æ•°</th>
      <th>åˆè®¡ç™¾åˆ†æ¯”</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>6763</td>
      <td>0.1218802214</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1</td>
      <td>1</td>
      <td>2574</td>
      <td>0.1218802214</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2</td>
      <td>5053</td>
      <td>0.2139332707</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-1</td>
      <td>2</td>
      <td>1999</td>
      <td>0.2139332707</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>3</td>
      <td>4106</td>
      <td>0.2882205514</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-1</td>
      <td>3</td>
      <td>1585</td>
      <td>0.2882205514</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>4</td>
      <td>3245</td>
      <td>0.3481359649</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-1</td>
      <td>4</td>
      <td>1345</td>
      <td>0.3481359649</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>5</td>
      <td>2789</td>
      <td>0.3996188388</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-1</td>
      <td>5</td>
      <td>1155</td>
      <td>0.3996188388</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1</td>
      <td>6</td>
      <td>2460</td>
      <td>0.4456584169</td>
    </tr>
    <tr>
      <th>11</th>
      <td>-1</td>
      <td>6</td>
      <td>1067</td>
      <td>0.4456584169</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1</td>
      <td>7</td>
      <td>2214</td>
      <td>0.4873120301</td>
    </tr>
    <tr>
      <th>13</th>
      <td>-1</td>
      <td>7</td>
      <td>977</td>
      <td>0.4873120301</td>
    </tr>
    <tr>
      <th>14</th>
      <td>-1</td>
      <td>8</td>
      <td>842</td>
      <td>0.5221517335</td>
    </tr>
    <tr>
      <th>15</th>
      <td>1</td>
      <td>8</td>
      <td>1827</td>
      <td>0.5221517335</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1</td>
      <td>9</td>
      <td>1564</td>
      <td>0.5521486007</td>
    </tr>
    <tr>
      <th>17</th>
      <td>-1</td>
      <td>9</td>
      <td>734</td>
      <td>0.5521486007</td>
    </tr>
    <tr>
      <th>18</th>
      <td>-1</td>
      <td>10</td>
      <td>629</td>
      <td>0.5782555347</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>10</td>
      <td>1371</td>
      <td>0.5782555347</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 339 entries, 0 to 338
Data columns (total 4 columns):
 #   Column                 Non-Null Count  Dtype  
---  ------                 --------------  -----  
 0   Frequency_consumption  339 non-null    int32  
 1   å¤è´­å‘¨æœŸ                   339 non-null    int64  
 2   å¤è´­ç”¨æˆ·æ•°                  339 non-null    int64  
 3   åˆè®¡ç™¾åˆ†æ¯”                  339 non-null    float64
dtypes: float64(1), int32(1), int64(2)
memory usage: 9.4 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;å¤è´­å‘¨æœŸ&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;å¤è´­ç”¨æˆ·æ•°&#39;</span><span class="p">,</span> <span class="n">hue</span> <span class="o">=</span> <span class="s1">&#39;Frequency_consumption&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;å¤è´­å‘¨æœŸ&#39;, ylabel=&#39;å¤è´­ç”¨æˆ·æ•°&#39;&gt;
</pre></div>
</div>
<img alt="_images/6c1a5d866a48babae2ef0dfaba8f5f1be0ef6eb9de4bd41a35970676eb13c359.png" src="_images/6c1a5d866a48babae2ef0dfaba8f5f1be0ef6eb9de4bd41a35970676eb13c359.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="rfm">
<h1>RFMç”¨æˆ·ä»·å€¼åˆ†æ<a class="headerlink" href="#rfm" title="Link to this heading">#</a></h1>
<p>é€šè¿‡RFMçš„è¿™ä¸‰ä¸ªæŒ‡æ ‡æ¥å»ºç«‹xyzè½´ï¼Œç”¨è¿™ä¸‰ä¸ªç»´åº¦æ¥åˆ’åˆ†ä¸åŒçš„ç”¨æˆ·ï¼Œé’ˆå¯¹ä¸åŒåˆ†ç±»çš„ç”¨æˆ·æ¥è¿›è¡Œæ›´åŠ ç²¾ç»†çš„è¿è¥ï¼Œé‡æ–°å®šä¹‰RFMï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<p>Rï¼šæŒ‡ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡è´­ä¹°ç¦»è¡¨ä¸­æœ€è¿‘æ—¥æœŸçš„è·ç¦»</p>
<p>Fï¼šæŒ‡ç”¨æˆ·è´­ä¹°æ¬¡æ•°è¿›è¡ŒæŒ‡ä»£</p>
<p>Mï¼šæŒ‡ç”¨æˆ·ç”¨åˆ¸åå®é™…æ¶ˆè´¹é‡‘é¢ï¼Œä¾‹å¦‚200:20çš„ä¼˜æƒ åˆ¸ï¼ŒM = 200-20</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rï¼šæœ€è¿‘ç”¨åˆ¸æ¶ˆè´¹æ¶ˆè´¹æ—¶é—´</span>
<span class="c1"># Fï¼šç”¨åˆ¸æ¶ˆè´¹é¢‘ç‡</span>
<span class="c1"># Mï¼šç”¨åˆ¸å®é™…æ¶ˆè´¹é‡‘é¢</span>
<span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">		User_id as &#39;ç”¨æˆ·ID&#39;,</span>
<span class="s2">		DATEDIFF(&#39;day&#39;, max(Pay_date)::Date, &#39;2023-06-30&#39;::Date) as R,</span>
<span class="s2">		count(*) as F,</span>
<span class="s2">		round(avg(Actual_pay),2) as M </span>
<span class="s2">FROM order_detail</span>
<span class="s2">group by User_id &quot;&quot;&quot;</span>
<span class="n">RFM</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">RFM</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ID</th>
      <th>R</th>
      <th>F</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>44782be9c360d5f806d1d60faa3f0b3a</td>
      <td>2</td>
      <td>125</td>
      <td>34.3600000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>495066eb5297c98d87368b9f7b3ccfb5</td>
      <td>0</td>
      <td>132</td>
      <td>18.6600000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>74cdfb1ef06e8c31831df411887b7293</td>
      <td>0</td>
      <td>633</td>
      <td>56.5000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5e5d960aff5d0254eff1dd6ca05613fb</td>
      <td>1</td>
      <td>156</td>
      <td>32.2500000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5e44f2eb9b56827200dcfca21040ea8c</td>
      <td>0</td>
      <td>41</td>
      <td>71.7500000000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>47203</th>
      <td>6a264405a916a4a95698ab78d34a19f2</td>
      <td>13</td>
      <td>1</td>
      <td>14.9000000000</td>
    </tr>
    <tr>
      <th>47204</th>
      <td>c8dcf989f71da0085a188d5ecca9a5a2</td>
      <td>86</td>
      <td>1</td>
      <td>69.9000000000</td>
    </tr>
    <tr>
      <th>47205</th>
      <td>b8b96d2d86577d2a9624114525df6be5</td>
      <td>151</td>
      <td>1</td>
      <td>26.8000000000</td>
    </tr>
    <tr>
      <th>47206</th>
      <td>adbd4f9aec407eff36bccf77b5ad9e07</td>
      <td>44</td>
      <td>1</td>
      <td>241.0000000000</td>
    </tr>
    <tr>
      <th>47207</th>
      <td>5031a5f6309bce260a57a8526a9cf510</td>
      <td>13</td>
      <td>1</td>
      <td>21.4800000000</td>
    </tr>
  </tbody>
</table>
<p>47208 rows Ã— 4 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RFM</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>R</th>
      <th>F</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>47208.0000000000</td>
      <td>47208.0000000000</td>
      <td>47208.0000000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>36.2260210134</td>
      <td>32.6964921200</td>
      <td>51.3548080834</td>
    </tr>
    <tr>
      <th>std</th>
      <td>45.5094999753</td>
      <td>58.0147054336</td>
      <td>69.9930663422</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.0000000000</td>
      <td>1.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>3.0000000000</td>
      <td>3.0000000000</td>
      <td>22.9000000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>15.0000000000</td>
      <td>10.0000000000</td>
      <td>34.1100000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>55.0000000000</td>
      <td>37.0000000000</td>
      <td>56.7025000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>180.0000000000</td>
      <td>942.0000000000</td>
      <td>3680.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>25%çš„äººåœ¨5å¤©å†…æœ‰è¿‡æ¶ˆè´¹</p>
<section id="id27">
<h2>1ï¸âƒ£ RFM æ•°æ®åˆ†å¸ƒï¼šç›´æ–¹å›¾<a class="headerlink" href="#id27" title="Link to this heading">#</a></h2>
<p>ç›®çš„ï¼šè§‚å¯Ÿ Rã€Fã€M çš„åˆ†å¸ƒæƒ…å†µï¼Œè¯†åˆ«åæ€ã€ç¦»ç¾¤ç‚¹ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è®¾ç½®ç”»å¸ƒ</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># ç›´æ–¹å›¾ç»˜åˆ¶ RFM ä¸‰ä¸ªæŒ‡æ ‡çš„åˆ†å¸ƒ</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Recency åˆ†å¸ƒ&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Frequency åˆ†å¸ƒ&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Monetary åˆ†å¸ƒ&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5c04229f164f867c48ce6abc9981b6c16bac6917b4509dc4fcbcb6a9af61c2cb.png" src="_images/5c04229f164f867c48ce6abc9981b6c16bac6917b4509dc4fcbcb6a9af61c2cb.png" />
</div>
</div>
</section>
<section id="id28">
<h2>2ï¸âƒ£ RFM ä¸‰å˜é‡å…³ç³»ï¼šæ•£ç‚¹å›¾<a class="headerlink" href="#id28" title="Link to this heading">#</a></h2>
<p>ç›®çš„ï¼šè§‚å¯Ÿ Rã€Fã€M ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œæ¯”å¦‚æ¶ˆè´¹æ¬¡æ•°å’Œæ¶ˆè´¹é‡‘é¢çš„ç›¸å…³æ€§ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">,</span> <span class="n">diag_kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span> <span class="n">plot_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;RFM å˜é‡å…³ç³»&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/872b3c0b2aaeb363614aad01434a4c990351afbda6591627e97c964f6662649d.png" src="_images/872b3c0b2aaeb363614aad01434a4c990351afbda6591627e97c964f6662649d.png" />
</div>
</div>
</section>
<section id="rfm-k-means">
<h2>3ï¸âƒ£ RFM åˆ†ç¾¤ï¼šK-Means èšç±»<a class="headerlink" href="#rfm-k-means" title="Link to this heading">#</a></h2>
<p>ç›®çš„ï¼šå°†ç”¨æˆ·æŒ‰ RFM è¯„åˆ†åˆ†æˆä¸åŒç¾¤ä½“ï¼Œè§‚å¯Ÿé«˜ä»·å€¼ç”¨æˆ·ã€ä½ä»·å€¼ç”¨æˆ·çš„åˆ†å¸ƒæƒ…å†µã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># æ•°æ®æ ‡å‡†åŒ–</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">RFM_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">RFM</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]])</span>

<span class="c1"># K-Means èšç±»</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;Cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">RFM_scaled</span><span class="p">)</span>

<span class="c1"># å¯è§†åŒ–ä¸åŒç¾¤ä½“çš„åˆ†å¸ƒ</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">RFM</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ç”¨æˆ·ç¾¤ä½“åˆ’åˆ†ï¼ˆåŸºäº RFM èšç±»ï¼‰&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6b2e9c7d4a8825d93ae3a4538906333550af9fbdbdb4b829d227e8208d6d0979.png" src="_images/6b2e9c7d4a8825d93ae3a4538906333550af9fbdbdb4b829d227e8208d6d0979.png" />
</div>
</div>
<p>ğŸ“Œ è§£é‡Šï¼š</p>
<p>ä½¿ç”¨ KMeans è¿›è¡Œèšç±»ï¼Œåˆ†æˆ 4 ä¸ªç”¨æˆ·ç¾¤ä½“ã€‚</p>
<p>é€šè¿‡ scatterplot() è§‚å¯Ÿ è´­ä¹°é¢‘æ¬¡ï¼ˆFï¼‰å’Œæ¶ˆè´¹é‡‘é¢ï¼ˆMï¼‰ çš„èšç±»æƒ…å†µã€‚</p>
</section>
<section id="id29">
<h2>4ï¸âƒ£ å„ç¾¤ä½“çš„ RFM æŒ‡æ ‡ç®±çº¿å›¾<a class="headerlink" href="#id29" title="Link to this heading">#</a></h2>
<p>ç›®çš„ï¼šæ¯”è¾ƒä¸åŒç”¨æˆ·ç¾¤ä½“çš„ RFM æŒ‡æ ‡åˆ†å¸ƒï¼Œæ‰¾å‡ºé«˜ä»·å€¼ç”¨æˆ·ä¸ä½ä»·å€¼ç”¨æˆ·çš„å·®å¼‚ã€‚</p>
<p>ğŸ“Œ è§£é‡Šï¼š</p>
<p>boxplot() å¯ä»¥çœ‹å‡ºä¸åŒç¾¤ä½“çš„ RFM å€¼åˆ†å¸ƒï¼Œå‘ç°å¼‚å¸¸å€¼æˆ–æç«¯ç”¨æˆ·ã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">RFM</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> åˆ†å¸ƒï¼ˆæŒ‰ç”¨æˆ·ç¾¤ä½“ï¼‰&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f322a0d2752e93370ed53599d8e91732b1dc924ccdcc33ef32a2b856c3c68b44.png" src="_images/f322a0d2752e93370ed53599d8e91732b1dc924ccdcc33ef32a2b856c3c68b44.png" />
</div>
</div>
</section>
<section id="id30">
<h2>5ï¸âƒ£ RFM å¾—åˆ†çƒ­åŠ›å›¾<a class="headerlink" href="#id30" title="Link to this heading">#</a></h2>
<p>ç›®çš„ï¼šæŸ¥çœ‹ä¸åŒ Rã€Fã€M ç»„åˆçš„ç”¨æˆ·åˆ†å¸ƒï¼Œå‘ç°æœ€ä¼˜ç”¨æˆ·ç¾¤ã€‚</p>
<p>ğŸ“Œ è§£é‡Šï¼š</p>
<p>qcut() å°† Rã€Fã€M åˆ†ä¸º 4 ä¸ªè¯„åˆ†ï¼ˆ1-4ï¼‰ï¼Œ4 ä»£è¡¨é«˜ä»·å€¼ç”¨æˆ·ã€‚</p>
<p>heatmap() ç›´è§‚æ˜¾ç¤º R-F ç»„åˆçš„ç”¨æˆ·æ¶ˆè´¹é‡‘é¢ï¼ˆMï¼‰ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°å“ªäº›ç¾¤ä½“çš„ç”¨æˆ·æ¶ˆè´¹èƒ½åŠ›æœ€å¼ºã€‚</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RFM è¯„åˆ†ï¼ˆæŒ‰ç™¾åˆ†ä½æ•°ï¼‰</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;R_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;F_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;M_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="c1"># è®¡ç®— R å’Œ F ç»„åˆçš„å¹³å‡ M å€¼</span>
<span class="n">rfm_pivot</span> <span class="o">=</span> <span class="n">RFM</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;R_score&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;F_score&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶çƒ­åŠ›å›¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">rfm_pivot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;R-F ç»„åˆçš„ M å¹³å‡å€¼&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d74c34d1f9deba5466a01fcf3f8806246ada7bd07922d21004423c871c7752ec.png" src="_images/d74c34d1f9deba5466a01fcf3f8806246ada7bd07922d21004423c871c7752ec.png" />
</div>
</div>
</section>
<section id="id31">
<h2>ç”¨æˆ·ä»·å€¼åˆ†ç±»ç»Ÿè®¡<a class="headerlink" href="#id31" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">with DESC_RFM20 as(</span>
<span class="s2">SELECT </span>
<span class="s2">	R,F,M,</span>
<span class="s2">	PERCENT_RANK() over ( ORDER BY R ) AS PERCENT_R,</span>
<span class="s2">	PERCENT_RANK() over ( ORDER BY F DESC ) AS PERCENT_F, </span>
<span class="s2">	PERCENT_RANK() over ( ORDER BY M DESC ) AS PERCENT_M</span>
<span class="s2">FROM RFM)</span>

<span class="s2">SELECT &#39;R&#39; as tag, MAX(R) as &#39;é˜ˆå€¼&#39;</span>
<span class="s2">FROM DESC_RFM20</span>
<span class="s2">WHERE PERCENT_R&lt;=0.20</span>
<span class="s2">UNION </span>
<span class="s2">SELECT &#39;F&#39; as tag, MIN(F) as &#39;é˜ˆå€¼&#39;</span>
<span class="s2">FROM DESC_RFM20</span>
<span class="s2">WHERE PERCENT_F&lt;=0.2</span>
<span class="s2">UNION</span>
<span class="s2">SELECT &#39;M&#39; as tag, MIN(M) as &#39;é˜ˆå€¼&#39;</span>
<span class="s2">FROM DESC_RFM20</span>
<span class="s2">WHERE PERCENT_M&lt;=0.2</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tag</th>
      <th>é˜ˆå€¼</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>F</td>
      <td>48.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>R</td>
      <td>2.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>M</td>
      <td>65.6200000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select </span>
<span class="s2">coalesce(RFM.ç”¨æˆ·ID, tmp.ç”¨æˆ·ID) as ç”¨æˆ·ID,</span>
<span class="s2">case when R&lt;=5 and F&gt;=28 and M&gt;=76.86 then &#39;é‡è¦ä»·å€¼å®¢æˆ·&#39;</span>
<span class="s2">when R&lt;=5 and F&gt;=28 and M&lt;76.86 then &#39;ä¸€èˆ¬ä»·å€¼å®¢æˆ·&#39;</span>
<span class="s2">when R&lt;=5 and F&lt;28 and M&gt;=76.86 then &#39;é‡è¦å‘å±•å®¢æˆ·&#39;</span>
<span class="s2">when R&lt;=5 and F&lt;28 and M&lt;76.86 then &#39;ä¸€èˆ¬å‘å±•å®¢æˆ·&#39;</span>
<span class="s2">when R&gt;5 and F&gt;=28 and M&gt;=76.86 then &#39;é‡è¦å”¤å›å®¢æˆ·&#39;</span>
<span class="s2">when R&gt;5 and F&gt;=28 and M&lt;76.86 then &#39;ä¸€èˆ¬å”¤å›å®¢æˆ·&#39;</span>
<span class="s2">when R&gt;5 and F&lt;28 and M&gt;=76.86 then &#39;é‡è¦æŒ½ç•™å®¢æˆ·&#39;</span>
<span class="s2">when R&gt;5 and F&lt;28 and M&lt;76.86 then &#39;ä¸€èˆ¬æŒ½ç•™å®¢æˆ·&#39;</span>
<span class="s2">when R is null then &#39;ä¸å­˜åœ¨æ¶ˆè´¹è®°å½•çš„ç”¨æˆ·&#39;</span>
<span class="s2">end as &#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span>
<span class="s2">from RFM</span>
<span class="s2">FULL join (select distinct User_id ç”¨æˆ·ID from user_coupon_receive) tmp on RFM.ç”¨æˆ·ID = tmp.ç”¨æˆ·ID</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">user_RFM</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

<span class="n">user_RFM</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ID</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0e22c035960968d76081373133fdf55e</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>1</th>
      <td>78a95eb83301f5f727f6141c8bb798a2</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6121622ad0d46fd2ea8d11fdbe761686</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>3</th>
      <td>e3465919afd0c4e52c0db3506e0f0e36</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>4</th>
      <td>e3c0372a7c967f12b721b2c3213b98db</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>49668</th>
      <td>edae8f646ef36f3146736735af306d6d</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>49669</th>
      <td>8d2a60a7283d2462ec8e3c545af66d3a</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>49670</th>
      <td>27ede92657665505db524f15cf6bdc3b</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>49671</th>
      <td>adbd4f9aec407eff36bccf77b5ad9e07</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>49672</th>
      <td>5031a5f6309bce260a57a8526a9cf510</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
  </tbody>
</table>
<p>49673 rows Ã— 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select ç”¨æˆ·ä»·å€¼æ—ç¾¤,count(ç”¨æˆ·ID) as ç”¨æˆ·æ•°,</span>
<span class="s2">concat(round(count(ç”¨æˆ·ID)/(SELECT COUNT(*) FROM user_RFM)*100,2),&#39;%&#39;) as ç”¨æˆ·æ•°å æ¯”</span>
<span class="s2">from user_RFM</span>
<span class="s2">group by ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">order by ç”¨æˆ·ä»·å€¼æ—ç¾¤;&quot;&quot;&quot;</span>

<span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
      <th>ç”¨æˆ·æ•°</th>
      <th>ç”¨æˆ·æ•°å æ¯”</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>8772</td>
      <td>17.66%</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>4740</td>
      <td>9.54%</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>4521</td>
      <td>9.1%</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
      <td>21870</td>
      <td>44.03%</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ä¸å­˜åœ¨æ¶ˆè´¹è®°å½•çš„ç”¨æˆ·</td>
      <td>2465</td>
      <td>4.96%</td>
    </tr>
    <tr>
      <th>5</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>618</td>
      <td>1.24%</td>
    </tr>
    <tr>
      <th>6</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>834</td>
      <td>1.68%</td>
    </tr>
    <tr>
      <th>7</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>345</td>
      <td>0.69%</td>
    </tr>
    <tr>
      <th>8</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>5508</td>
      <td>11.09%</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id32">
<h1>RFM + ç”¨æˆ·è½¬åŒ–åˆ†æ<a class="headerlink" href="#id32" title="Link to this heading">#</a></h1>
<section id="id33">
<h2>ä¸åŒä»·å€¼æ—ç¾¤çš„è½¬åŒ–æ¼æ–—<a class="headerlink" href="#id33" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">select</span>
<span class="s1">    count(distinct User_id) as getcoupons_users</span>
<span class="s1">    ,ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s1">from user_coupon_receive</span>
<span class="s1">left join user_RFM on User_id = ç”¨æˆ·ID</span>
<span class="s1">where Coupon_id is not null</span>
<span class="s1">group by 2</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getcoupons_users â”‚     ç”¨æˆ·ä»·å€¼æ—ç¾¤     â”‚
â”‚      int64       â”‚       varchar        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             4649 â”‚ ä¸€èˆ¬å‘å±•å®¢æˆ·         â”‚
â”‚             4518 â”‚ ä¸€èˆ¬å”¤å›å®¢æˆ·         â”‚
â”‚             5360 â”‚ é‡è¦æŒ½ç•™å®¢æˆ·         â”‚
â”‚             2464 â”‚ ä¸å­˜åœ¨æ¶ˆè´¹è®°å½•çš„ç”¨æˆ· â”‚
â”‚              824 â”‚ é‡è¦å‘å±•å®¢æˆ·         â”‚
â”‚            21211 â”‚ ä¸€èˆ¬æŒ½ç•™å®¢æˆ·         â”‚
â”‚              345 â”‚ é‡è¦å”¤å›å®¢æˆ·         â”‚
â”‚             8771 â”‚ ä¸€èˆ¬ä»·å€¼å®¢æˆ·         â”‚
â”‚              618 â”‚ é‡è¦ä»·å€¼å®¢æˆ·         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- æ‰€æœ‰ç”¨æˆ·</span>
<span class="s2">with t1 as </span>
<span class="s2">(</span>
<span class="s2">    select</span>
<span class="s2">         count(distinct User_id) as all_users,ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">     from (</span>
<span class="s2">         SELECT * FROM</span>
<span class="s2">         (</span>
<span class="s2">          select User_id from order_detail</span>
<span class="s2">          union all</span>
<span class="s2">          select User_id from user_visit_detail</span>
<span class="s2">          union all</span>
<span class="s2">          select User_id from user_coupon_receive</span>
<span class="s2">         ) left join user_RFM on User_id = ç”¨æˆ·ID</span>
<span class="s2">     )</span>
<span class="s2">     group by 2</span>
<span class="s2">),</span>
<span class="s2">-- é¢†åˆ¸ç”¨æˆ·</span>
<span class="s2">t2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as getcoupons_users</span>
<span class="s2">    ,ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">from user_coupon_receive</span>
<span class="s2">left join user_RFM on User_id = ç”¨æˆ·ID</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">group by 2</span>
<span class="s2">),</span>
<span class="s2">-- é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·</span>
<span class="s2">a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    ç”¨æˆ·ä»·å€¼æ—ç¾¤,</span>
<span class="s2">    min(Pay_date) as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">left join user_RFM on User_id = ç”¨æˆ·ID</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">group by User_id, ç”¨æˆ·ä»·å€¼æ—ç¾¤),</span>
<span class="s2">-- ç”¨åˆ¸åå¤è´­ç”¨æˆ·</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as second_user,</span>
<span class="s2">    ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">from a1</span>
<span class="s2">inner join </span>
<span class="s2">(</span>
<span class="s2">    select * from order_detail</span>
<span class="s2">    where Coupon_id is not null</span>
<span class="s2">) as order_detail</span>
<span class="s2">using(User_id)</span>
<span class="s2">where order_detail.Pay_date	&gt;first_date</span>
<span class="s2">group by 2</span>
<span class="s2">)</span>
<span class="s2">SELECT </span>
<span class="s2">    t1.ç”¨æˆ·ä»·å€¼æ—ç¾¤,</span>
<span class="s2">    t1.all_users AS å…¨ä½“ç”¨æˆ·,</span>
<span class="s2">    getcoupons_users AS é¢†åˆ¸ç”¨æˆ·,</span>
<span class="s2">    coalesce(é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·, 0) AS é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ· ,</span>
<span class="s2">    coalesce(second_user, 0) AS ç”¨åˆ¸åå¤è´­ç”¨æˆ·</span>
<span class="s2">    </span>
<span class="s2">FROM </span>
<span class="s2">    t1</span>
<span class="s2">LEFT JOIN </span>
<span class="s2">    t2</span>
<span class="s2">ON t1.ç”¨æˆ·ä»·å€¼æ—ç¾¤ = t2.ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">LEFT JOIN </span>
<span class="s2">    (SELECT COUNT(DISTINCT User_id) AS é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·, ç”¨æˆ·ä»·å€¼æ—ç¾¤ FROM a1 GROUP BY ç”¨æˆ·ä»·å€¼æ—ç¾¤) AS a1_data</span>
<span class="s2">ON t1.ç”¨æˆ·ä»·å€¼æ—ç¾¤ = a1_data.ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">LEFT JOIN a2</span>
<span class="s2">ON t1.ç”¨æˆ·ä»·å€¼æ—ç¾¤ = a2.ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">WHERE t1.ç”¨æˆ·ä»·å€¼æ—ç¾¤	is not null</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
      <th>å…¨ä½“ç”¨æˆ·</th>
      <th>é¢†åˆ¸ç”¨æˆ·</th>
      <th>é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·</th>
      <th>ç”¨åˆ¸åå¤è´­ç”¨æˆ·</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>4740</td>
      <td>4649</td>
      <td>3378</td>
      <td>2471</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>8772</td>
      <td>8771</td>
      <td>8559</td>
      <td>8382</td>
    </tr>
    <tr>
      <th>2</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>618</td>
      <td>618</td>
      <td>604</td>
      <td>589</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>4521</td>
      <td>4518</td>
      <td>4390</td>
      <td>4272</td>
    </tr>
    <tr>
      <th>4</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>5508</td>
      <td>5360</td>
      <td>4002</td>
      <td>1930</td>
    </tr>
    <tr>
      <th>5</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>834</td>
      <td>824</td>
      <td>677</td>
      <td>481</td>
    </tr>
    <tr>
      <th>6</th>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
      <td>21870</td>
      <td>21211</td>
      <td>12872</td>
      <td>7475</td>
    </tr>
    <tr>
      <th>7</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>345</td>
      <td>345</td>
      <td>339</td>
      <td>324</td>
    </tr>
    <tr>
      <th>8</th>
      <td>ä¸å­˜åœ¨æ¶ˆè´¹è®°å½•çš„ç”¨æˆ·</td>
      <td>2465</td>
      <td>2464</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è·å–æ‰€æœ‰ç”¨æˆ·ç±»å‹</span>
<span class="n">user_types</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ç”¨æˆ·ä»·å€¼æ—ç¾¤&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># è®¾ç½®å­å›¾å¸ƒå±€ï¼ˆ2 åˆ—ï¼‰</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_types</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># è®¡ç®—è¡Œæ•°</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="n">user_types</span><span class="p">)</span>

<span class="c1"># å®šä¹‰é¢œè‰²æ–¹æ¡ˆ</span>
<span class="n">color_palette</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffab00&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8000&#39;</span><span class="p">]</span>
<span class="n">line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;wheat&quot;</span><span class="p">]</span>
<span class="c1"># éå†æ¯ä¸ªç”¨æˆ·ç±»å‹å¹¶ç»˜åˆ¶æ¼æ–—å›¾</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">funnel_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;é˜¶æ®µ&quot;</span><span class="p">:</span> <span class="s2">&quot;å…¨ä½“ç”¨æˆ·&quot;</span><span class="p">,</span> <span class="s2">&quot;äººæ•°&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;å…¨ä½“ç”¨æˆ·&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;é˜¶æ®µ&quot;</span><span class="p">:</span> <span class="s2">&quot;é¢†åˆ¸ç”¨æˆ·&quot;</span><span class="p">,</span> <span class="s2">&quot;äººæ•°&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;é¢†åˆ¸ç”¨æˆ·&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;é˜¶æ®µ&quot;</span><span class="p">:</span> <span class="s2">&quot;é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·&quot;</span><span class="p">,</span> <span class="s2">&quot;äººæ•°&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;é¦–æ¬¡ç”¨åˆ¸æ ¸é”€ç”¨æˆ·&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;é˜¶æ®µ&quot;</span><span class="p">:</span> <span class="s2">&quot;ç”¨åˆ¸åå¤è´­ç”¨æˆ·&quot;</span><span class="p">,</span> <span class="s2">&quot;äººæ•°&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ç”¨åˆ¸åå¤è´­ç”¨æˆ·&quot;</span><span class="p">]}</span>
    <span class="p">]</span>
    <span class="n">funnel_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">funnel_data</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—ç›¸å¯¹åˆå§‹å€¼çš„ç™¾åˆ†æ¯”</span>
    <span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;percent_initial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;äººæ•°&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;äººæ•°&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Funnel</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;äººæ•°&quot;</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;é˜¶æ®µ&quot;</span><span class="p">],</span>
        <span class="n">textinfo</span><span class="o">=</span><span class="s2">&quot;value+percent initial&quot;</span><span class="p">,</span>
        <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;inside&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color_palette</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">funnel_df</span><span class="p">)],</span>  <span class="c1"># é™åˆ¶é¢œè‰²æ•°é‡</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">funnel_df</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">line_colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">funnel_df</span><span class="p">)])</span>
        <span class="p">),</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
        <span class="n">connector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;ç”¨æˆ·ä»·å€¼æ—ç¾¤&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># ç¡®å®šå­å›¾ä½ç½®</span>
    <span class="n">row_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">col_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row_num</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col_num</span><span class="p">)</span>

<span class="c1"># **è°ƒæ•´å›¾è¡¨å°ºå¯¸ï¼Œé˜²æ­¢æ˜¾ç¤ºä¸å…¨**</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;ğŸ“Š ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤çš„è½¬åŒ–æ¼æ–—&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkblue&quot;</span><span class="p">)),</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">),</span>
    <span class="n">height</span><span class="o">=</span><span class="n">rows</span> <span class="o">*</span> <span class="mi">600</span><span class="p">,</span>  <span class="c1"># **åŠ¨æ€è°ƒæ•´é«˜åº¦**</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1400</span><span class="p">,</span>  <span class="c1"># **åŠ å®½å›¾è¡¨**</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">80</span><span class="p">),</span>  <span class="c1"># **å¢åŠ è¾¹è·ï¼Œé˜²æ­¢è£å‰ª**</span>
    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># å…³é—­å…¨å±€å›¾ä¾‹</span>
<span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>å¤è´­ç‡: ä¸€èˆ¬æŒ½ç•™å®¢æˆ·(34%) &lt; é‡è¦æŒ½ç•™å®¢æˆ·(35%) &lt; ä¸€èˆ¬å‘å±•å®¢æˆ·(52%) &lt; é‡è¦å‘å±•å®¢æˆ·(58%)</p>
<p>å…¶ä¸­ä¸€èˆ¬æŒ½ç•™å®¢æˆ·å æ€»å®¢æˆ·çš„44%, <strong>æ˜¯éœ€è¦é‡ç‚¹å…³æ³¨çš„ç›®æ ‡</strong></p>
<ol class="arabic simple">
<li><p>æ˜¯ä¸æ˜¯äººå‡é¢†åˆ¸æ¬¡æ•°å¤ªå°‘äº†ï¼Ÿ</p></li>
<li><p>ä¼˜æƒ åŠ›åº¦ä¸å¤Ÿï¼Ÿä¼˜æƒ å æ¯”å°ï¼Ÿ</p></li>
<li><p>ä¼˜æƒ é—¨æ§›é«˜ï¼Ÿ</p></li>
<li><p>æ¶ˆè´¹æ°´å¹³å’Œæ¶ˆè´¹åˆ¸çš„ä¼˜æƒ å·®è·è¿‡å¤§ï¼ˆåˆ†å·®ï¼‰</p></li>
</ol>
</section>
<section id="id34">
<h2>ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤çš„æ¶ˆè´¹åˆ†å¸ƒ<a class="headerlink" href="#id34" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select t1.*, t2.ç”¨æˆ·ä»·å€¼æ—ç¾¤ from order_detail t1</span>
<span class="s1">left join user_RFM t2 on t1.User_id = t2.ç”¨æˆ·ID</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># è®¾ç½®æ ·å¼</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>


<span class="c1"># æŒ‡å®šä¸€ä¸ªæ”¯æŒä¸­æ–‡çš„å­—ä½“ (å¦‚ SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># æˆ– &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜</span>

<span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;é‡è¦æŒ½ç•™å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;é‡è¦å‘å±•å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ä¸€èˆ¬æŒ½ç•™å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ä¸€èˆ¬å‘å±•å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ä¸€èˆ¬ä»·å€¼å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ä¸€èˆ¬å”¤å›å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;é‡è¦ä»·å€¼å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;é‡è¦å”¤å›å®¢æˆ·&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span>
<span class="p">}</span>


<span class="c1"># åˆ›å»ºç”»å¸ƒ</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Actual_pay_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">])</span>
<span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">])</span>

<span class="c1"># ç»˜åˆ¶ Actual_pay çš„å°æç´å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·ä»·å€¼æ—ç¾¤&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Actual_pay_log&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">wide_df</span><span class="p">[</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
               <span class="n">palette</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤çš„ æ¶ˆè´¹èƒ½åŠ› åˆ†å¸ƒ&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Actual Pay&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶ Reduce_amount çš„å°æç´å›¾</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·ä»·å€¼æ—ç¾¤&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Reduce_amount_log&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">wide_df</span><span class="p">[</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
               <span class="n">palette</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤çš„ ä¼˜æƒ é‡‘é¢ åˆ†å¸ƒ&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Reduce Amount&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># æ·»åŠ ç½‘æ ¼</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="c1"># è°ƒæ•´å¸ƒå±€</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d2687d16c7cee5808a4fab7ae9b30bb3b2d189ed60e9ab44fce8926f378365e2.png" src="_images/d2687d16c7cee5808a4fab7ae9b30bb3b2d189ed60e9ab44fce8926f378365e2.png" />
</div>
</div>
<p>ç»“è®º:</p>
<ol class="arabic simple">
<li><p>æ¨ªçº¿ä»£è¡¨ä¸­ä½æ•°ï¼Œä¸€èˆ¬æŒ½ç•™å®¢æˆ·æ¶ˆè´¹æ°´å¹³å¤„äºä¸­é—´ä½ç½®ï¼Œå…¶ä¸­ä¹Ÿæœ‰å°‘éƒ¨åˆ†äººæ¶ˆè´¹æ°´å¹³ä½äºå…¶ä»–ç¾¤ä½“ã€‚</p></li>
<li><p>é¢†åˆ°åˆ¸çš„äººï¼Œä¸€èˆ¬æŒ½ç•™å®¢æˆ·çš„ä¼˜æƒ æ°´å¹³ç•¥ä½äºå…¶ä»–ç¾¤ä½“</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        ç”¨æˆ·ä»·å€¼æ—ç¾¤, </span>
<span class="s1">        coupon_type,</span>
<span class="s1">        count(*) as æ¶ˆè´¹æ¬¡æ•°, </span>
<span class="s1">        sum(if(reduce_amount &gt; 0, 1, 0)) as ä¼˜æƒ æ¬¡æ•°,</span>
<span class="s1">        sum(reduce_amount) * 100 / sum(actual_pay + reduce_amount) as ä¼˜æƒ æ¯”ä¾‹</span>
<span class="s1">from wide_df</span>
<span class="s1">group by 1, 2</span>
<span class="s1">order by ä¼˜æƒ æ¬¡æ•° asc</span>
<span class="s1">LIMIT 50</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
      <th>Coupon_type</th>
      <th>æ¶ˆè´¹æ¬¡æ•°</th>
      <th>ä¼˜æƒ æ¬¡æ•°</th>
      <th>ä¼˜æƒ æ¯”ä¾‹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>6.0000000000</td>
      <td>357</td>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>6.0000000000</td>
      <td>220</td>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>6.0000000000</td>
      <td>279</td>
      <td>1.0000000000</td>
      <td>0.0039345325</td>
    </tr>
    <tr>
      <th>3</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>9.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>11.2026976396</td>
    </tr>
    <tr>
      <th>4</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>20013.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>1.9000000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>14</td>
      <td>1.0000000000</td>
      <td>0.7675814532</td>
    </tr>
    <tr>
      <th>6</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>20014.0000000000</td>
      <td>35</td>
      <td>1.0000000000</td>
      <td>0.0564652739</td>
    </tr>
    <tr>
      <th>7</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>9.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>8.1147040879</td>
    </tr>
    <tr>
      <th>8</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>4.0000000000</td>
      <td>209</td>
      <td>1.0000000000</td>
      <td>0.9800932592</td>
    </tr>
    <tr>
      <th>9</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>10015.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>99.7142857143</td>
    </tr>
    <tr>
      <th>10</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>11.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>5.0985723997</td>
    </tr>
    <tr>
      <th>11</th>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
      <td>4.0000000000</td>
      <td>455</td>
      <td>1.0000000000</td>
      <td>0.6873075865</td>
    </tr>
    <tr>
      <th>12</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>11.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>2.4965672201</td>
    </tr>
    <tr>
      <th>13</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>10015.0000000000</td>
      <td>2</td>
      <td>2.0000000000</td>
      <td>99.8305084746</td>
    </tr>
    <tr>
      <th>14</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>5.0000000000</td>
      <td>3</td>
      <td>2.0000000000</td>
      <td>14.4224279411</td>
    </tr>
    <tr>
      <th>15</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>101</td>
      <td>2.0000000000</td>
      <td>0.0553615594</td>
    </tr>
    <tr>
      <th>16</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>20013.0000000000</td>
      <td>2</td>
      <td>2.0000000000</td>
      <td>1.9000000000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>9.0000000000</td>
      <td>2</td>
      <td>2.0000000000</td>
      <td>9.5583787054</td>
    </tr>
    <tr>
      <th>18</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>20014.0000000000</td>
      <td>107</td>
      <td>3.0000000000</td>
      <td>0.0753504739</td>
    </tr>
    <tr>
      <th>19</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>6.0000000000</td>
      <td>1132</td>
      <td>3.0000000000</td>
      <td>0.0033927776</td>
    </tr>
    <tr>
      <th>20</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>90</td>
      <td>3.0000000000</td>
      <td>0.1607451480</td>
    </tr>
    <tr>
      <th>21</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>20014.0000000000</td>
      <td>68</td>
      <td>3.0000000000</td>
      <td>0.1146895059</td>
    </tr>
    <tr>
      <th>22</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>20013.0000000000</td>
      <td>4</td>
      <td>4.0000000000</td>
      <td>1.8074445240</td>
    </tr>
    <tr>
      <th>23</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>4.0000000000</td>
      <td>838</td>
      <td>4.0000000000</td>
      <td>0.1648535642</td>
    </tr>
    <tr>
      <th>24</th>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>34</td>
      <td>4.0000000000</td>
      <td>0.6178659368</td>
    </tr>
    <tr>
      <th>25</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>10.0000000000</td>
      <td>5</td>
      <td>5.0000000000</td>
      <td>4.4132790663</td>
    </tr>
    <tr>
      <th>26</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>4.0000000000</td>
      <td>359</td>
      <td>5.0000000000</td>
      <td>2.1766331651</td>
    </tr>
    <tr>
      <th>27</th>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>11.0000000000</td>
      <td>5</td>
      <td>5.0000000000</td>
      <td>5.6787538466</td>
    </tr>
    <tr>
      <th>28</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>4.0000000000</td>
      <td>966</td>
      <td>5.0000000000</td>
      <td>0.9737230097</td>
    </tr>
    <tr>
      <th>29</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>4.0000000000</td>
      <td>1375</td>
      <td>5.0000000000</td>
      <td>0.1742538029</td>
    </tr>
    <tr>
      <th>30</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>10.0000000000</td>
      <td>6</td>
      <td>6.0000000000</td>
      <td>5.6299484008</td>
    </tr>
    <tr>
      <th>31</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>49</td>
      <td>8.0000000000</td>
      <td>0.7047541745</td>
    </tr>
    <tr>
      <th>32</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>165</td>
      <td>8.0000000000</td>
      <td>0.1492591319</td>
    </tr>
    <tr>
      <th>33</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>20013.0000000000</td>
      <td>8</td>
      <td>8.0000000000</td>
      <td>8.1488736533</td>
    </tr>
    <tr>
      <th>34</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>10.0000000000</td>
      <td>9</td>
      <td>9.0000000000</td>
      <td>4.8535628983</td>
    </tr>
    <tr>
      <th>35</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>2.0000000000</td>
      <td>18</td>
      <td>9.0000000000</td>
      <td>9.3583112923</td>
    </tr>
    <tr>
      <th>36</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>20014.0000000000</td>
      <td>199</td>
      <td>11.0000000000</td>
      <td>0.2989058502</td>
    </tr>
    <tr>
      <th>37</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>5.0000000000</td>
      <td>17</td>
      <td>11.0000000000</td>
      <td>12.3944512335</td>
    </tr>
    <tr>
      <th>38</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>9.0000000000</td>
      <td>11</td>
      <td>11.0000000000</td>
      <td>20.7667347675</td>
    </tr>
    <tr>
      <th>39</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>10015.0000000000</td>
      <td>11</td>
      <td>11.0000000000</td>
      <td>99.7764227642</td>
    </tr>
    <tr>
      <th>40</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>5.0000000000</td>
      <td>15</td>
      <td>13.0000000000</td>
      <td>20.0105370515</td>
    </tr>
    <tr>
      <th>41</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>5.0000000000</td>
      <td>14</td>
      <td>13.0000000000</td>
      <td>8.7873051180</td>
    </tr>
    <tr>
      <th>42</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>10.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>2.5288341646</td>
    </tr>
    <tr>
      <th>43</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>10012.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>3.6629645451</td>
    </tr>
    <tr>
      <th>44</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>10012.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>3.5352481628</td>
    </tr>
    <tr>
      <th>45</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>9.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>14.8440579572</td>
    </tr>
    <tr>
      <th>46</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>2.0000000000</td>
      <td>52</td>
      <td>14.0000000000</td>
      <td>2.9033441981</td>
    </tr>
    <tr>
      <th>47</th>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>0.0000000000</td>
      <td>286</td>
      <td>15.0000000000</td>
      <td>0.2457638080</td>
    </tr>
    <tr>
      <th>48</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>6.0000000000</td>
      <td>1176</td>
      <td>16.0000000000</td>
      <td>0.1742201137</td>
    </tr>
    <tr>
      <th>49</th>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>10015.0000000000</td>
      <td>17</td>
      <td>17.0000000000</td>
      <td>99.4443041172</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide_coupon_receive_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select t1.*, t2.ç”¨æˆ·ä»·å€¼æ—ç¾¤ from user_coupon_receive t1</span>
<span class="s1">left join user_RFM t2 on t1.User_id = t2.ç”¨æˆ·ID</span>
<span class="s1">where coupon_id is not null                                  </span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        ç”¨æˆ·ä»·å€¼æ—ç¾¤, </span>
<span class="s1">        count(*) as é¢†åˆ¸æ¬¡æ•°, </span>
<span class="s1">        sum(Price_limit) as ä¼˜æƒ åˆ¸é—¨æ§›,</span>
<span class="s1">        ä¼˜æƒ åˆ¸é—¨æ§› / é¢†åˆ¸æ¬¡æ•° as äººå‡é—¨æ§›</span>
<span class="s1">from wide_coupon_receive_df</span>
<span class="s1">group by 1</span>
<span class="s1">order by äººå‡é—¨æ§› desc</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
      <th>é¢†åˆ¸æ¬¡æ•°</th>
      <th>ä¼˜æƒ åˆ¸é—¨æ§›</th>
      <th>äººå‡é—¨æ§›</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
      <td>28095</td>
      <td>1977254.2400000002</td>
      <td>70.3774422495</td>
    </tr>
    <tr>
      <th>1</th>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
      <td>59412</td>
      <td>4150307.9600000009</td>
      <td>69.8563919747</td>
    </tr>
    <tr>
      <th>2</th>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
      <td>27938</td>
      <td>1874132.2400000002</td>
      <td>67.0818326294</td>
    </tr>
    <tr>
      <th>3</th>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
      <td>134340</td>
      <td>8655225.5100000054</td>
      <td>64.4277617240</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ä¸å­˜åœ¨æ¶ˆè´¹è®°å½•çš„ç”¨æˆ·</td>
      <td>32388</td>
      <td>1844636.7600000005</td>
      <td>56.9543275287</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
      <td>136510</td>
      <td>6722328.8800000055</td>
      <td>49.2442229873</td>
    </tr>
    <tr>
      <th>6</th>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
      <td>470007</td>
      <td>21924276.4899999797</td>
      <td>46.6467020491</td>
    </tr>
    <tr>
      <th>7</th>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
      <td>355740</td>
      <td>15531050.5200000033</td>
      <td>43.6584317760</td>
    </tr>
    <tr>
      <th>8</th>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>934956</td>
      <td>40790025.7799998894</td>
      <td>43.6277490919</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id35">
<h1>ä¼˜æƒ åˆ¸RFM<a class="headerlink" href="#id35" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select a1.cnt * 100 /a2.cnt as å æ¯” , a1.ç”¨æˆ·ä»·å€¼æ—ç¾¤, COALESCE(a1.Coupon_type::STRING, &#39;UnKnown&#39;) as Coupon_type</span>
<span class="s1">from</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, ç”¨æˆ·ä»·å€¼æ—ç¾¤, Coupon_type from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2,3</span>
<span class="s1">) a1 join</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, ç”¨æˆ·ä»·å€¼æ—ç¾¤ from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2</span>
<span class="s1">) a2 using(ç”¨æˆ·ä»·å€¼æ—ç¾¤)</span>
<span class="s1">order by ç”¨æˆ·ä»·å€¼æ—ç¾¤,å æ¯”	DESC</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶åˆ†å¸ƒå›¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result_df</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®å›¾è¡¨æ ‡é¢˜å’Œæ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤ä¸Coupon_typeå æ¯”åˆ†å¸ƒ&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;å æ¯” (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># æ—‹è½¬xè½´æ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3bac56e44f4e47e21058a321931782a49e4b77933e11180ff103632ba112c66d.png" src="_images/3bac56e44f4e47e21058a321931782a49e4b77933e11180ff103632ba112c66d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select a1.cnt * 100 /a2.cnt as å æ¯” , a1.ç”¨æˆ·ä»·å€¼æ—ç¾¤, COALESCE(a1.Coupon_type::STRING, &#39;UnKnown&#39;) as Coupon_type</span>
<span class="s1">from</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, ç”¨æˆ·ä»·å€¼æ—ç¾¤, ä¼˜æƒ åˆ¸ç±»åˆ«	 as Coupon_type from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2,3</span>
<span class="s1">) a1 join</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, ç”¨æˆ·ä»·å€¼æ—ç¾¤ from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2</span>
<span class="s1">) a2 using(ç”¨æˆ·ä»·å€¼æ—ç¾¤)</span>
<span class="s1">order by ç”¨æˆ·ä»·å€¼æ—ç¾¤,å æ¯”	DESC</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="c1"># ç»˜åˆ¶åˆ†å¸ƒå›¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result_df</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>

<span class="c1"># è®¾ç½®å›¾è¡¨æ ‡é¢˜å’Œæ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤ä¸ä¼˜æƒ åˆ¸ç±»åˆ«	å æ¯”åˆ†å¸ƒ&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;å æ¯” (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># æ—‹è½¬xè½´æ ‡ç­¾</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/t6/xmvwdhg96gsfj8tw02j7mgmr0000gn/T/ipykernel_74226/3574943240.py:26: UserWarning:

Glyph 9 (	) missing from font(s) SimHei.

/Users/liangkaixin/Documents/Notes/å•†ä¸šåˆ†æ/.venv/lib/python3.10/site-packages/IPython/core/pylabtools.py:170: UserWarning:

Glyph 9 (	) missing from font(s) SimHei.
</pre></div>
</div>
<img alt="_images/9f8b80561ca5fd778b50123162e1751c0c929ccaa38981d4f1cc0845b7fc5cf3.png" src="_images/9f8b80561ca5fd778b50123162e1751c0c929ccaa38981d4f1cc0845b7fc5cf3.png" />
</div>
</div>
<section id="id36">
<h2>ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹å æ¯”<a class="headerlink" href="#id36" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_data</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_type&#39;</span><span class="p">])[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># è®¾ç½®ç”»å¸ƒå¤§å°</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># è·å–æ¯ä¸ªç”¨æˆ·ä»·å€¼æ—ç¾¤çš„ç‹¬ç‰¹å€¼</span>
<span class="n">user_groups</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FFFACD&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFEB3B&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFDD44&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFB300&#39;</span><span class="p">,</span> <span class="s1">&#39;#F4A300&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFFF00&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFD85C&#39;</span><span class="p">]</span>
<span class="n">unique_coupon_types</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># [&#39;#FFD500&#39;, &#39;#ffc000&#39;, &#39;#ffab00&#39;, &#39;#ff9500&#39;, &#39;#ff8000&#39;, &#39;#ff6b00&#39;]</span>

<span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;UnKnown&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>  <span class="c1"># æµ…ç°è‰²ï¼ˆæœªçŸ¥ï¼‰</span>
    <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#fff6d6&#39;</span><span class="p">,</span>  <span class="c1"># æµ…é»„è‰²</span>
    <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffeead&#39;</span><span class="p">,</span>  <span class="c1"># ä¸­ç­‰é»„è‰²</span>
    <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffe682&#39;</span><span class="p">,</span>  <span class="c1"># äº®é»„è‰²</span>
    <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span>  <span class="c1"># é‡‘è‰²</span>
    <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFBA66&#39;</span><span class="p">,</span>  <span class="c1"># æ·±é‡‘è‰²</span>
    <span class="s1">&#39;é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF8C00&#39;</span><span class="p">,</span>  <span class="c1"># æ©™é»„è‰²</span>
    <span class="s1">&#39;é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#CC7000&#39;</span><span class="p">,</span>  <span class="c1"># æ·±æ©™è‰²</span>
<span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># å¾ªç¯ç»˜åˆ¶æ¯ä¸ªç”¨æˆ·ä»·å€¼æ—ç¾¤çš„é¥¼å›¾</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_groups</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># è®¾ç½®æ¯ä¸ªé¥¼å›¾çš„ä½ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾æœ‰8ä¸ªæ—ç¾¤</span>
    <span class="n">group_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
    <span class="n">explode</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">]]</span>  <span class="c1"># å¦‚æœå æ¯”å°äº1%å°±çˆ†å¼€</span>

    <span class="c1"># è·å–é¢œè‰²åˆ—è¡¨</span>
    <span class="n">colors_for_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]]</span>

    <span class="c1"># ç”»é¥¼å›¾ï¼Œä¸æ˜¾ç¤ºç™¾åˆ†æ¯”</span>
    <span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">],</span> 
                            <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span>  <span class="c1"># è®¾ç½®é¥¼å›¾çš„èµ·å§‹è§’åº¦</span>
                            <span class="n">colors</span><span class="o">=</span><span class="n">colors_for_group</span><span class="p">,</span>  <span class="c1"># æ›´æŸ”å’Œçš„è‰²å½©</span>
                            <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">},</span>  <span class="c1"># æ·»åŠ é»‘è‰²è¾¹æ¡†</span>
                            <span class="n">explode</span> <span class="o">=</span> <span class="n">explode</span><span class="p">,</span>
                            <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># æ·»åŠ é˜´å½±æ•ˆæœ</span>
    
    <span class="c1"># è®¾ç½®æ ‡é¢˜</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># ä¿®æ”¹æ–‡æœ¬æ ‡ç­¾æ ·å¼</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  <span class="c1"># é»‘è‰²åŠ ç²—çš„æ ‡ç­¾</span>

<span class="c1"># è®¾ç½®ç±»åˆ«æ˜¾ç¤ºåœ¨å³ä¾§</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">wedges</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Coupon Type&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># è®¾ç½®æ•´ä½“å¸ƒå±€</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6b26da304d8598360bef0d560f58fe5f47234e1e7fd0cdb514a55e14bba8ed51.png" src="_images/6b26da304d8598360bef0d560f58fe5f47234e1e7fd0cdb514a55e14bba8ed51.png" />
</div>
</div>
<p>ä½¿ç”¨é»„è‰²ç³»çš„é¢œè‰²æ¥è¡¨ç¤ºä¸åŒçš„ä¼˜æƒ åˆ¸ç±»å‹ï¼Œå¹¶ä¸”é‡è¦æ€§è¶Šé«˜ï¼Œé¢œè‰²è¶Šæ·±ï¼Œä¸ºæ¯ç§ä¼˜æƒ åˆ¸ç±»å‹é€‰æ‹©ä¸åŒçš„é»„è‰²æˆ–é‡‘è‰²ç³»æ¸å˜é¢œè‰²ã€‚</p>
</section>
<section id="top1unkown">
<h2>ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹å æ¯”(å»é™¤top1å’ŒUnkown)<a class="headerlink" href="#top1unkown" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_data</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select a1.cnt * 100 /a2.cnt as å æ¯” , a1.ç”¨æˆ·ä»·å€¼æ—ç¾¤, COALESCE(a1.Coupon_type::STRING, &#39;UnKnown&#39;) as Coupon_type</span>
<span class="s1">from</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, ç”¨æˆ·ä»·å€¼æ—ç¾¤, ä¼˜æƒ åˆ¸ç±»åˆ«	 as Coupon_type from wide_df</span>
<span class="s1">    where coupon_id is not null and ä¼˜æƒ åˆ¸ç±»åˆ« is not null</span>
<span class="s1">    group by 2,3</span>
<span class="s1">) a1 join</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, ç”¨æˆ·ä»·å€¼æ—ç¾¤ from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2</span>
<span class="s1">) a2 using(ç”¨æˆ·ä»·å€¼æ—ç¾¤)</span>
<span class="s1">order by ç”¨æˆ·ä»·å€¼æ—ç¾¤,å æ¯”	DESC         </span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_type&#39;</span><span class="p">])[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1"># è®¾ç½®ç”»å¸ƒå¤§å°</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># è·å–æ¯ä¸ªç”¨æˆ·ä»·å€¼æ—ç¾¤çš„ç‹¬ç‰¹å€¼</span>
<span class="n">user_groups</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>


<span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;UnKnown&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>  <span class="c1"># æµ…ç°è‰²ï¼ˆæœªçŸ¥ï¼‰</span>
    <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#fff6d6&#39;</span><span class="p">,</span>  <span class="c1"># æµ…é»„è‰²</span>
    <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffeead&#39;</span><span class="p">,</span>  <span class="c1"># ä¸­ç­‰é»„è‰²</span>
    <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffe682&#39;</span><span class="p">,</span>  <span class="c1"># äº®é»„è‰²</span>
    <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span>  <span class="c1"># é‡‘è‰²</span>
    <span class="s1">&#39;ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFBA66&#39;</span><span class="p">,</span>  <span class="c1"># æ·±é‡‘è‰²</span>
    <span class="s1">&#39;é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF8C00&#39;</span><span class="p">,</span>  <span class="c1"># æ©™é»„è‰²</span>
    <span class="s1">&#39;é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span> <span class="s1">&#39;#CC7000&#39;</span><span class="p">,</span>  <span class="c1"># æ·±æ©™è‰²</span>
<span class="p">}</span>

<span class="n">display</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">[</span><span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6.0&#39;</span><span class="p">])</span>

<span class="c1"># è‡ªå®šä¹‰autopctå‡½æ•°</span>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_autopct</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span>  <span class="c1"># ä»…åœ¨ Coupon_type == 6.0 æ—¶æ˜¾ç¤º</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>



<span class="c1"># å¾ªç¯ç»˜åˆ¶æ¯ä¸ªç”¨æˆ·ä»·å€¼æ—ç¾¤çš„é¥¼å›¾</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_groups</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># è®¾ç½®æ¯ä¸ªé¥¼å›¾çš„ä½ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾æœ‰8ä¸ªæ—ç¾¤</span>
    <span class="n">group_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
    <span class="n">explode</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">]]</span>  <span class="c1"># å¦‚æœå æ¯”å°äº1%å°±çˆ†å¼€</span>

    <span class="c1"># è·å–é¢œè‰²åˆ—è¡¨</span>
    <span class="n">colors_for_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]]</span>


    <span class="c1"># ç”»é¥¼å›¾ï¼Œä¸æ˜¾ç¤ºç™¾åˆ†æ¯”</span>
    <span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">],</span> 
                            <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span>  <span class="c1"># è®¾ç½®é¥¼å›¾çš„èµ·å§‹è§’åº¦</span>
                            <span class="n">colors</span><span class="o">=</span><span class="n">colors_for_group</span><span class="p">,</span>  <span class="c1"># æ›´æŸ”å’Œçš„è‰²å½©</span>
                            <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">},</span>  <span class="c1"># æ·»åŠ é»‘è‰²è¾¹æ¡†</span>
                            <span class="n">explode</span> <span class="o">=</span> <span class="n">explode</span><span class="p">,</span>
                            <span class="n">autopct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pct</span><span class="p">:</span> <span class="n">custom_autopct</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;å æ¯”&#39;</span><span class="p">],</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]),</span>
                            <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># æ·»åŠ é˜´å½±æ•ˆæœ</span>
    
    <span class="c1"># è®¾ç½®æ ‡é¢˜</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># ä¿®æ”¹æ–‡æœ¬æ ‡ç­¾æ ·å¼</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># é»‘è‰²åŠ ç²—çš„æ ‡ç­¾</span>

    <span class="k">for</span> <span class="n">autotext</span><span class="p">,</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">autotexts</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">!=</span> <span class="s1">&#39;ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸&#39;</span><span class="p">:</span>
            <span class="n">autotext</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># éšè—é 6.0 çš„ç™¾åˆ†æ¯”</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">autotext</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>


<span class="c1"># è®¾ç½®ç±»åˆ«æ˜¾ç¤ºåœ¨å³ä¾§</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">wedges</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Coupon Type&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># è®¾ç½®æ•´ä½“å¸ƒå±€</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
      <th>Coupon_type</th>
      <th>å æ¯”</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div><img alt="_images/18637d61ca14c57cda8629b960f62d1da6f33f1614b74ec84ecaad74dbc37cd7.png" src="_images/18637d61ca14c57cda8629b960f62d1da6f33f1614b74ec84ecaad74dbc37cd7.png" />
</div>
</div>
</section>
<section id="id37">
<h2>ç»“è®º<a class="headerlink" href="#id37" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>ä¸­æ¯”ä¾‹ä½ä»·ä¼˜æƒ åˆ¸ï¼Œå‘æ”¾æœ€å¤šï¼Œæˆ‘è®¤ä¸ºæ˜¯ä¿ƒæ´»ç”¨çš„ã€‚<br />
å› ä¸ºå®ƒåœ¨æ´»è·ƒåº¦è¾ƒé«˜çš„ä¸€èˆ¬ä»·å€¼å®¢æˆ·ä¸­ï¼Œå æ¯”ä¹Ÿæ˜¯æœ€å¤§çš„</p></li>
<li><p>ä½æ¯”ä¾‹ä½ä»·å€¼ä¼˜æƒ åˆ¸ä¼šå¯¼è‡´å¤è´­ç‡é™ä½ï¼Œç”šè‡³å¯¼è‡´å®¢æˆ·æµå¤±ã€‚å¤è´­ä½çš„äººç¾¤ï¼Œå¾€å¾€æ˜¯ä½¿ç”¨æ­¤ç±»ä¼˜æƒ åˆ¸è¾ƒå¤šçš„äººç¾¤ã€‚</p></li>
</ol>
<p>ç­–ç•¥ï¼š
ä¿ƒæ´»å¯ä»¥å¤šå‘æ”¾ä¸­æ¯”ä¾‹ä½ä»·ä¼˜æƒ åˆ¸ï¼›é™ä½æµå¤±ç‡ï¼Œåº”è¯¥å‡å°‘é™ä½æ— æ•ˆåˆ¸æŠ•æ”¾</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id38">
<h1>é£æ§<a class="headerlink" href="#id38" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">with t1 AS</span>
<span class="s2">(</span>
<span class="s2">    select count(*) as é¢†åˆ¸æ€»æ•°,User_id AS ç”¨æˆ·ID, Receive_date from user_coupon_receive</span>
<span class="s2">           WHERE Coupon_id IS NOT NULL</span>
<span class="s2">           group by 2, 3</span>
<span class="s2">)</span>
<span class="s2">SELECT * FROM t1 LEFT JOIN user_RFM USING(ç”¨æˆ·ID)</span>
<span class="s2">WHERE Receive_date IS NOT NULL</span>
<span class="s2">order by é¢†åˆ¸æ€»æ•° DESC</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>é¢†åˆ¸æ€»æ•°</th>
      <th>ç”¨æˆ·ID</th>
      <th>Receive_date</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>50</td>
      <td>64f7f49aa3a6f2d3bdf579dc20f5ee7b</td>
      <td>2023-05-19</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50</td>
      <td>135b607fa436226daf62b1cbf777c917</td>
      <td>2023-01-16</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>2</th>
      <td>45</td>
      <td>135b607fa436226daf62b1cbf777c917</td>
      <td>2023-05-27</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>3</th>
      <td>42</td>
      <td>02b1727ae62d6484c3bce3b666242ead</td>
      <td>2023-03-01</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>4</th>
      <td>40</td>
      <td>3c9e89409f0884ec9e905c40323230a4</td>
      <td>2023-04-15</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>5</th>
      <td>37</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-11</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>6</th>
      <td>36</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-01-20</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>7</th>
      <td>34</td>
      <td>da4a52ebccf7f143e38876c966b1ff38</td>
      <td>2023-05-12</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>8</th>
      <td>34</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-03-18</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>9</th>
      <td>34</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-15</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>10</th>
      <td>31</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-12</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>11</th>
      <td>30</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-03-14</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>12</th>
      <td>30</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-16</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>13</th>
      <td>30</td>
      <td>8d7c90fa30a96097c5737ecafe4e57db</td>
      <td>2023-03-25</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>14</th>
      <td>30</td>
      <td>ff64a6c6c5790b859c1e97249f36c0ba</td>
      <td>2023-02-25</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>15</th>
      <td>30</td>
      <td>7ecc2f8801ba553a8f9bd7dddd451104</td>
      <td>2023-03-02</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>16</th>
      <td>29</td>
      <td>9672b53f7f3eb658c50707c4956a0e2f</td>
      <td>2023-02-01</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>17</th>
      <td>29</td>
      <td>7ecc2f8801ba553a8f9bd7dddd451104</td>
      <td>2023-04-15</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>18</th>
      <td>29</td>
      <td>a2fde3de810b2a1f6e2adb9f6f1c0e23</td>
      <td>2023-01-01</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>19</th>
      <td>28</td>
      <td>25820554dbcb7f9ccecf8a2a8d37dc6b</td>
      <td>2023-06-27</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>20</th>
      <td>28</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-17</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>21</th>
      <td>27</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-19</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>22</th>
      <td>26</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-14</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>23</th>
      <td>26</td>
      <td>9fa9ac51e71c8c059e04f274d5bd6efc</td>
      <td>2023-04-11</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>24</th>
      <td>26</td>
      <td>bd089a2eb4fe30f3c645ec0e0c058631</td>
      <td>2023-03-18</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>25</th>
      <td>25</td>
      <td>e683073f2f24ab8e307fbc3138416393</td>
      <td>2023-02-27</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>26</th>
      <td>25</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-01-31</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>27</th>
      <td>24</td>
      <td>a256356289a2cf4edd3b0324baed4af5</td>
      <td>2023-05-28</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>28</th>
      <td>24</td>
      <td>386ae42393c05364eb5ce86c62f6453e</td>
      <td>2023-02-12</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>29</th>
      <td>24</td>
      <td>5d22212c8e0f5a9d037a889bf5736920</td>
      <td>2023-05-14</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>30</th>
      <td>24</td>
      <td>a132a4442bb94ceeee4fb152cce9114a</td>
      <td>2023-04-29</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>31</th>
      <td>24</td>
      <td>da4a52ebccf7f143e38876c966b1ff38</td>
      <td>2023-02-17</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>32</th>
      <td>23</td>
      <td>1b4b18d638b91be57261530cced8310c</td>
      <td>2023-01-07</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>33</th>
      <td>23</td>
      <td>8ac16d0d02600988ae6c33ea5f4b99cd</td>
      <td>2023-05-18</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>34</th>
      <td>23</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-03-09</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>35</th>
      <td>22</td>
      <td>1cf1420b93c1057f0bf545fb69a3dd2e</td>
      <td>2023-06-02</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>36</th>
      <td>22</td>
      <td>6e0dd657a906a6e72c3dab7993cc711a</td>
      <td>2023-04-01</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>37</th>
      <td>22</td>
      <td>c7d5e76428b24a9f05498ec8497e95c4</td>
      <td>2023-04-14</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>38</th>
      <td>22</td>
      <td>6b182b745c1de380287c392e2c18e59a</td>
      <td>2023-01-13</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>39</th>
      <td>22</td>
      <td>950cdda64940171d81ed541e87d6cc6b</td>
      <td>2023-03-29</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>40</th>
      <td>21</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-18</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>41</th>
      <td>21</td>
      <td>c5e87601fa9bcb3bf0b11895f743b0eb</td>
      <td>2023-01-28</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>42</th>
      <td>21</td>
      <td>203059efeae080497a881e1d5d88d378</td>
      <td>2023-01-07</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>43</th>
      <td>21</td>
      <td>0c1a17aed80a169a0c0d3bb80b17fd2e</td>
      <td>2023-03-03</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <th>44</th>
      <td>20</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-06-15</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>45</th>
      <td>20</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-02-06</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <th>46</th>
      <td>20</td>
      <td>f014d8b4e73de415465ba0eefdaa7793</td>
      <td>2023-04-09</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <th>47</th>
      <td>20</td>
      <td>d3b489224bd01e3c0eaf131b48500602</td>
      <td>2023-03-01</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>48</th>
      <td>20</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-02-19</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <th>49</th>
      <td>20</td>
      <td>8ac16d0d02600988ae6c33ea5f4b99cd</td>
      <td>2023-06-21</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select sum(Reduce_amount) as æ€»ä¼˜æƒ , sum(Actual_pay) as æ€»æ”¯å‡º, User_id  from order_detail</span>
<span class="s2">       WHERE Coupon_id IS NOT NULL </span>
<span class="s2">       AND User_id in (&#39;8ebe6816c6b51ad2c3afed2812a053b5&#39;, &#39;b083832263c1b4225990438b03056786&#39;, &#39;bc326638e3ef950e4377b0113afeab3c&#39;)</span>
<span class="s2">       group by 3</span>
<span class="s2">       -- order by cnt DESC</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>æ€»ä¼˜æƒ </th>
      <th>æ€»æ”¯å‡º</th>
      <th>User_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>458.0000000000</td>
      <td>5513.2000000000</td>
      <td>bc326638e3ef950e4377b0113afeab3c</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8.0000000000</td>
      <td>23.8000000000</td>
      <td>b083832263c1b4225990438b03056786</td>
    </tr>
    <tr>
      <th>2</th>
      <td>615.5000000000</td>
      <td>7269.9300000000</td>
      <td>8ebe6816c6b51ad2c3afed2812a053b5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select *  from order_detail</span>
<span class="s2">       WHERE User_id in (&#39;b083832263c1b4225990438b03056786&#39;)</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Shop_id</th>
      <th>Order_id</th>
      <th>Coupon_id</th>
      <th>Coupon_type</th>
      <th>Biz_code</th>
      <th>Pay_date</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>b96db70b506332a7a4f44c156cb4ca1b</td>
      <td>56d7a4c731ab3923c4ff3007b21fc662</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-06-16</td>
      <td>26.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>b96db70b506332a7a4f44c156cb4ca1b</td>
      <td>ea2da07a9a424042b9594caad4918f90</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-06-13</td>
      <td>21.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>74ffd5ce40ba21c957ddb90b0e6f3f1a</td>
      <td>c5a3728a57b6c6261a8446b1df2e94f1</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-06-27</td>
      <td>24.2800000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>6791fffb08d1b564733985c881280191</td>
      <td>020f2f6488f87d4039e5d9fb97fc0533</td>
      <td>df8e3a90599dd80c9d69d5533d472560</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-04-19</td>
      <td>23.8000000000</td>
      <td>8.0000000000</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>6791fffb08d1b564733985c881280191</td>
      <td>020f2f6488f87d4039e5d9fb97fc0533</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-04-19</td>
      <td>23.8000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cheats_user</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select User_id, Receive_date::Date AS Receive_date from user_coupon_receive</span>
<span class="s2">WHERE User_id in (&#39;b083832263c1b4225990438b03056786&#39;)</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ç»Ÿè®¡æ¯ä¸ª Receive_date çš„å‡ºç°æ¬¡æ•°</span>
<span class="n">date_counts</span> <span class="o">=</span> <span class="n">cheats_user</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">date_counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">]</span>

<span class="c1"># åˆ›å»ºä¸€ä¸ªäº¤äº’å¼æ•£ç‚¹å›¾</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">date_counts</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> 
                 <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">:</span> <span class="s1">&#39;Receive Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">},</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ç”¨æˆ·b083832263c1b4225990438b03056786çš„é¢†åˆ¸è®°å½•&quot;</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºç‚¹çš„åæ ‡</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">),</span>
                  <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Date: %</span><span class="si">{x}</span><span class="s1">&lt;br&gt;Count: %</span><span class="si">{y}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºå›¾è¡¨</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id39">
<h1>æ¨¡å‹<a class="headerlink" href="#id39" title="Link to this heading">#</a></h1>
<section id="part-1">
<h2>Part 1 æ¦‚è¿°<a class="headerlink" href="#part-1" title="Link to this heading">#</a></h2>
<section id="id40">
<h3>æ ‡ç­¾<a class="headerlink" href="#id40" title="Link to this heading">#</a></h3>
<p>ç”¨æˆ·æ˜¯å¦ä¼šå¤è´­</p>
</section>
<section id="id41">
<h3>ä¼˜æƒ åˆ¸ç‰¹å¾<a class="headerlink" href="#id41" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>è¢«ä½¿ç”¨æ¬¡æ•°</p></li>
<li><p>è¢«ä½¿ç”¨é‡‘é¢</p></li>
<li><p>ä¼˜æƒ é‡‘é¢</p></li>
<li><p>ä¼˜æƒ é‡‘é¢å æ¯”</p></li>
<li><p>ä¼˜æƒ åˆ¸ç±»å‹</p></li>
<li><p>ä¼˜æƒ åˆ¸å¤è´­ç‡</p></li>
</ol>
</section>
<section id="id42">
<h3>ç”¨æˆ·ç‰¹å¾<a class="headerlink" href="#id42" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸æ¬¡æ•°</p></li>
<li><p>ç”¨æˆ·è·å¾—ä¼˜æƒ åˆ¸ä½†æ²¡æœ‰æ¶ˆè´¹çš„æ¬¡æ•°</p></li>
<li><p>ç”¨æˆ·è·å¾—ä¼˜æƒ åˆ¸å¹¶æ ¸é”€æ¬¡æ•°</p></li>
<li><p>å¤è´­ç‡</p></li>
<li><p>å¤è´­å‘¨æœŸ</p></li>
<li><p>ç”¨æˆ·ç¾¤ä½“ç±»å‹</p></li>
<li><p>æ³¨å†Œæ—¶é•¿</p></li>
</ol>
</section>
</section>
<section id="part-2">
<h2>Part 2 æ ‡ç­¾æ„å»º<a class="headerlink" href="#part-2" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    select</span>
<span class="s2">        *exclude(Pay_date),</span>
<span class="s2">        Pay_date::date as Pay_date,</span>
<span class="s2">        ä¼˜æƒ åˆ¸ç±»åˆ«,</span>
<span class="s2">        ç”¨æˆ·ä»·å€¼æ—ç¾¤,</span>
<span class="s2">        lead(ä¼˜æƒ åˆ¸ç±»åˆ«) over (partition by User_id order by Pay_date::date) as next_ä¼˜æƒ åˆ¸ç±»åˆ«,</span>
<span class="s2">        lead(Coupon_id) over (partition by User_id order by Pay_date::date) as next_coupon_id,</span>
<span class="s2">        lead(Coupon_type) over (partition by User_id order by Pay_date::date) as next_Coupon_type,</span>
<span class="s2">        case when next_coupon_id is not null then 1 else 0 end as æ˜¯å¦å¤è´­</span>
<span class="s2">    from wide_df</span>
<span class="s2">;</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">train_data</span>  <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="c1"># è‡ªå®šä¹‰åˆ—æ•°</span>
<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># æƒ³åˆ†å‡ åˆ—å°±æ”¹è¿™é‡Œ</span>

<span class="c1"># è·å–æŸ¥è¯¢ç»“æœ</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    select round(sum(æ˜¯å¦å¤è´­) * 100 / count(*), 2)::FLOAT as å¤è´­ç‡, </span>
<span class="s2">           Coupon_type::INT as Coupon_type, </span>
<span class="s2">           ä¼˜æƒ åˆ¸ç±»åˆ«, </span>
<span class="s2">           ç”¨æˆ·ä»·å€¼æ—ç¾¤</span>
<span class="s2">    from train_data    </span>
<span class="s2">    where Coupon_type is not null      </span>
<span class="s2">    group by 2, 3, 4      </span>
<span class="s2">    order by Coupon_type, å¤è´­ç‡, ç”¨æˆ·ä»·å€¼æ—ç¾¤ desc                   </span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># è®¡ç®—æ¯åˆ—çš„è¡Œæ•°</span>
<span class="n">rows_per_col</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>

<span class="c1"># æ‹†åˆ†ä¸ºå¤šä¸ªå­ DataFrame</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">rows_per_col</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows_per_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)]</span>

<span class="c1"># è½¬æˆ HTML</span>
<span class="n">htmls</span> <span class="o">=</span> <span class="p">[</span><span class="n">subdf</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">subdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>

<span class="c1"># æ‹¼æ¥æˆæ¨ªå‘å±•ç¤ºçš„ HTML</span>
<span class="n">html_output</span> <span class="o">=</span> <span class="s1">&#39;&lt;div style=&quot;display: flex; gap: 10px;&quot;&gt;&#39;</span>
<span class="k">for</span> <span class="n">html</span> <span class="ow">in</span> <span class="n">htmls</span><span class="p">:</span>
    <span class="n">html_output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;div style=&quot;flex: 1;&quot;&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s1">&lt;/div&gt;&#39;</span>
<span class="n">html_output</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span>

<span class="c1"># æ˜¾ç¤º</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_output</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div style="display: flex; gap: 10px;"><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>å¤è´­ç‡</th>
      <th>Coupon_type</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>11.7600002289</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>14.2899999619</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>22.4500007629</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>23.0000000000</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>31.4699993134</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.6599998474</td>
      <td>0</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>23.4500007629</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>23.5699996948</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>23.8199996948</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>23.9699993134</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>30.2099990845</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>31.7900009155</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.6899986267</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>34.4199981689</td>
      <td>1</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>30.9899997711</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>34.2500000000</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>34.6199989319</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>35.8499984741</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>42.2700004578</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>44.4399986267</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>44.5200004578</td>
      <td>2</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>å¤è´­ç‡</th>
      <th>Coupon_type</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>34.2099990845</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>38.8300018311</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>40.3100013733</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>43.6199989319</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>47.2799987793</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>54.2999992371</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>55.3800010681</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>61.0800018311</td>
      <td>3</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>21.3199996948</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>24.2700004578</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>24.3999996185</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>26.4599990845</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>32.2999992371</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>32.7999992371</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>34.4000015259</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>36.2799987793</td>
      <td>4</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>20.0000000000</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>21.4300003052</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>28.5499992371</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>32.4300003052</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>35.2900009155</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>38.2700004578</td>
      <td>5</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>å¤è´­ç‡</th>
      <th>Coupon_type</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>50.6199989319</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>53.2200012207</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>55.8600006104</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>59.3499984741</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>62.3699989319</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>65.5199966431</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>66.3600006104</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>72.9499969482</td>
      <td>6</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>40.6300010681</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>42.8600006104</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>43.7500000000</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>45.4500007629</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>9</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>26.5300006866</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>28.5699996948</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>35.7099990845</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>40.9500007629</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>43.0400009155</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>80.0000000000</td>
      <td>10</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>11</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>å¤è´­ç‡</th>
      <th>Coupon_type</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0.0000000000</td>
      <td>11</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>11</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>40.5900001526</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>51.8699989319</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>56.8499984741</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>57.1399993896</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>69.0500030518</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>70.0899963379</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>75.1699981689</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>76.7799987793</td>
      <td>10010</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>42.8600006104</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>49.4399986267</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>57.1399993896</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>63.1599998474</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>68.8899993896</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>71.4300003052</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>74.4899978638</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>83.7200012207</td>
      <td>10012</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>10015</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>5.8800001144</td>
      <td>10015</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>21.3700008392</td>
      <td>10015</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>29.1700000763</td>
      <td>10015</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>45.4500007629</td>
      <td>10015</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>10015</td>
      <td>é«˜æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>å¤è´­ç‡</th>
      <th>Coupon_type</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>25.0000000000</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>30.2999992371</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>31.6100006104</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>39.6399993896</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>52.7299995422</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>57.1399993896</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>64.7600021362</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>69.0899963379</td>
      <td>20011</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ é«˜ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>40.7400016785</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>45.8300018311</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>64.1500015259</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>87.5000000000</td>
      <td>20013</td>
      <td>ä¸­æ¯”ä¾‹ä¼˜æƒ ä¸­ç­‰ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>44.7200012207</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>49.8300018311</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬æŒ½ç•™å®¢æˆ·</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>51.8100013733</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å‘å±•å®¢æˆ·</td>
    </tr>
    <tr>
      <td>63.5499992371</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>65.5599975586</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬å”¤å›å®¢æˆ·</td>
    </tr>
    <tr>
      <td>66.5400009155</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
    </tr>
    <tr>
      <td>68.5699996948</td>
      <td>20014</td>
      <td>ä½æ¯”ä¾‹ä¼˜æƒ ä½ä»·ä¼˜æƒ åˆ¸</td>
      <td>é‡è¦å”¤å›å®¢æˆ·</td>
    </tr>
  </tbody>
</table></div></div></div></div>
</div>
</section>
<section id="part-3">
<h2>Part 3 ç‰¹å¾å·¥ç¨‹<a class="headerlink" href="#part-3" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Shop_id</th>
      <th>Order_id</th>
      <th>Coupon_id</th>
      <th>Coupon_type</th>
      <th>Biz_code</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤</th>
      <th>Actual_pay_log</th>
      <th>Reduce_amount_log</th>
      <th>Pay_date</th>
      <th>ä¼˜æƒ åˆ¸ç±»åˆ«_1</th>
      <th>ç”¨æˆ·ä»·å€¼æ—ç¾¤_1</th>
      <th>next_ä¼˜æƒ åˆ¸ç±»åˆ«</th>
      <th>next_coupon_id</th>
      <th>next_Coupon_type</th>
      <th>æ˜¯å¦å¤è´­</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>7550d9c1ef1e3db78ad6a37fa2cd9243</td>
      <td>b7a7240fd7d3ed8ed7e5f15b520a1ce1</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>29.5000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>3.4177266836</td>
      <td>0.0000000000</td>
      <td>2023-04-06</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>2ada2f83375207b727b13c0062476ac4</td>
      <td>e8107199a708ff092071515e3577a9e1</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>29.4000000000</td>
      <td>0.5200000000</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>3.4314032237</td>
      <td>0.4187103349</td>
      <td>2023-04-06</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>0e044139182fcf8efd31986105dde5d5</td>
      <td>d1f6536632f023a097885c015cb5a90b</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>24.0000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>3.2188758249</td>
      <td>0.0000000000</td>
      <td>2023-04-07</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>0e044139182fcf8efd31986105dde5d5</td>
      <td>a00153b3e64e712244722f355b1effc3</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>30.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>3.4626060098</td>
      <td>0.0000000000</td>
      <td>2023-04-08</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>0e044139182fcf8efd31986105dde5d5</td>
      <td>76417c49260f5295bc14f3aadf8a8568</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>30.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>3.4626060098</td>
      <td>0.0000000000</td>
      <td>2023-04-09</td>
      <td>None</td>
      <td>ä¸€èˆ¬ä»·å€¼å®¢æˆ·</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. ç”¨æˆ·å¤è´­ç‡</span>
<span class="c1"># 2. ç”¨æˆ·åœ¨Coupon_typeä¸‹çš„å¤è´­ç‡</span>
<span class="c1"># 3. ç”¨æˆ·æ ¸é”€ç‡</span>
<span class="n">fea</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">train_data.*exclude(Coupon_type),</span>
<span class="s1">train_data.Coupon_type::varchar as Coupon_type,</span>

<span class="s1">              </span>
<span class="s1">count(*) over (partition by train_data.User_id) * 100 / coalesce(ç”¨æˆ·é¢†åˆ¸æ•°, 0)  ç”¨æˆ·æ ¸é”€ç‡,                   </span>
<span class="s1">sum(æ˜¯å¦å¤è´­) over (partition by train_data.User_id, train_data.Coupon_type) * 100 / count(*) over (partition by train_data.User_id, train_data.Coupon_type) as ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„å¤è´­ç‡,</span>
<span class="s1">sum(Reduce_amount) over (partition by train_data.User_id, train_data.Coupon_type) * 100/ sum(Actual_pay + Reduce_amount) over (partition by train_data.User_id, train_data.Coupon_type)  as ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„ä¼˜æƒ å æ¯”,      </span>


<span class="s1">sum(æ˜¯å¦å¤è´­) over (partition by train_data.Coupon_type) * 100  / count(*) over (partition by train_data.Coupon_type) as ä¼˜æƒ åˆ¸å¤è´­ç‡,               </span>
<span class="s1">count(*) over (partition by train_data.Coupon_type) * 100 / coalesce(ä¼˜æƒ åˆ¸å‘æ”¾æ•°, 0)  ä¼˜æƒ åˆ¸æ ¸é”€ç‡,</span>
<span class="s1">sum(Reduce_amount) over (partition by train_data.Coupon_type) * 100/ sum(Actual_pay + Reduce_amount) over (partition by train_data.Coupon_type)  as æ­¤ç±»ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”,</span>
<span class="s1">      </span>
<span class="s1">sum(Reduce_amount) over (partition by train_data.Coupon_id) * 100/ sum(Actual_pay + Reduce_amount) over (partition by train_data.Coupon_id)  as æ­¤ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”                              </span>
<span class="s1">                                                  </span>
<span class="s1">from train_data</span>
<span class="s1">left join(select User_id, count(*) ç”¨æˆ·é¢†åˆ¸æ•° from user_coupon_receive group by 1) t1 on train_data.User_id = t1.User_id                   </span>
<span class="s1">left join(select Coupon_type, count(*) ä¼˜æƒ åˆ¸å‘æ”¾æ•° from user_coupon_receive group by 1) t2 on train_data.Coupon_type = t2.Coupon_type                </span>

<span class="s1">where train_data.Coupon_type is not null         </span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fea</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;User_id&#39;,
 &#39;Shop_id&#39;,
 &#39;Order_id&#39;,
 &#39;Coupon_id&#39;,
 &#39;Biz_code&#39;,
 &#39;Actual_pay&#39;,
 &#39;Reduce_amount&#39;,
 &#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;,
 &#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;,
 &#39;Actual_pay_log&#39;,
 &#39;Reduce_amount_log&#39;,
 &#39;Pay_date&#39;,
 &#39;ä¼˜æƒ åˆ¸ç±»åˆ«_1&#39;,
 &#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤_1&#39;,
 &#39;next_ä¼˜æƒ åˆ¸ç±»åˆ«&#39;,
 &#39;next_coupon_id&#39;,
 &#39;next_Coupon_type&#39;,
 &#39;æ˜¯å¦å¤è´­&#39;,
 &#39;Coupon_type&#39;,
 &#39;ç”¨æˆ·æ ¸é”€ç‡&#39;,
 &#39;ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„å¤è´­ç‡&#39;,
 &#39;ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„ä¼˜æƒ å æ¯”&#39;,
 &#39;ä¼˜æƒ åˆ¸å¤è´­ç‡&#39;,
 &#39;ä¼˜æƒ åˆ¸æ ¸é”€ç‡&#39;,
 &#39;æ­¤ç±»ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”&#39;,
 &#39;æ­¤ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-4">
<h2>Part 4 æ¨¡å‹<a class="headerlink" href="#part-4" title="Link to this heading">#</a></h2>
<p>æˆ‘ä»¬ä¼šç”¨ï¼š</p>
<p>ğŸ“¦ scikit-learn</p>
<p>ğŸ§  æ¨¡å‹ï¼šLogisticRegressionï¼ˆé€»è¾‘å›å½’ï¼Œå¿«é€Ÿå¯è§£é‡Šï¼‰</p>
<p>ğŸ” ç‰¹å¾ï¼šCoupon_type, ä¼˜æƒ åˆ¸ç±»åˆ«, ç”¨æˆ·ä»·å€¼æ—ç¾¤, next_ä¼˜æƒ åˆ¸ç±»åˆ«, next_Coupon_type ç­‰ç­‰</p>
<p>ğŸ§ª åˆ‡åˆ†è®­ç»ƒ / æµ‹è¯•é›†ï¼Œè¯„ä¼°å‡†ç¡®ç‡ã€å¬å›ç‡ç­‰</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">catboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">CatBoostClassifier</span><span class="p">,</span> <span class="n">Pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span>

<span class="c1"># ç‰¹å¾åˆ—ï¼ˆå¯ä»¥åŠ æ›´å¤šä½ è§‰å¾—é‡è¦çš„ï¼‰</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &#39;User_id&#39;,</span>
    <span class="c1"># &#39;Coupon_id&#39;,</span>
    <span class="c1"># &#39;Pay_date&#39;,</span>
    <span class="s1">&#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;,</span>
    <span class="c1"># &#39;next_ä¼˜æƒ åˆ¸ç±»åˆ«&#39;,</span>
    <span class="c1"># &#39;next_coupon_id&#39;,</span>
    <span class="c1"># &#39;next_Coupon_type&#39;,</span>
    <span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ç”¨æˆ·æ ¸é”€ç‡&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„å¤è´­ç‡&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ä¼˜æƒ åˆ¸å¤è´­ç‡&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ä¼˜æƒ åˆ¸æ ¸é”€ç‡&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„ä¼˜æƒ å æ¯”&#39;</span><span class="p">,</span>
    <span class="s1">&#39;æ­¤ç±»ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”&#39;</span><span class="p">,</span>
    <span class="s1">&#39;æ­¤ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”&#39;</span>
 <span class="p">]</span>

<span class="c1"># æ ‡æ˜å“ªäº›æ˜¯ç±»åˆ«ç‰¹å¾ï¼ˆCatBoost å¯ä»¥ç›´æ¥å¤„ç†ï¼‰</span>
<span class="n">cat_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &#39;ç”¨æˆ·ä»·å€¼æ—ç¾¤&#39;,</span>
    <span class="s1">&#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;Coupon_type&#39;</span>
<span class="p">]</span>


<span class="c1"># ä¸¢æ‰ç¼ºå¤±ç›®æ ‡è¡Œï¼ˆæ ‡ç­¾æ²¡ç¼ºä¹ŸOKï¼‰</span>
<span class="n">df_model</span> <span class="o">=</span> <span class="n">fea</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ä¼˜æƒ åˆ¸ç±»åˆ«&#39;</span><span class="p">])</span>

<span class="c1"># ç‰¹å¾ + æ ‡ç­¾</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_model</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_model</span><span class="p">[</span><span class="s1">&#39;æ˜¯å¦å¤è´­&#39;</span><span class="p">]</span>

<span class="c1"># åˆ’åˆ†è®­ç»ƒé›† / æµ‹è¯•é›†</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>



<span class="c1"># å»ºæ¨¡</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CatBoostClassifier</span><span class="p">(</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>

<span class="c1"># æ‹Ÿåˆ</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cat_features</span><span class="o">=</span><span class="n">cat_features</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># é¢„æµ‹</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># è¾“å‡ºç»“æœ</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0:	learn: 0.2573504	test: 0.2554246	best: 0.2554246 (0)	total: 70.1ms	remaining: 21s
50:	learn: 0.3214085	test: 0.3189272	best: 0.3189272 (50)	total: 2.79s	remaining: 13.6s
100:	learn: 0.3276372	test: 0.3258103	best: 0.3258103 (100)	total: 5.23s	remaining: 10.3s
150:	learn: 0.3270367	test: 0.3249316	best: 0.3260667 (101)	total: 7.69s	remaining: 7.59s
200:	learn: 0.3273544	test: 0.3255151	best: 0.3260667 (101)	total: 10.1s	remaining: 4.97s
250:	learn: 0.3280593	test: 0.3258080	best: 0.3260667 (101)	total: 12.5s	remaining: 2.44s
299:	learn: 0.3287711	test: 0.3266151	best: 0.3266341 (298)	total: 15.1s	remaining: 0us

bestTest = 0.3266341375
bestIteration = 298

Shrink model to first 299 iterations.
              precision    recall  f1-score   support

           0       0.69      0.95      0.80    124018
           1       0.72      0.21      0.33     67931

    accuracy                           0.69    191949
   macro avg       0.70      0.58      0.56    191949
weighted avg       0.70      0.69      0.63    191949
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">precision_recall_curve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">precision</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">recall</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Threshold=0.3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall vs Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/67b7f360512682ec456b561297296e70e29417b9dc9358557a0e6d6c8f7afcd1.png" src="_images/67b7f360512682ec456b561297296e70e29417b9dc9358557a0e6d6c8f7afcd1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">(</span><span class="n">prettified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Feature Id</th>
      <th>Importances</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„å¤è´­ç‡</td>
      <td>81.2997303654</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ä¼˜æƒ åˆ¸å¤è´­ç‡</td>
      <td>5.6868594536</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ä¼˜æƒ åˆ¸ç±»åˆ«</td>
      <td>3.0069474692</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ç”¨æˆ·æ ¸é”€ç‡</td>
      <td>2.3678478861</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Coupon_type</td>
      <td>1.9523072000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>ä¼˜æƒ åˆ¸æ ¸é”€ç‡</td>
      <td>1.8432244646</td>
    </tr>
    <tr>
      <th>6</th>
      <td>æ­¤ç±»ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”</td>
      <td>1.3471976073</td>
    </tr>
    <tr>
      <th>7</th>
      <td>æ­¤ä¼˜æƒ åˆ¸çš„ä¼˜æƒ å æ¯”</td>
      <td>1.2608870207</td>
    </tr>
    <tr>
      <th>8</th>
      <td>ç”¨æˆ·åœ¨æ­¤ç±»ä¼˜æƒ åˆ¸ä¸‹çš„ä¼˜æƒ å æ¯”</td>
      <td>1.2349985332</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">èƒŒæ™¯ä»‹ç» <strong>ä¼˜æƒ åˆ¸è¥é”€ï¼šæå‡è·å®¢ä¸ç”¨æˆ·å¤è´­çš„å…³é”®ç­–ç•¥</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"><strong>ä¼˜æƒ åˆ¸çš„ä¸»è¦åˆ†ç±»</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"><strong>1ï¸âƒ£ æŒ‰ä½¿ç”¨é—¨æ§›åˆ’åˆ†</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"><strong>2ï¸âƒ£ æŒ‰ä¼˜æƒ æ–¹å¼åˆ’åˆ†</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><strong>3ï¸âƒ£ æŒ‰ä½¿ç”¨èŒƒå›´åˆ’åˆ†</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6"><strong>ä¼˜æƒ åˆ¸çš„æŒ‘æˆ˜ä¸ä¼˜åŒ–æ–¹å‘</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7"><strong>âœ… è§£å†³æ–¹æ¡ˆï¼šä¸ªæ€§åŒ–ç²¾å‡†æŠ•æ”¾</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">ğŸ“Š <strong>æ•°æ®é›†è¯´æ˜</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">æè¿°æ€§ç»Ÿè®¡(æ–‡å­—)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">æè¿°æ€§ç»Ÿè®¡(å›¾)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">ä¼˜æƒ åˆ¸é‡‘é¢ä¸é—¨æ§›é‡‘é¢åˆ†å¸ƒå¯¹æ¯”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">ä¼˜æƒ åˆ¸ç±»å‹åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">æè¿°æ€§ç»Ÿè®¡</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">åˆ†ç±»ä¾æ®</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kmeans">é€‰æ‹©1 Kmeansåˆ†ç±»</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">é€‰æ‹©2 é˜ˆå€¼åˆ†ç±»</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">åˆ†ç±»ä¾æ®(å›¾)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">å®é™…ä¼˜æƒ é‡‘é¢ä¸å®ä»˜é‡‘é¢å¯¹æ¯”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">è¶‹åŠ¿åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">äººå‡ä½¿ç”¨ä¼˜æƒ åˆ¸æ¬¡æ•°</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">é¢†åˆ¸æ€»æ•°åˆ†å¸ƒ</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">æ¼æ–—æ¨¡å‹</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">åˆ†æç›®çš„</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">ç”¨æˆ·è½¬åŒ–åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">ç”¨æˆ·å¤è´­è½¬åŒ–ç‡åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">é€šè¿‡å¤è´­ç‡å¯¹ä¼˜æƒ åˆ¸åˆ†æ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">é€šè¿‡ä½¿ç”¨é€Ÿåº¦åˆ†å±‚</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm">RFMç”¨æˆ·ä»·å€¼åˆ†æ</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">1ï¸âƒ£ RFM æ•°æ®åˆ†å¸ƒï¼šç›´æ–¹å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">2ï¸âƒ£ RFM ä¸‰å˜é‡å…³ç³»ï¼šæ•£ç‚¹å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm-k-means">3ï¸âƒ£ RFM åˆ†ç¾¤ï¼šK-Means èšç±»</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">4ï¸âƒ£ å„ç¾¤ä½“çš„ RFM æŒ‡æ ‡ç®±çº¿å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">5ï¸âƒ£ RFM å¾—åˆ†çƒ­åŠ›å›¾</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">ç”¨æˆ·ä»·å€¼åˆ†ç±»ç»Ÿè®¡</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">RFM + ç”¨æˆ·è½¬åŒ–åˆ†æ</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">ä¸åŒä»·å€¼æ—ç¾¤çš„è½¬åŒ–æ¼æ–—</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤çš„æ¶ˆè´¹åˆ†å¸ƒ</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">ä¼˜æƒ åˆ¸RFM</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹å æ¯”</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#top1unkown">ä¸åŒç”¨æˆ·ä»·å€¼æ—ç¾¤ä½¿ç”¨çš„ä¼˜æƒ åˆ¸ç±»å‹å æ¯”(å»é™¤top1å’ŒUnkown)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">ç»“è®º</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">é£æ§</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">æ¨¡å‹</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1">Part 1 æ¦‚è¿°</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">æ ‡ç­¾</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">ä¼˜æƒ åˆ¸ç‰¹å¾</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">ç”¨æˆ·ç‰¹å¾</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2">Part 2 æ ‡ç­¾æ„å»º</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3">Part 3 ç‰¹å¾å·¥ç¨‹</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4">Part 4 æ¨¡å‹</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>