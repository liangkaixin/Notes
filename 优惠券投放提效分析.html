
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>背景介绍 优惠券营销：提升获客与用户复购的关键策略 &#8212; My book title</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '优惠券投放提效分析';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
  
    <p class="title logo__title">My book title</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    背景介绍 优惠券营销：提升获客与用户复购的关键策略
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/优惠券投放提效分析.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>背景介绍 优惠券营销：提升获客与用户复购的关键策略</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">背景介绍 <strong>优惠券营销：提升获客与用户复购的关键策略</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"><strong>优惠券的主要分类</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"><strong>1️⃣ 按使用门槛划分</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"><strong>2️⃣ 按优惠方式划分</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><strong>3️⃣ 按使用范围划分</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6"><strong>优惠券的挑战与优化方向</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7"><strong>✅ 解决方案：个性化精准投放</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">📊 <strong>数据集说明</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">描述性统计(文字)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">描述性统计(图)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">优惠券金额与门槛金额分布对比</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">优惠券类型分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">描述性统计</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">分类依据</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kmeans">选择1 Kmeans分类</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">选择2 阈值分类</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">分类依据(图)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">实际优惠金额与实付金额对比</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">趋势分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">人均使用优惠券次数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">领券总数分布</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">漏斗模型</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">分析目的</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">用户转化分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">用户复购转化率分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">通过复购率对优惠券分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">通过使用速度分层</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm">RFM用户价值分析</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">1️⃣ RFM 数据分布：直方图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">2️⃣ RFM 三变量关系：散点图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm-k-means">3️⃣ RFM 分群：K-Means 聚类</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">4️⃣ 各群体的 RFM 指标箱线图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">5️⃣ RFM 得分热力图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">用户价值分类统计</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">RFM + 用户转化分析</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">不同价值族群的转化漏斗</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">不同用户价值族群的消费分布</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">优惠券RFM</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">不同用户价值族群使用的优惠券类型占比</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#top1unkown">不同用户价值族群使用的优惠券类型占比(去除top1和Unkown)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">结论</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">风控</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">模型</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1">Part 1 概述</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">标签</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">优惠券特征</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">用户特征</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2">Part 2 标签构建</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3">Part 3 特征工程</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4">Part 4 模型</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.font_manager</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.mplot3d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">matplotlib_fname</span><span class="p">())</span>  <span class="c1"># 显示 Matplotlib 配置文件路径</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">())</span> 

<span class="o">!</span>cp<span class="w"> </span>/Users/liangkaixin/Documents/优惠券投放提效分析/SimHei.ttf<span class="w"> </span>/Users/liangkaixin/Documents/Notes/商业分析/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf

<span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
        

<span class="c1"># **1. 指定字体文件路径**（修改为你的实际路径）</span>
<span class="n">font_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/liangkaixin/Documents/优惠券投放提效分析/SimHei.ttf&quot;</span>  <span class="c1"># 例如放在项目的 fonts 目录下</span>

<span class="c1"># **2. 加载字体**</span>
<span class="n">my_font</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">font_path</span><span class="p">)</span>

<span class="c1"># **3. 设置 Matplotlib 使用该字体**</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_font</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.unicode_minus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 解决负号 &#39;-&#39; 显示问题</span>

<span class="c1"># 指定一个支持中文的字体 (如 SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># 或 &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 解决负号显示问题</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/liangkaixin/Documents/Notes/商业分析/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/matplotlibrc
/Users/liangkaixin/.matplotlib
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1>背景介绍 <strong>优惠券营销：提升获客与用户复购的关键策略</strong><a class="headerlink" href="#id1" title="Link to this heading">#</a></h1>
<p>优惠券营销是互联网行业进行<strong>获客</strong>和<strong>提升用户复购</strong>的重要手段之一，被广泛应用于<strong>电商零售</strong>和<strong>生活服务行业</strong>。在拉新过程中，企业通常会向新用户提供<strong>大额优惠券</strong>，以降低首次尝鲜门槛，促成交易并建立用户心智，实现业务的快速增长。</p>
<hr class="docutils" />
<section id="id2">
<h2><strong>优惠券的主要分类</strong><a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>在行业多年的实践和探索中，优惠券的营销玩法不断迭代。从分类角度来看，优惠券主要可以分为以下几类：</p>
<section id="id3">
<h3><strong>1️⃣ 按使用门槛划分</strong><a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>无门槛券</strong>：适用于<strong>拉新</strong>，让新用户以<strong>低成本体验产品</strong>，有助于建立品牌心智。</p></li>
<li><p><strong>有门槛券</strong>：能够<strong>提升用户客单价</strong>，促进低客单价用户的消费欲望。</p></li>
</ul>
</section>
<section id="id4">
<h3><strong>2️⃣ 按优惠方式划分</strong><a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>满减券</strong>：用户需要凑单达到一定金额才能使用，能够<strong>刺激用户消费</strong>，提高订单金额。</p></li>
<li><p><strong>折扣券</strong>：适用于<strong>消费金额固定</strong>但可选择不同品牌或平台的场景，如<strong>出行打车</strong>等，增强用户对平台的粘性。</p></li>
</ul>
</section>
<section id="id5">
<h3><strong>3️⃣ 按使用范围划分</strong><a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>特定范围券</strong>（品类券）：适用于<strong>垂直业务定向运营</strong>，如某类商品的专属折扣。</p></li>
<li><p><strong>通用券</strong>：适用于<strong>平台级运营</strong>，提升整体用户活跃度和留存率。</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="id6">
<h2><strong>优惠券的挑战与优化方向</strong><a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>近年来，由于营销手段的<strong>过度使用</strong>，<strong>优惠券的发放量远超用户实际需求</strong>，导致：</p>
<ul class="simple">
<li><p><strong>用户的“优惠感”减弱</strong>，影响促销效果。</p></li>
<li><p><strong>商家和平台的营销投入回报降低</strong>。</p></li>
<li><p><strong>部分用户“薅羊毛”行为加剧</strong>，影响正常用户体验。</p></li>
</ul>
<section id="id7">
<h3><strong>✅ 解决方案：个性化精准投放</strong><a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p><strong>通过数据分析优化投放策略</strong>，可有效提升营销效果：</p>
<ul class="simple">
<li><p><strong>精准筛选目标用户</strong>：分析用户收到优惠券后<strong>核销使用的可能性</strong>，找到最优投放群体。</p></li>
<li><p><strong>减少低效发放</strong>：避免无效投放，降低优惠券浪费，提高ROI（投资回报率）。</p></li>
<li><p><strong>提升用户体验</strong>：将优惠券精准匹配给<strong>真正有需求</strong>的用户，实现更好的营销效果。</p></li>
</ul>
<p>通过精准投放，<strong>用户</strong>能获得真正适合自己的优惠，<strong>商家</strong>能获得更高转化率，<strong>平台</strong>则能提升整体交易规模，从而实现<strong>用户、商家、平台三赢</strong>的局面。 🚀</p>
<p>分析目标</p>
<p>通过分析建模分析预测平台发券后用户的核销使用率，以促进平台和商户更加精准的开展营销投放动作，提升交易转化。</p>
<p>识别潜在业务漏洞及薅羊毛行为，助力风控规则的迭代及潜在风控对象的挖掘。</p>
<p>其他与本课题研究内容相关的业务目标均可。</p>
<p><strong>订单数据(order_detail)</strong></p>
<p>用户ID、订单ID、业务线名称、用户支付日期、用户实付交易额、补贴金额等字段信息。</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>字段名</p></th>
<th class="head"><p>字段说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>User_id</p></td>
<td><p>用户登录后的唯一用户ID</p></td>
</tr>
<tr class="row-odd"><td><p>Shop_id</p></td>
<td><p>商户ID</p></td>
</tr>
<tr class="row-even"><td><p>Order_id</p></td>
<td><p>订单ID</p></td>
</tr>
<tr class="row-odd"><td><p>Coupon_id</p></td>
<td><p>本次使用的优惠券ID</p></td>
</tr>
<tr class="row-even"><td><p>Coupon_type</p></td>
<td><p>本次使用的优惠券类型</p></td>
</tr>
<tr class="row-odd"><td><p>Biz_code</p></td>
<td><p>业务线名称</p></td>
</tr>
<tr class="row-even"><td><p>Pay_date</p></td>
<td><p>用户支付日期</p></td>
</tr>
<tr class="row-odd"><td><p>Actual_pay</p></td>
<td><p>用户实付交易额</p></td>
</tr>
<tr class="row-even"><td><p>Reduce_amount</p></td>
<td><p>补贴金额</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>用户活跃(user_visit_detail)</strong></p>
<p>用户在美团各端（App、小程序等）的活跃日期、用户ID等字段信息</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>字段名</p></th>
<th class="head"><p>字段说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Visit_date</p></td>
<td><p>用户在美团各端（App、小程序等）的活跃日期，包括美团、美团外卖等各应用。</p></td>
</tr>
<tr class="row-odd"><td><p>User_id</p></td>
<td><p>用户登录后的唯一用户ID</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>用户获券数据(user_coupon_receive)</strong></p>
<p>包括用户在一段时间内通过购买、主动领取和平台主动发放的各类优惠券。其中商品立减等非优惠券补贴方式未涵盖在此数据中。</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>字段名</p></th>
<th class="head"><p>字段说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>User_id</p></td>
<td><p>用户登录后的唯一用户ID</p></td>
</tr>
<tr class="row-odd"><td><p>Coupon_id</p></td>
<td><p>优惠券ID</p></td>
</tr>
<tr class="row-even"><td><p>Coupon_status</p></td>
<td><p>券状态(1-未使用 2-已使用 3-其他)</p></td>
</tr>
<tr class="row-odd"><td><p>Coupon_amt</p></td>
<td><p>券面额(单位：元)</p></td>
</tr>
<tr class="row-even"><td><p>Receive_time</p></td>
<td><p>券获取时间(yyyy-MM-dd )</p></td>
</tr>
<tr class="row-odd"><td><p>Start_time</p></td>
<td><p>券生效开始时间(yyyy-MM-dd)</p></td>
</tr>
<tr class="row-even"><td><p>End_time</p></td>
<td><p>券过期时间(yyyy-MM-dd)</p></td>
</tr>
<tr class="row-odd"><td><p>Price_limit</p></td>
<td><p>券使用门槛(单位：元)</p></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id8">
<h1>📊 <strong>数据集说明</strong><a class="headerlink" href="#id8" title="Link to this heading">#</a></h1>
<p>本数据集提供的所有数据均来自<strong>真实业务</strong>，并经过<strong>脱敏处理</strong>，确保不涉及用户隐私信息。数据涵盖了<strong>2023年1月1日 至 2023年6月30日</strong>的订单及用户行为信息，共包含<strong>5万名用户</strong>的数据。</p>
<p>数据存储在<strong>3个文件</strong>中，具体字段及描述如下：</p>
<section id="id9">
<h2>描述性统计(文字)<a class="headerlink" href="#id9" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/liangkaixin/Documents/优惠券投放提效分析/order_detail.csv&#39;</span><span class="p">)</span>
<span class="n">user_visit_detail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/liangkaixin/Documents/优惠券投放提效分析/user_visit_detail.csv&#39;</span><span class="p">)</span>
<span class="n">user_coupon_receive</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/Users/liangkaixin/Documents/优惠券投放提效分析/user_coupon_receive.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">order_detail</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 1543536 entries, 0 to 1543535
Data columns (total 9 columns):
 #   Column         Non-Null Count    Dtype  
---  ------         --------------    -----  
 0   User_id        1543536 non-null  object 
 1   Shop_id        1522799 non-null  object 
 2   Order_id       1543536 non-null  object 
 3   Coupon_id      639960 non-null   object 
 4   Coupon_type    639830 non-null   float64
 5   Biz_code       1543536 non-null  object 
 6   Pay_date       1543536 non-null  object 
 7   Actual_pay     1543536 non-null  float64
 8   Reduce_amount  1543536 non-null  float64
dtypes: float64(3), object(6)
memory usage: 106.0+ MB
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 2815177 entries, 0 to 2815176
Data columns (total 2 columns):
 #   Column      Dtype 
---  ------      ----- 
 0   User_id     object
 1   Visit_date  object
dtypes: object(2)
memory usage: 43.0+ MB
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 2179387 entries, 0 to 2179386
Data columns (total 8 columns):
 #   Column         Dtype  
---  ------         -----  
 0   User_id        object 
 1   Coupon_id      object 
 2   Coupon_status  float64
 3   Coupon_amt     float64
 4   Receive_date   object 
 5   Start_date     object 
 6   End_date       object 
 7   Price_limit    float64
dtypes: float64(3), object(5)
memory usage: 133.0+ MB
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">order_detail</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Shop_id</th>
      <th>Order_id</th>
      <th>Coupon_id</th>
      <th>Coupon_type</th>
      <th>Biz_code</th>
      <th>Pay_date</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1f434874e1371f4651011aec29e463a6</td>
      <td>a6900d0b0e94121a05b8f076d793b36a</td>
      <td>cf215ea951d8a8dc09002cd9e5b2d9ec</td>
      <td>7e4ae1565cc015a44f10263d7ffe4dc0</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-02-10</td>
      <td>30.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>fe845ad183d4ba6ebed2138dfa5fc933</td>
      <td>4e08575cf11cfb11b9719e21bae525b0</td>
      <td>1f8e69ba356e3c786e3e4de600db4f8a</td>
      <td>0a52ebb2f236b558eb5deb0bb73c2613</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-03-26</td>
      <td>22.3000000000</td>
      <td>6.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>56a8a58c7fa83d67862af639c9c5e63f</td>
      <td>c89b4088551c6c98ba02c502b478a824</td>
      <td>bb4ae29d7962a312adc450fe4c7f4965</td>
      <td>20dd5ba437c64f36dfc0f71705324665</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-06-07</td>
      <td>20.2000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>e24374a1fa8e24ed2a39ff614373735e</td>
      <td>f4c9dd2982c4c4192b2e92b1928c502d</td>
      <td>3f0912b08f064f50c571b0e91d7cf059</td>
      <td>161aedbed0ff7ba4d5d204cfeb02ef1c</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-03-17</td>
      <td>43.0000000000</td>
      <td>4.0000000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>91ae4cda5ece690f65317eaa64f5c6d2</td>
      <td>c7e657fc94b2c7316b5164569dc49834</td>
      <td>6ffa6bf214d4e1ef20fec6ecf3a0c9ce</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-02-15</td>
      <td>21.7000000000</td>
      <td>0.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Visit_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>32a91327f9b7362967b7d16514635e16</td>
      <td>2023-03-18</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9ca8a9d70ce07addf37204b70bf2246d</td>
      <td>2023-02-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>dc07b6243f082052cd7b97c8034bab65</td>
      <td>2023-05-03</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b836e40c1d6e2e2ebc432fb3c66af8cb</td>
      <td>2023-06-30</td>
    </tr>
    <tr>
      <th>4</th>
      <td>aeee21d421b1c625c4e4432ffb2fb088</td>
      <td>2023-02-01</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Coupon_id</th>
      <th>Coupon_status</th>
      <th>Coupon_amt</th>
      <th>Receive_date</th>
      <th>Start_date</th>
      <th>End_date</th>
      <th>Price_limit</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>198f3736deb018366b7e76a00ca61a24</td>
      <td>61ce2f87cf1edf6e5f31520cda09b89a</td>
      <td>2.0000000000</td>
      <td>10.0000000000</td>
      <td>2023-04-26</td>
      <td>2023-04-26</td>
      <td>2023-04-26</td>
      <td>25.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>c962d8f6542b0ec14a2cef371cf2f9b2</td>
      <td>3aa11cc0f8698d5a2c9ce34bbf3bf919</td>
      <td>3.0000000000</td>
      <td>7.0000000000</td>
      <td>2023-04-11</td>
      <td>2023-04-11</td>
      <td>2023-04-14</td>
      <td>20.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9e9ffb33c7e434e0db6a599300860121</td>
      <td>4d404e8b2765a960705288d5e16da562</td>
      <td>3.0000000000</td>
      <td>1.0000000000</td>
      <td>2023-02-10</td>
      <td>2023-02-10</td>
      <td>2023-02-11</td>
      <td>5.0000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>f4e5fd8d8a7e6eb033e1e488a93827ae</td>
      <td>31f89b13f0023f8d0a88eed43a64fb4a</td>
      <td>3.0000000000</td>
      <td>3.0000000000</td>
      <td>2023-04-06</td>
      <td>2023-04-06</td>
      <td>2023-04-09</td>
      <td>12.0000000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>870c5425bc174a7b578185cff9701ebd</td>
      <td>3e2e32d8aac9adf7748698cb58e9ebd4</td>
      <td>1.0000000000</td>
      <td>5.0000000000</td>
      <td>2023-05-17</td>
      <td>2023-05-17</td>
      <td>2023-05-24</td>
      <td>30.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">()</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 8 entries, count to max
Data columns (total 3 columns):
 #   Column         Non-Null Count  Dtype  
---  ------         --------------  -----  
 0   Coupon_status  8 non-null      float64
 1   Coupon_amt     8 non-null      float64
 2   Price_limit    8 non-null      float64
dtypes: float64(3)
memory usage: 256.0+ bytes
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coupon_type</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>639830.0000000000</td>
      <td>1543536.0000000000</td>
      <td>1543536.0000000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>277.6431208290</td>
      <td>38.9114167276</td>
      <td>1.4435685404</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2004.7185017906</td>
      <td>70.9594274593</td>
      <td>5.2437157963</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.0000000000</td>
      <td>17.4000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1.0000000000</td>
      <td>24.4000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.0000000000</td>
      <td>38.3000000000</td>
      <td>2.0000000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>20014.0000000000</td>
      <td>41840.0000000000</td>
      <td>1599.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id10">
<h2>描述性统计(图)<a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Count the occurrences of each value in &#39;Coupon_status&#39;</span>
<span class="c1"># Map the numeric Coupon_status to categories</span>

<span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span>  <span class="c1"># 1: 未使用</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span>  <span class="c1"># 2: 已使用</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;#ffab00&#39;</span>   <span class="c1"># 3: 其他</span>
<span class="p">}</span>


<span class="n">status_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;未使用&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;已使用&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;其他&#39;</span><span class="p">}</span>
<span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status_trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">status_mapping</span><span class="p">)</span>
<span class="n">coupon_status_counts</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status_trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Coupon_status&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">]</span>
<span class="c1"># 颜色映射</span>
<span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;未使用&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span>  
    <span class="s1">&#39;已使用&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span>  
    <span class="s1">&#39;其他&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffab00&#39;</span>   
<span class="p">}</span>

<span class="c1"># 统计优惠券状态数量</span>
<span class="n">coupon_status_counts</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_status_trans&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># 设置画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># 绘制柱状图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">palette</span><span class="o">=</span><span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">status</span><span class="p">]</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># 设置标题和标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;优惠券状态分布&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;优惠券状态&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;数量&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># 显示数值标签</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coupon_status_counts</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/87eee662b8f31da317a316655cae74da39c409d808bea24ad309d49adcbf3395.png" src="_images/87eee662b8f31da317a316655cae74da39c409d808bea24ad309d49adcbf3395.png" />
</div>
</div>
</section>
<section id="id11">
<h2>优惠券金额与门槛金额分布对比<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置画布大小</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># 绘制 优惠券金额 的直方图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Coupon_amt&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;优惠券金额&#39;</span><span class="p">)</span>

<span class="c1"># 绘制 门槛金额 的直方图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Price_limit&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32CD32&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;门槛金额&#39;</span><span class="p">)</span>

<span class="c1"># 设置对数 y 轴</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="c1"># 设置图表标题和标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;优惠券金额与门槛金额分布对比&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;金额&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;频次&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># 显示图例</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fcef0293cdf58d46b671a956283bdfb5823e6523e8211d3636e867f4504f8e81.png" src="_images/fcef0293cdf58d46b671a956283bdfb5823e6523e8211d3636e867f4504f8e81.png" />
</div>
</div>
</section>
<section id="id12">
<h2>优惠券类型分析<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
</section>
<section id="id13">
<h2>描述性统计<a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<p>无门槛优惠券 Price_limit = 0</p>
<p>有门槛优惠券 Price_limit &gt; 0</p>
<p>折扣券: 无面值</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        coupon_type,      </span>
<span class="s1">        count(*) as 领券次数,</span>
<span class="s1">        sum(Coupon_amt) / count(*) as 券均面值,</span>
<span class="s1">        sum(End_date::date - Start_date::date) / count(*) as 券均有效期长度,  </span>
<span class="s1">        sum(Price_limit) / count(*) as 券均使用门槛</span>
<span class="s1">from user_coupon_receive</span>
<span class="s1">left join (select distinct coupon_id, coupon_type from order_detail) using(coupon_id)        </span>
<span class="s1">group by 1</span>
<span class="s1">order by Coupon_type</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coupon_type</th>
      <th>领券次数</th>
      <th>券均面值</th>
      <th>券均有效期长度</th>
      <th>券均使用门槛</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000000000</td>
      <td>126</td>
      <td>12.8888888889</td>
      <td>45.4841269841</td>
      <td>75.9448412698</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0000000000</td>
      <td>97542</td>
      <td>5.8741960386</td>
      <td>12.2196387197</td>
      <td>16.2389124685</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0000000000</td>
      <td>847</td>
      <td>11.4271546635</td>
      <td>8.8831168831</td>
      <td>1.8158205431</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0000000000</td>
      <td>926</td>
      <td>68.7073434125</td>
      <td>10.7721382289</td>
      <td>1113.4665226782</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0000000000</td>
      <td>1406</td>
      <td>519.5199146515</td>
      <td>18.7816500711</td>
      <td>22.0583214794</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.0000000000</td>
      <td>200</td>
      <td>5.9550000000</td>
      <td>28.0400000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9.0000000000</td>
      <td>18</td>
      <td>6.9444444444</td>
      <td>2.3333333333</td>
      <td>28.4444444444</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10.0000000000</td>
      <td>77</td>
      <td>3.8437662338</td>
      <td>1.0129870130</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10010.0000000000</td>
      <td>1097</td>
      <td>NaN</td>
      <td>5.1804922516</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10012.0000000000</td>
      <td>49</td>
      <td>NaN</td>
      <td>1.2857142857</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10015.0000000000</td>
      <td>38</td>
      <td>NaN</td>
      <td>0.8157894737</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11</th>
      <td>NaN</td>
      <td>2077061</td>
      <td>41.3829318831</td>
      <td>6.1974790341</td>
      <td>48.5356758083</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        coupon_type,</span>
<span class="s1">        AVG(Actual_pay + Reduce_amount)::INT AS 商品平均价格,</span>
<span class="s1">        sum(reduce_amount) / count(*) as 券均优惠价格,</span>
<span class="s1">        sum(reduce_amount) * 100 / sum(actual_pay + reduce_amount) as 优惠比例,</span>
<span class="s1">        count(*) / (select count(*) from order_detail where coupon_type is not null) * 100 as 使用比例,</span>
<span class="s1">        count(*) 使用次数</span>
<span class="s1">from order_detail       </span>
<span class="s1">where coupon_type is not null</span>
<span class="s1">group by 1</span>
<span class="s1">order by Coupon_type</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_使用次数&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;使用次数&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># 创建画布</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># 绘制 券均优惠价格 的条形图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;各优惠券类型的券均优惠价格&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;优惠券类型&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;券均优惠价格&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># 绘制 优惠比例 的条形图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;优惠比例&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;各优惠券类型的优惠比例&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;优惠券类型&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;优惠比例 (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># 绘制 使用次数 的条形图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;使用次数&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;各优惠券类型的使用次数&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;优惠券类型&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;使用次数&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>


<span class="c1"># 绘制 使用次数 的条形图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;log_使用次数&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;各优惠券类型的使用次数（取对数）&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;优惠券类型&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;使用次数对数&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

<span class="c1"># 调整布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coupon_type</th>
      <th>商品平均价格</th>
      <th>券均优惠价格</th>
      <th>优惠比例</th>
      <th>使用比例</th>
      <th>使用次数</th>
      <th>log_使用次数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0000000000</td>
      <td>246</td>
      <td>2.6240681576</td>
      <td>1.0671126828</td>
      <td>0.1467577325</td>
      <td>939</td>
      <td>6.8458798753</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0000000000</td>
      <td>34</td>
      <td>2.3050967231</td>
      <td>6.7622172465</td>
      <td>89.1554006533</td>
      <td>570443</td>
      <td>13.2541702840</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2.0000000000</td>
      <td>33</td>
      <td>3.0172434766</td>
      <td>9.0978488660</td>
      <td>0.7966178516</td>
      <td>5097</td>
      <td>8.5366035849</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3.0000000000</td>
      <td>133</td>
      <td>7.0602147385</td>
      <td>5.2943713727</td>
      <td>3.6245565228</td>
      <td>23191</td>
      <td>10.0515626706</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4.0000000000</td>
      <td>191</td>
      <td>1.8468000936</td>
      <td>0.9679794784</td>
      <td>1.3353547036</td>
      <td>8544</td>
      <td>9.0531015955</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.0000000000</td>
      <td>55</td>
      <td>8.1893552995</td>
      <td>14.9355591872</td>
      <td>0.2034915524</td>
      <td>1302</td>
      <td>7.1724245771</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6.0000000000</td>
      <td>43</td>
      <td>0.0595479536</td>
      <td>0.1390072039</td>
      <td>2.5584920995</td>
      <td>16370</td>
      <td>9.7032667559</td>
    </tr>
    <tr>
      <th>7</th>
      <td>9.0000000000</td>
      <td>46</td>
      <td>8.9276344086</td>
      <td>19.2073417587</td>
      <td>0.0145351109</td>
      <td>93</td>
      <td>4.5432947823</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10.0000000000</td>
      <td>56</td>
      <td>3.8614691943</td>
      <td>6.8875066781</td>
      <td>0.0659550193</td>
      <td>422</td>
      <td>6.0473721790</td>
    </tr>
    <tr>
      <th>9</th>
      <td>11.0000000000</td>
      <td>76</td>
      <td>3.5571428571</td>
      <td>4.6605648829</td>
      <td>0.0010940406</td>
      <td>7</td>
      <td>2.0794415417</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10010.0000000000</td>
      <td>87</td>
      <td>6.5483901378</td>
      <td>7.4927503471</td>
      <td>1.2931559946</td>
      <td>8274</td>
      <td>9.0209942002</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10012.0000000000</td>
      <td>136</td>
      <td>14.6184203297</td>
      <td>10.7296729289</td>
      <td>0.1137802229</td>
      <td>728</td>
      <td>6.5916737320</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10015.0000000000</td>
      <td>5</td>
      <td>4.8580813953</td>
      <td>98.9965168353</td>
      <td>0.0268821406</td>
      <td>172</td>
      <td>5.1532915945</td>
    </tr>
    <tr>
      <th>13</th>
      <td>20011.0000000000</td>
      <td>132</td>
      <td>9.0185556578</td>
      <td>6.8071339026</td>
      <td>0.1698888767</td>
      <td>1087</td>
      <td>6.9920964274</td>
    </tr>
    <tr>
      <th>14</th>
      <td>20013.0000000000</td>
      <td>46</td>
      <td>2.5482352941</td>
      <td>5.5075864624</td>
      <td>0.0185986903</td>
      <td>119</td>
      <td>4.7874917428</td>
    </tr>
    <tr>
      <th>15</th>
      <td>20014.0000000000</td>
      <td>46</td>
      <td>0.2454207758</td>
      <td>0.5364929385</td>
      <td>0.4754387884</td>
      <td>3042</td>
      <td>8.0205991499</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/6b93c9b627b90a003842335cc49398dcfea157c1c370179984062437815753b3.png" src="_images/6b93c9b627b90a003842335cc49398dcfea157c1c370179984062437815753b3.png" />
</div>
</div>
<p>要对这些优惠券数据进行分类，我们可以根据不同的特征值（如：券均优惠价格、优惠比例等）来定义不同的类别。以下是几种可能的分类方式：</p>
<ol class="arabic simple">
<li><p>按优惠比例分类
根据“优惠比例”来进行分类。可以按照优惠比例的不同划分成几类。例如：</p></li>
</ol>
<p>高优惠：优惠比例大于某个阈值（例如，10%）。</p>
<p>中等优惠：优惠比例在某个范围内（例如，5%-10%）。</p>
<p>低优惠：优惠比例低于某个阈值（例如，5%）。</p>
<ol class="arabic simple" start="2">
<li><p>按券均优惠价格分类
根据“券均优惠价格”来进行分类。比如：</p></li>
</ol>
<p>高价优惠券：券均优惠价格较高。</p>
<p>低价优惠券：券均优惠价格较低。</p>
<ol class="arabic simple" start="3">
<li><p>按优惠券类型分类
根据“Coupon_type”来对优惠券进行类别划分。你可以为不同的Coupon_type赋予不同的类别标签。</p></li>
<li><p>综合分类
根据多个特征（如优惠比例和券均优惠价格）来综合分类，可能有以下几种类别：</p></li>
</ol>
<p>高价值优惠券：优惠比例和券均优惠价格都较高。</p>
<p>中等价值优惠券：优惠比例和券均优惠价格都在中间。</p>
<p>低价值优惠券：优惠比例和券均优惠价格都较低。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;WITH coupon_stats AS (</span>
<span class="s1">    SELECT </span>
<span class="s1">        coupon_type,</span>
<span class="s1">        SUM(reduce_amount) / COUNT(*) AS 券均优惠价格,</span>
<span class="s1">        SUM(reduce_amount) * 100.0 / SUM(actual_pay + reduce_amount) AS 优惠比例,</span>
<span class="s1">        COUNT(*) AS 使用次数</span>
<span class="s1">    FROM order_detail       </span>
<span class="s1">    WHERE coupon_type IS NOT NULL</span>
<span class="s1">    GROUP BY 1</span>
<span class="s1">)</span>
<span class="s1">SELECT </span>
<span class="s1">    PERCENTILE_CONT(0.2) WITHIN GROUP (ORDER BY 券均优惠价格) AS p20_券均优惠价格,</span>
<span class="s1">    PERCENTILE_CONT(0.2) WITHIN GROUP (ORDER BY 优惠比例) AS p20_优惠比例,</span>
<span class="s1">    PERCENTILE_CONT(0.2) WITHIN GROUP (ORDER BY 使用次数) AS p20_使用次数</span>
<span class="s1">FROM coupon_stats;</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>┌────────────────────┬────────────────────┬──────────────┐
│  p20_券均优惠价格  │    p20_优惠比例    │ p20_使用次数 │
│       double       │       double       │    double    │
├────────────────────┼────────────────────┼──────────────┤
│ 2.3050967230731225 │ 1.0671126828117985 │        172.0 │
└────────────────────┴────────────────────┴──────────────┘
</pre></div>
</div>
</div>
</div>
</section>
<section id="id14">
<h2>分类依据<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<section id="kmeans">
<h3>选择1 Kmeans分类<a class="headerlink" href="#kmeans" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 选择要进行聚类的特征</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">,</span> <span class="s1">&#39;优惠比例&#39;</span><span class="p">,</span> <span class="s1">&#39;log_使用次数&#39;</span><span class="p">]]</span>

<span class="c1"># 使用肘部法则确定聚类数</span>
<span class="n">inertia</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># 试试1到10个聚类</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">inertia</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kmeans</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>

<span class="c1"># 绘制肘部法则图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">inertia</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;肘部法则 (Elbow Method)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;聚类数 (K)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SSE (误差平方和)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/12f414fcd501d394e78112156d5f1c04e0d385d5567aabc650b0cd8a6ea5c90b.png" src="_images/12f414fcd501d394e78112156d5f1c04e0d385d5567aabc650b0cd8a6ea5c90b.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 从肘部法则图选择聚类数，例如选择3个聚类</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;聚类标签&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="c1"># 设置画布</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="c1"># 绘制散点图</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;优惠比例&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_使用次数&#39;</span><span class="p">],</span> 
                     <span class="n">c</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;聚类标签&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># 添加颜色条</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;聚类标签&quot;</span><span class="p">)</span>

<span class="c1"># 设置坐标轴标签</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;优惠比例&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;log_日均使用次数&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;K均值聚类结果 (优惠券类型)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c1"># 显示图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">Coupon_tag</span> <span class="o">=</span>  <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="s1">&#39;聚类标签&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/876375dadfba8d95effa6daa87e65c3fbec925c01d76941816fc7394d708dc4b.png" src="_images/876375dadfba8d95effa6daa87e65c3fbec925c01d76941816fc7394d708dc4b.png" />
</div>
</div>
<p>在使用 K均值聚类进行优惠券分类时，我们选择了三个特征来进行聚类：</p>
<ol class="arabic simple">
<li><p><strong>券均优惠价格</strong>：每张优惠券的平均优惠价格。</p></li>
<li><p><strong>优惠比例</strong>：优惠券的优惠金额与总金额的比例。</p></li>
<li><p><strong>日均使用次数</strong>：每个优惠券类型的日均使用次数。</p></li>
<li><p><strong>聚类数的选择</strong>（通过肘部法则）：</p></li>
</ol>
<ul>
<li><p><strong>肘部法则</strong>：我们通过肘部法则（Elbow Method）来确定聚类数。肘部法则的核心思想是，随着聚类数增多，误差平方和（SSE）会不断减小，但在某个聚类数后，误差的下降速度会放缓（形成“肘部”）。我们通常选择该“肘部”处的聚类数作为最佳聚类数。</p>
<ul class="simple">
<li><p><strong>图示分析</strong>：你绘制的肘部法则图展示了不同聚类数下的误差平方和（SSE）。通过查看图形的“肘部”位置，可以判断合适的聚类数。</p></li>
<li><p>例如，如果肘部出现在 K=8，那么可以选择 K=8，意味着最佳的聚类数为 8。</p></li>
</ul>
<p>在你的代码中，你选择了 K=8，表示你想将优惠券分成 8 类。虽然在肘部法则中没有明显的“肘部”位置（可能是因为数据本身的分布），选择 K=8 可能是基于你的具体需求或对数据的先验理解。</p>
</li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>聚类依据</strong>：
选择了三个特征：</p></li>
</ol>
<ul class="simple">
<li><p><strong>券均优惠价格</strong>：表明优惠券的平均优惠金额。如果该值较高，可能表示高价值的优惠券。</p></li>
<li><p><strong>优惠比例</strong>：描述了优惠券的优惠力度。高的优惠比例意味着该优惠券的折扣力度大，可能更吸引消费者。</p></li>
<li><p><strong>日均使用次数</strong>：反映了该优惠券的使用频率。频繁使用的优惠券可能受到广泛的接受和使用。</p></li>
</ul>
<p>基于这三个特征，K均值算法将这些优惠券分为 8 类，每个类的优惠券在上述特征上具有相似性。</p>
<ol class="arabic simple" start="3">
<li><p><strong>聚类阈值的解释</strong>：
K均值聚类通过计算每个数据点（在这里是每种优惠券）的距离，尝试将数据点分配到离其更近的聚类中心。因此，每个聚类的形成都有其特定的“阈值”：</p></li>
</ol>
<ul class="simple">
<li><p>每一类的优惠券在这三个特征上会有一些集中趋势。例如，某一类可能有较高的优惠比例和较低的券均优惠价格，表示这类优惠券的折扣力度大，但单张券的优惠金额较小，可能频繁使用。</p></li>
<li><p>另一类可能有较低的优惠比例，但券均优惠价格较高，且使用频率较低，这可能是一些高价值但较少使用的优惠券。</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>如何理解每个聚类</strong>：
一旦你得到了每个优惠券的聚类标签，就可以进一步分析每一类优惠券的特征：</p></li>
</ol>
<ul class="simple">
<li><p><strong>类内特征分析</strong>：每个聚类内的优惠券会在“券均优惠价格”、“优惠比例”和“日均使用次数”上有相似性。可以通过聚类后的均值、标准差等统计量来分析每一类的典型特征。</p></li>
<li><p><strong>可视化</strong>：通过散点图，你可以将不同聚类用不同颜色标示出来，从而直观地看到不同类型优惠券在这三个特征空间中的分布。</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p><strong>进一步分析和决策</strong>：</p></li>
</ol>
<ul class="simple">
<li><p>你可以根据聚类标签，对不同类型的优惠券进行不同的策略。例如：</p>
<ul>
<li><p><strong>高优惠比例，高使用频率</strong>：这种优惠券类型可能适合在促销活动中广泛发放，因为它们的使用频率较高，且优惠力度大，可能带来较高的吸引力。</p></li>
<li><p><strong>高券均优惠价格，低使用频率</strong>：这种优惠券可能适合针对特定目标群体（如高价值客户）使用。</p></li>
</ul>
</li>
</ul>
<p>通过这些分析，你可以进一步优化营销策略，并根据不同类别的优惠券制定个性化的营销活动。</p>
<ol class="arabic simple" start="6">
<li><p><strong>总结</strong>：</p></li>
</ol>
<ul class="simple">
<li><p>通过 K均值聚类，你已经将优惠券类型根据其优惠价格、优惠比例和日均使用次数进行了分类。</p></li>
<li><p>每个聚类的阈值是基于它们在这些特征上的集中程度而确定的，即相似的优惠券会被划分到同一类。</p></li>
<li><p>聚类结果的可视化帮助你更清晰地理解每个类别的特征，从而为营销决策提供支持。</p></li>
</ul>
</section>
<section id="id15">
<h3>选择2 阈值分类<a class="headerlink" href="#id15" title="Link to this heading">#</a></h3>
<section id="id16">
<h4>分类依据(图)<a class="headerlink" href="#id16" title="Link to this heading">#</a></h4>
<p><strong>优惠券分类依据：小于25分位代表低优惠，大于25分位代表高优惠，其余是中优惠</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 数据</span>
<span class="n">coupon_price</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.548235</span><span class="p">,</span> <span class="mf">9.018556</span><span class="p">,</span> <span class="mf">8.927634</span><span class="p">,</span> <span class="mf">1.846800</span><span class="p">,</span> <span class="mf">4.858081</span><span class="p">,</span> <span class="mf">2.624068</span><span class="p">,</span> <span class="mf">8.189355</span><span class="p">,</span> <span class="mf">3.557143</span><span class="p">,</span> <span class="mf">7.060215</span><span class="p">,</span> <span class="mf">3.017243</span><span class="p">,</span>
                         <span class="mf">3.861469</span><span class="p">,</span> <span class="mf">2.305097</span><span class="p">,</span> <span class="mf">0.245421</span><span class="p">,</span> <span class="mf">6.548390</span><span class="p">,</span> <span class="mf">0.059548</span><span class="p">,</span> <span class="mf">14.618420</span><span class="p">])</span>
<span class="n">discount_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.507586</span><span class="p">,</span> <span class="mf">6.807134</span><span class="p">,</span> <span class="mf">19.207342</span><span class="p">,</span> <span class="mf">0.967979</span><span class="p">,</span> <span class="mf">98.996517</span><span class="p">,</span> <span class="mf">1.067113</span><span class="p">,</span> <span class="mf">14.935559</span><span class="p">,</span> <span class="mf">4.660565</span><span class="p">,</span> <span class="mf">5.294371</span><span class="p">,</span> <span class="mf">9.097849</span><span class="p">,</span>
                           <span class="mf">6.887507</span><span class="p">,</span> <span class="mf">6.762217</span><span class="p">,</span> <span class="mf">0.536493</span><span class="p">,</span> <span class="mf">7.492750</span><span class="p">,</span> <span class="mf">0.139007</span><span class="p">,</span> <span class="mf">10.729673</span><span class="p">])</span>

<span class="c1"># 创建子图</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># ================== 券均优惠价格分布 ==================</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;券均优惠价格分布（低/中/高优惠区间）&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;频数&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># 计算四分位数</span>
<span class="n">q1_cp</span><span class="p">,</span> <span class="n">median_cp</span><span class="p">,</span> <span class="n">q3_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
<span class="n">min_cp</span><span class="p">,</span> <span class="n">max_cp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">coupon_price</span><span class="p">)</span>

<span class="c1"># 填充不同优惠区间</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">min_cp</span><span class="p">,</span> <span class="n">q1_cp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;低优惠 (&lt;Q1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q1_cp</span><span class="p">,</span> <span class="n">q3_cp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightyellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;中优惠 (Q1-Q3)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q3_cp</span><span class="p">,</span> <span class="n">max_cp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;高优惠 (&gt;Q3)&#39;</span><span class="p">)</span>

<span class="c1"># 添加四分位线</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">q1_cp</span><span class="p">,</span> <span class="n">median_cp</span><span class="p">,</span> <span class="n">q3_cp</span><span class="p">],</span> 
                            <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># ================== 优惠比例分布 ==================</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;seagreen&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;优惠比例分布（低/中/高优惠区间）&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;优惠比例 (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;频数&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># 计算四分位数</span>
<span class="n">q1_dr</span><span class="p">,</span> <span class="n">median_dr</span><span class="p">,</span> <span class="n">q3_dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
<span class="n">min_dr</span><span class="p">,</span> <span class="n">max_dr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">discount_ratio</span><span class="p">)</span>

<span class="c1"># 填充不同优惠区间</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">min_dr</span><span class="p">,</span> <span class="n">q1_dr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightcoral&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;低优惠 (&lt;Q1)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q1_dr</span><span class="p">,</span> <span class="n">q3_dr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightyellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;中优惠 (Q1-Q3)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">q3_dr</span><span class="p">,</span> <span class="n">max_dr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;高优惠 (&gt;Q3)&#39;</span><span class="p">)</span>

<span class="c1"># 添加四分位线</span>
<span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">q1_dr</span><span class="p">,</span> <span class="n">median_dr</span><span class="p">,</span> <span class="n">q3_dr</span><span class="p">],</span> 
                            <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">],</span>
                            <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 优化图表布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dc8a03ecf3dfbd577f21c20f09b9f933ceb80352e5bd37f293e06645e9e709bc.png" src="_images/dc8a03ecf3dfbd577f21c20f09b9f933ceb80352e5bd37f293e06645e9e709bc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建示例数据</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Coupon_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">20013.0</span><span class="p">,</span> <span class="mf">20011.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">10015.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">20014.0</span><span class="p">,</span> <span class="mf">10010.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">10012.0</span><span class="p">],</span>
    <span class="s2">&quot;券均优惠价格&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.548235</span><span class="p">,</span> <span class="mf">9.018556</span><span class="p">,</span> <span class="mf">8.927634</span><span class="p">,</span> <span class="mf">1.846800</span><span class="p">,</span> <span class="mf">4.858081</span><span class="p">,</span> <span class="mf">2.624068</span><span class="p">,</span> <span class="mf">8.189355</span><span class="p">,</span> <span class="mf">3.557143</span><span class="p">,</span> <span class="mf">7.060215</span><span class="p">,</span> <span class="mf">3.017243</span><span class="p">,</span> <span class="mf">3.861469</span><span class="p">,</span> <span class="mf">2.305097</span><span class="p">,</span> <span class="mf">0.245421</span><span class="p">,</span> <span class="mf">6.548390</span><span class="p">,</span> <span class="mf">0.059548</span><span class="p">,</span> <span class="mf">14.618420</span><span class="p">],</span>
    <span class="s2">&quot;优惠比例&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.507586</span><span class="p">,</span> <span class="mf">6.807134</span><span class="p">,</span> <span class="mf">19.207342</span><span class="p">,</span> <span class="mf">0.967979</span><span class="p">,</span> <span class="mf">98.996517</span><span class="p">,</span> <span class="mf">1.067113</span><span class="p">,</span> <span class="mf">14.935559</span><span class="p">,</span> <span class="mf">4.660565</span><span class="p">,</span> <span class="mf">5.294371</span><span class="p">,</span> <span class="mf">9.097849</span><span class="p">,</span> <span class="mf">6.887507</span><span class="p">,</span> <span class="mf">6.762217</span><span class="p">,</span> <span class="mf">0.536493</span><span class="p">,</span> <span class="mf">7.492750</span><span class="p">,</span> <span class="mf">0.139007</span><span class="p">,</span> <span class="mf">10.729673</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># 创建 DataFrame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># 按券均优惠价格分类</span>
<span class="k">def</span><span class="w"> </span><span class="nf">categorize_by_coupon_price</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">7.34</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;高价优惠券&#39;</span>
    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2.49</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;低价优惠券&#39;</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;中等优惠券&#39;</span>
    
<span class="c1"># 按优惠比例分类</span>
<span class="k">def</span><span class="w"> </span><span class="nf">categorize_by_discount_ratio</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;优惠比例&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">9.51</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;高比例优惠&#39;</span>
    <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;优惠比例&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">3.76</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;低比例优惠&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;中比例优惠&#39;</span>



<span class="c1"># 创建分类列</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;优惠比例分类&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">categorize_by_discount_ratio</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;券均优惠价格分类&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">categorize_by_coupon_price</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 输出分类后的数据</span>
<span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="s1">&#39;券均优惠价格&#39;</span><span class="p">,</span> <span class="s1">&#39;优惠比例&#39;</span><span class="p">,</span> <span class="s1">&#39;优惠比例分类&#39;</span><span class="p">,</span> <span class="s1">&#39;券均优惠价格分类&#39;</span><span class="p">]]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;优惠券类别&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;优惠比例分类&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;券均优惠价格分类&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;商品平均价格&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;券均优惠价格&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;优惠比例&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># order_detail = pd.merge(order_detail, df[[&#39;Coupon_type&#39;, &#39;优惠券类别&#39;]], on=&#39;Coupon_type&#39;, how=&#39;left&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">order_detail</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="s1">&#39;优惠券类别&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">matplotlib_fname</span><span class="p">())</span>  <span class="c1"># 显示 Matplotlib 配置文件路径</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">get_cachedir</span><span class="p">())</span> 

<span class="o">!</span>cp<span class="w"> </span>/Users/liangkaixin/Documents/优惠券投放提效分析/SimHei.ttf<span class="w"> </span>/Users/liangkaixin/Documents/Notes/商业分析/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/fonts/ttf

<span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
        

<span class="c1"># **1. 指定字体文件路径**（修改为你的实际路径）</span>
<span class="n">font_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/liangkaixin/Documents/优惠券投放提效分析/SimHei.ttf&quot;</span>  <span class="c1"># 例如放在项目的 fonts 目录下</span>

<span class="c1"># **2. 加载字体**</span>
<span class="n">my_font</span> <span class="o">=</span> <span class="n">fm</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">font_path</span><span class="p">)</span>

<span class="c1"># **3. 设置 Matplotlib 使用该字体**</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_font</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.unicode_minus&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 解决负号 &#39;-&#39; 显示问题</span>

<span class="c1"># 指定一个支持中文的字体 (如 SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># 或 &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 解决负号显示问题</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/liangkaixin/Documents/Notes/商业分析/.venv/lib/python3.10/site-packages/matplotlib/mpl-data/matplotlibrc
/Users/liangkaixin/.matplotlib
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="id17">
<h2>实际优惠金额与实付金额对比<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置画布大小</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># 指定一个支持中文的字体 (如 SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># 或 &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 解决负号显示问题</span>

<span class="c1"># 直方图 1: 实际优惠金额</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;实际优惠金额分布&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;实际优惠金额取对数&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;频次&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># 直方图 2: 实付金额</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#32CD32&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;实付金额分布&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;实付金额取对数&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;频次&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># 调整布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># 显示图形</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/37f57dae203093db50a2aea96c18b4a6aa52e68f075ad9b71daed14750babc17.png" src="_images/37f57dae203093db50a2aea96c18b4a6aa52e68f075ad9b71daed14750babc17.png" />
</div>
</div>
</section>
<section id="id18">
<h2>趋势分析<a class="headerlink" href="#id18" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assume data is already loaded into order_detail, user_visit_detail, and user_coupon_receive</span>

<span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">])</span>
<span class="c1"># Calculate total daily payment and reduce amount</span>
<span class="n">daily_payment</span> <span class="o">=</span> <span class="n">order_detail</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">,</span> <span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># Calculate daily active users (unique user count per day)</span>
<span class="n">user_visit_detail</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">])</span>
<span class="n">daily_active_users</span> <span class="o">=</span> <span class="n">user_visit_detail</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">user_visit_detail</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[</span><span class="s1">&#39;User_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">daily_active_users</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Active_users&#39;</span><span class="p">]</span>

<span class="c1"># Assuming user_coupon_receive already contains &#39;Receive_date&#39;</span>
<span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">])</span>

<span class="c1"># Calculate daily coupon receipt count</span>
<span class="n">daily_coupon_received</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[</span><span class="s1">&#39;Coupon_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">daily_coupon_received</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_received_count&#39;</span><span class="p">]</span>


<span class="c1"># 创建画布，分为 2 行 2 列</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 绘制用户总消费金额趋势</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;用户总消费金额趋势&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;金额&quot;</span><span class="p">)</span>

<span class="c1"># 绘制优惠金额趋势</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Pay_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_payment</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;优惠金额趋势&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;金额&quot;</span><span class="p">)</span>

<span class="c1"># 绘制每日活跃用户数趋势</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_active_users</span><span class="p">[</span><span class="s1">&#39;Visit_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_active_users</span><span class="p">[</span><span class="s1">&#39;Active_users&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;每日活跃用户数&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;日期&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;用户数&quot;</span><span class="p">)</span>

<span class="c1"># 绘制每日领取优惠券数量趋势</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">daily_coupon_received</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">daily_coupon_received</span><span class="p">[</span><span class="s1">&#39;Coupon_received_count&#39;</span><span class="p">],</span> 
             <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;每日领取优惠券数量&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;日期&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;数量&quot;</span><span class="p">)</span>

<span class="c1"># 调整布局，防止标签重叠</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d5a84c55ae992905b5545999814b5e05c07176240376b0348be3c8e1850b696f.png" src="_images/d5a84c55ae992905b5545999814b5e05c07176240376b0348be3c8e1850b696f.png" />
</div>
</div>
</section>
<section id="id19">
<h2>人均使用优惠券次数<a class="headerlink" href="#id19" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 先将日期列转换为日期类型</span>
<span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">user_coupon_receive</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">])</span>

<span class="c1"># 计算每个用户使用优惠券的次数</span>
<span class="n">user_coupon_count</span> <span class="o">=</span> <span class="n">user_coupon_receive</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;User_id&#39;</span><span class="p">)[</span><span class="s1">&#39;Coupon_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">user_coupon_count</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_count&#39;</span><span class="p">]</span>

<span class="c1"># 计算人均使用优惠券次数</span>
<span class="n">average_coupon_usage</span> <span class="o">=</span> <span class="n">user_coupon_count</span><span class="p">[</span><span class="s1">&#39;Coupon_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;人均使用优惠券次数: </span><span class="si">{</span><span class="n">average_coupon_usage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 创建画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># 绘制直方图（柱状图）</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">user_coupon_count</span><span class="p">[</span><span class="s1">&#39;Coupon_count&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 设置标题和坐标轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;用户优惠券使用次数分布&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;优惠券使用次数&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;用户数量&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>  <span class="c1"># 设置 y 轴为对数刻度</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># 旋转 x 轴标签防止重叠</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>人均使用优惠券次数: 44.70
</pre></div>
</div>
<img alt="_images/105d65337e84d3fa9c041ba4f5eebc8ba15d7b09a4848e9fe35404e42a9883d3.png" src="_images/105d65337e84d3fa9c041ba4f5eebc8ba15d7b09a4848e9fe35404e42a9883d3.png" />
</div>
</div>
</section>
<section id="id20">
<h2>领券总数分布<a class="headerlink" href="#id20" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    select count(*) as 领券总数,User_id AS 用户ID, Receive_date from user_coupon_receive</span>
<span class="s2">           WHERE Coupon_id IS NOT NULL AND Receive_date IS NOT NULL</span>
<span class="s2">           group by 2, 3</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
<span class="c1"># 计算每个值的频次及其占比</span>
<span class="n">value_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;领券总数&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 将结果转换为 DataFrame，展示频次和占比</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;领券总数&#39;</span><span class="p">:</span> <span class="n">value_counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="s1">&#39;人数&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;领券总数&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span>
    <span class="s1">&#39;占比(%)&#39;</span><span class="p">:</span> <span class="n">value_counts</span><span class="o">*</span><span class="mi">100</span>
<span class="p">})</span>
<span class="c1"># 显示结果</span>
<span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;占比(%)&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="n">custom_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffab00&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff6b00&#39;</span><span class="p">]</span>

<span class="c1"># 创建一个 &#39;占比(%)&#39; 小于某个阈值的布尔标志</span>
<span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;explode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;占比(%)&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span>

<span class="c1"># 使用 plotly 创建交互式饼图</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
    <span class="n">result_df</span><span class="p">,</span>
    <span class="n">values</span><span class="o">=</span><span class="s1">&#39;占比(%)&#39;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="s1">&#39;领券总数&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;领券总数分布的饼图&#39;</span><span class="p">,</span>
    <span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">custom_colors</span><span class="p">,</span>
    <span class="n">hole</span><span class="o">=</span><span class="mf">0.3</span>  <span class="c1"># 如果你想制作甜甜圈图</span>
<span class="p">)</span>

<span class="c1"># 添加爆开效果，使用饼图角度细微调整大的小爆开效果</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
    <span class="n">pull</span><span class="o">=</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;explode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id21">
<h1>漏斗模型<a class="headerlink" href="#id21" title="Link to this heading">#</a></h1>
<section id="id22">
<h2>分析目的<a class="headerlink" href="#id22" title="Link to this heading">#</a></h2>
<p>使用<strong>漏斗模型</strong>对用户进行分析，对各环节用户转化率的情况进行收集对比，</p>
<p>从中发现问题并对问题发生的原因进行分析，然后尝试给出业务建议。</p>
<p>继而利用<strong>RFM模型</strong>进行用户价值分析，力图对用户进行更高效的精细化运营，促进优惠券核销以及销售增长。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- 所有用户</span>
<span class="s2">with t1 as </span>
<span class="s2">(</span>
<span class="s2">    select</span>
<span class="s2">         count(distinct User_id) as all_users</span>
<span class="s2">     from </span>
<span class="s2">     (</span>
<span class="s2">      select User_id from order_detail</span>
<span class="s2">      union all</span>
<span class="s2">      select User_id from user_visit_detail</span>
<span class="s2">      union all</span>
<span class="s2">      select User_id from user_coupon_receive</span>
<span class="s2">     )</span>
<span class="s2">),</span>
<span class="s2">-- 领券用户</span>
<span class="s2">t2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as getcoupons_users</span>
<span class="s2">from user_coupon_receive</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">),</span>
<span class="s2">-- 首次用券核销用户</span>
<span class="s2">a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    min(Pay_date) as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">group by User_id),</span>
<span class="s2">-- 用券后复购用户</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as second_user</span>
<span class="s2">from a1</span>
<span class="s2">inner join </span>
<span class="s2">(</span>
<span class="s2">    select * from order_detail</span>
<span class="s2">    where Coupon_id is not null</span>
<span class="s2">) as order_detail</span>
<span class="s2">using(User_id)</span>
<span class="s2">where order_detail.Pay_date	&gt;first_date</span>
<span class="s2">)</span>

<span class="s2">select</span>
<span class="s2">    (select all_users from t1) as 所有用户数,</span>
<span class="s2">    (select getcoupons_users from t2) as 领券用户数,</span>
<span class="s2">    (select count(distinct User_id) from a1) as 首次用券核销用户数,</span>
<span class="s2">    (select second_user from a2) as 用券后复购用户数</span>
<span class="s2">--where Date_received is not null and Date is not null;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 转换数据格式（重命名列）</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stage</th>
      <th>number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>所有用户数</td>
      <td>49965</td>
    </tr>
    <tr>
      <th>1</th>
      <td>领券用户数</td>
      <td>48760</td>
    </tr>
    <tr>
      <th>2</th>
      <td>首次用券核销用户数</td>
      <td>34821</td>
    </tr>
    <tr>
      <th>3</th>
      <td>用券后复购用户数</td>
      <td>25924</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id23">
<h2>用户转化分析<a class="headerlink" href="#id23" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 计算相对初始值的百分比</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;percent_initial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># 创建漏斗图</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Funnel</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">],</span>  
    <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">],</span>  
    <span class="n">textinfo</span><span class="o">=</span><span class="s2">&quot;value+percent initial&quot;</span><span class="p">,</span>  <span class="c1"># 显示数值 + 相对初始值的百分比</span>
    <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;inside&quot;</span><span class="p">,</span>  <span class="c1"># 文本居中</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="p">{</span>        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffab00&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8000&#39;</span><span class="p">],</span>  <span class="c1"># 使用自定义的色号</span>
        <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># 每个部分的边框宽度</span>
            <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="s1">&#39;wheat&#39;</span><span class="p">]</span>  <span class="c1"># 边框颜色</span>
        <span class="p">}</span>
        
        <span class="p">},</span>
    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span>  <span class="c1"># 透明度</span>
    <span class="n">connector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 连接线样式</span>
    <span class="p">)</span>
<span class="p">))</span>

<span class="c1"># 设置标题和整体样式</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;📊 用户转化漏斗图&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkblue&quot;</span><span class="p">)),</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># 背景色</span>
    <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">),</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># 调整边距</span>
<span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>从上述漏斗模型中我主要发现三个现象：</p>
<p>第一：用户领券转化率约为98%，数据表现非常好</p>
<p>第二：用户核销转化率为70%，效果比较理想</p>
<p>第三：用户领券后复购转化率为52%，还有提升空间</p>
</section>
<section id="id24">
<h2>用户复购转化率分析<a class="headerlink" href="#id24" title="Link to this heading">#</a></h2>
<p>对于第三个现象，用券核销用户复购转化率达到52%，该部分是<strong>用户留存</strong>的重要环节</p>
<p>为了体现优惠券对用户复购的影响，统计未领券核销优惠券的用户：</p>
<p>在该部分用户中仅有约31%的用户会复购，因此一定程度上可以说明优惠券对用户复购的促进作用</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- 用券核销用户</span>
<span class="s2">with a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    Pay_date::Date as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">where Coupon_id is not null and Pay_date is not null</span>
<span class="s2">),</span>
<span class="s2">-- 用券后复购用户</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    first_date,</span>
<span class="s2">    min(Pay_date),</span>
<span class="s2">    min(datediff(&#39;day&#39;, first_date::Date, Pay_date::Date)) as inter</span>
<span class="s2">from a1</span>
<span class="s2">inner join order_detail using(User_id)</span>
<span class="s2">where order_detail.Pay_date::Date&gt;first_date::Date</span>
<span class="s2">group by User_id, first_date),</span>
<span class="s2">a3 as(</span>
<span class="s2">select </span>
<span class="s2">	inter,</span>
<span class="s2">	count(*) as r</span>
<span class="s2">from a2</span>
<span class="s2">group by inter)</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select </span>
<span class="s2">	inter as &#39;复购周期&#39;,</span>
<span class="s2">	r as &#39;复购用户数&#39;,</span>
<span class="s2">  sum(r/(select sum(r) from a3)) over(order by inter) as &#39;合计百分比&#39;</span>
<span class="s2">from a3&quot;&quot;&quot;</span>

<span class="n">avg_rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select avg(inter) as &#39;平均复购周期&#39;</span>
<span class="s2">from a2</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">avg_rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>平均复购周期</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.2528839763</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>复购周期</th>
      <th>复购用户数</th>
      <th>合计百分比</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>188198</td>
      <td>0.4283808761</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>70697</td>
      <td>0.5893031111</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>39880</td>
      <td>0.6800789395</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>26304</td>
      <td>0.7399527456</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>18296</td>
      <td>0.7815985469</td>
    </tr>
    <tr>
      <th>5</th>
      <td>6</td>
      <td>14738</td>
      <td>0.8151455418</td>
    </tr>
    <tr>
      <th>6</th>
      <td>7</td>
      <td>11935</td>
      <td>0.8423122798</td>
    </tr>
    <tr>
      <th>7</th>
      <td>8</td>
      <td>8208</td>
      <td>0.8609955295</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9</td>
      <td>6251</td>
      <td>0.8752242081</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>5339</td>
      <td>0.8873769701</td>
    </tr>
    <tr>
      <th>10</th>
      <td>11</td>
      <td>4557</td>
      <td>0.8977497246</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12</td>
      <td>4019</td>
      <td>0.9068978704</td>
    </tr>
    <tr>
      <th>12</th>
      <td>13</td>
      <td>3646</td>
      <td>0.9151969845</td>
    </tr>
    <tr>
      <th>13</th>
      <td>14</td>
      <td>3386</td>
      <td>0.9229042802</td>
    </tr>
    <tr>
      <th>14</th>
      <td>15</td>
      <td>2592</td>
      <td>0.9288042538</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16</td>
      <td>2195</td>
      <td>0.9338005663</td>
    </tr>
    <tr>
      <th>16</th>
      <td>17</td>
      <td>1921</td>
      <td>0.9381731934</td>
    </tr>
    <tr>
      <th>17</th>
      <td>18</td>
      <td>1765</td>
      <td>0.9421907294</td>
    </tr>
    <tr>
      <th>18</th>
      <td>19</td>
      <td>1562</td>
      <td>0.9457461919</td>
    </tr>
    <tr>
      <th>19</th>
      <td>20</td>
      <td>1588</td>
      <td>0.9493608362</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>短复购周期（较短的复购间隔）
优点：</p>
<p>高活跃度：客户频繁购买，说明他们对你的产品或服务有较强的需求或喜好。</p>
<p>现金流较好：短期内的频繁购买有助于保持稳定的收入流。</p>
<p>客户粘性强：说名客户愿意频繁购买</p>
<p>缺点：</p>
<p>疲劳效应：过于频繁的购买可能导致消费者感到疲劳或厌倦，尤其是产品或服务不适合长期使用。</p>
<p>市场竞争激烈：短周期复购可能说明你的竞争对手在不断刺激客户，促销活动频繁，这可能反映出市场的竞争压力较大。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">order_detail</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   1543536.0000000000
mean         40.3549852680
std          72.6524987375
min           0.0000000000
25%          18.5000000000
50%          25.4000000000
75%          39.5000000000
max       41860.0000000000
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmp</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT </span>
<span class="s2">    Coupon_type::INT AS 优惠券类型, </span>
<span class="s2">    AVG(Actual_pay) AS 用户平均实付, </span>
<span class="s2">    AVG(Reduce_amount) AS 平均优惠金额, </span>
<span class="s2">    AVG(Actual_pay + Reduce_amount)::INT AS 商品平均价格,</span>
<span class="s2">    COUNT(*)::INT AS 订单数</span>
<span class="s2">    </span>
<span class="s2">FROM order_detail</span>
<span class="s2">WHERE Coupon_type IS NOT NULL</span>
<span class="s2">GROUP BY Coupon_type</span>
<span class="s2">ORDER BY 订单数 DESC</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">tmp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>优惠券类型</th>
      <th>用户平均实付</th>
      <th>平均优惠金额</th>
      <th>商品平均价格</th>
      <th>订单数</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>31.7827865711</td>
      <td>2.3050967231</td>
      <td>34</td>
      <td>570443</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>126.2930059075</td>
      <td>7.0602147385</td>
      <td>133</td>
      <td>23191</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6</td>
      <td>42.7784862553</td>
      <td>0.0595479536</td>
      <td>43</td>
      <td>16370</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>188.9423782772</td>
      <td>1.8468000936</td>
      <td>191</td>
      <td>8544</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10010</td>
      <td>80.8479574571</td>
      <td>6.5483901378</td>
      <td>87</td>
      <td>8274</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>30.1471179125</td>
      <td>3.0172434766</td>
      <td>33</td>
      <td>5097</td>
    </tr>
    <tr>
      <th>6</th>
      <td>20014</td>
      <td>45.4999671269</td>
      <td>0.2454207758</td>
      <td>46</td>
      <td>3042</td>
    </tr>
    <tr>
      <th>7</th>
      <td>5</td>
      <td>46.6419047619</td>
      <td>8.1893552995</td>
      <td>55</td>
      <td>1302</td>
    </tr>
    <tr>
      <th>8</th>
      <td>20011</td>
      <td>123.4682704692</td>
      <td>9.0185556578</td>
      <td>132</td>
      <td>1087</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0</td>
      <td>243.2794994675</td>
      <td>2.6240681576</td>
      <td>246</td>
      <td>939</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10012</td>
      <td>121.6245054945</td>
      <td>14.6184203297</td>
      <td>136</td>
      <td>728</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10</td>
      <td>52.2033649289</td>
      <td>3.8614691943</td>
      <td>56</td>
      <td>422</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10015</td>
      <td>0.0492441860</td>
      <td>4.8580813953</td>
      <td>5</td>
      <td>172</td>
    </tr>
    <tr>
      <th>13</th>
      <td>20013</td>
      <td>43.7194957983</td>
      <td>2.5482352941</td>
      <td>46</td>
      <td>119</td>
    </tr>
    <tr>
      <th>14</th>
      <td>9</td>
      <td>37.5526881720</td>
      <td>8.9276344086</td>
      <td>46</td>
      <td>93</td>
    </tr>
    <tr>
      <th>15</th>
      <td>11</td>
      <td>72.7671428571</td>
      <td>3.5571428571</td>
      <td>76</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建 FacetGrid，根据 Coupon_type 进行分面绘图</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">order_detail</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;Coupon_type&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 绘制直方图，自动分箱</span>
<span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="s2">&quot;Actual_pay&quot;</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;skyblue&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

<span class="c1"># 设置标题和标签</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;Actual Pay&quot;</span><span class="p">,</span> <span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_titles</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{col_name}</span><span class="s2"> Coupon Type&quot;</span><span class="p">)</span>  <span class="c1"># 每个子图动态标题</span>

<span class="c1"># 设置整体标题</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>  <span class="c1"># 调整子图之间的间隙</span>
<span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Price Distribution by Coupon Type&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bd201cedddd3525937995dc60feca93263d76c963ee62c136e0b03323fb17a0f.png" src="_images/bd201cedddd3525937995dc60feca93263d76c963ee62c136e0b03323fb17a0f.png" />
</div>
</div>
<p>大概可以通过消费券类型区分出用户群体？</p>
</section>
<section id="id25">
<h2>通过复购率对优惠券分析<a class="headerlink" href="#id25" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">with a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    Coupon_type,</span>
<span class="s2">    Pay_date as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">qualify row_number()over(partition by User_id order by Pay_date asc) = 1</span>
<span class="s2">),</span>
<span class="s2">-- 用券后复购用户</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    a1.*exclude(Coupon_type),</span>
<span class="s2">    a1.Coupon_type as Coupon_type,</span>
<span class="s2">    if(order_detail.User_id is not null, 1, 0) AS 是否复购</span>
<span class="s2">from a1</span>
<span class="s2">left join </span>
<span class="s2">(</span>
<span class="s2">    select * from order_detail</span>
<span class="s2">    where Coupon_id is not null</span>
<span class="s2">) as order_detail</span>
<span class="s2">on a1.User_id = order_detail.User_id and order_detail.Pay_date	&gt; first_date</span>
<span class="s2">)</span>
<span class="s2">select sum(是否复购) * 100 / count(*) as 复购率, count(*) as 使用次数, Coupon_type from a2</span>
<span class="s2">group by 3</span>
<span class="s2">order by 2 desc</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>复购率</th>
      <th>使用次数</th>
      <th>Coupon_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>99.0586960818</td>
      <td>546476</td>
      <td>1.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>92.0333649668</td>
      <td>20021</td>
      <td>3.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>95.9482521332</td>
      <td>18165</td>
      <td>6.0000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>96.1189663579</td>
      <td>10255</td>
      <td>4.0000000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>87.0319634703</td>
      <td>4380</td>
      <td>10010.0000000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>98.1132075472</td>
      <td>2756</td>
      <td>2.0000000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>99.5024875622</td>
      <td>1206</td>
      <td>5.0000000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>94.5825932504</td>
      <td>1126</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>82.7225130890</td>
      <td>764</td>
      <td>20014.0000000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>97.2752043597</td>
      <td>734</td>
      <td>10012.0000000000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>99.3920972644</td>
      <td>329</td>
      <td>10.0000000000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>68.2481751825</td>
      <td>274</td>
      <td>10015.0000000000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>95.3781512605</td>
      <td>238</td>
      <td>9.0000000000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>59.1836734694</td>
      <td>196</td>
      <td>20011.0000000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>100.0000000000</td>
      <td>133</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>15</th>
      <td>16.6666666667</td>
      <td>6</td>
      <td>20013.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id26">
<h2>通过使用速度分层<a class="headerlink" href="#id26" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_detail_Coupon_info</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SELECT </span>
<span class="sd">       *,</span>
<span class="sd">       LEAST(2, (Pay_date::DATE-GREATEST(Start_date::DATE, Receive_date::DATE))/(End_date::DATE-Pay_date::DATE)) AS speed,</span>
<span class="sd">       case </span>
<span class="sd">       when speed &lt;= 1 or speed = &#39;NAN&#39; then -1</span>
<span class="sd">       when speed &gt; 1 then 1</span>
<span class="sd">       end AS Frequency_consumption</span>
<span class="sd">FROM order_detail</span>
<span class="sd">JOIN user_coupon_receive USING(User_id, Coupon_id)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- 用券核销用户</span>
<span class="s2">with a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    Pay_date::Date as first_date</span>
<span class="s2">from order_detail_Coupon_info</span>
<span class="s2">where Coupon_id is not null and Pay_date is not null</span>
<span class="s2">),</span>
<span class="s2">-- 用券后复购用户</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    first_date,</span>
<span class="s2">    max(Frequency_consumption) as Frequency_consumption,</span>
<span class="s2">    min(Pay_date),</span>
<span class="s2">    min(datediff(&#39;day&#39;, first_date::Date, Pay_date::Date)) as inter</span>
<span class="s2">from a1</span>
<span class="s2">inner join order_detail_Coupon_info using(User_id)</span>
<span class="s2">where order_detail_Coupon_info.Pay_date::Date&gt;first_date::Date</span>
<span class="s2">group by User_id, first_date),</span>
<span class="s2">a3 as(</span>
<span class="s2">select </span>
<span class="s2">	inter,</span>
<span class="s2">    Frequency_consumption,</span>
<span class="s2">	count(*) as r</span>
<span class="s2">from a2</span>
<span class="s2">group by inter,Frequency_consumption)</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select</span>
<span class="s2">    Frequency_consumption,</span>
<span class="s2">	inter as &#39;复购周期&#39;,</span>
<span class="s2">	r as &#39;复购用户数&#39;,</span>
<span class="s2">  sum(r/(select sum(r) from a3)) over(order by inter) as &#39;合计百分比&#39;</span>
<span class="s2">from a3</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">avg_rebuy</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select Frequency_consumption, avg(inter) as &#39;平均复购周期&#39;</span>
<span class="s2">from a2</span>
<span class="s2">group by 1</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">avg_rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

<span class="n">display</span><span class="p">(</span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Frequency_consumption</th>
      <th>平均复购周期</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>13.6966538018</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1</td>
      <td>21.1903424190</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Frequency_consumption</th>
      <th>复购周期</th>
      <th>复购用户数</th>
      <th>合计百分比</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>6763</td>
      <td>0.1218802214</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1</td>
      <td>1</td>
      <td>2574</td>
      <td>0.1218802214</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2</td>
      <td>5053</td>
      <td>0.2139332707</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-1</td>
      <td>2</td>
      <td>1999</td>
      <td>0.2139332707</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>3</td>
      <td>4106</td>
      <td>0.2882205514</td>
    </tr>
    <tr>
      <th>5</th>
      <td>-1</td>
      <td>3</td>
      <td>1585</td>
      <td>0.2882205514</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>4</td>
      <td>3245</td>
      <td>0.3481359649</td>
    </tr>
    <tr>
      <th>7</th>
      <td>-1</td>
      <td>4</td>
      <td>1345</td>
      <td>0.3481359649</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>5</td>
      <td>2789</td>
      <td>0.3996188388</td>
    </tr>
    <tr>
      <th>9</th>
      <td>-1</td>
      <td>5</td>
      <td>1155</td>
      <td>0.3996188388</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1</td>
      <td>6</td>
      <td>2460</td>
      <td>0.4456584169</td>
    </tr>
    <tr>
      <th>11</th>
      <td>-1</td>
      <td>6</td>
      <td>1067</td>
      <td>0.4456584169</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1</td>
      <td>7</td>
      <td>2214</td>
      <td>0.4873120301</td>
    </tr>
    <tr>
      <th>13</th>
      <td>-1</td>
      <td>7</td>
      <td>977</td>
      <td>0.4873120301</td>
    </tr>
    <tr>
      <th>14</th>
      <td>-1</td>
      <td>8</td>
      <td>842</td>
      <td>0.5221517335</td>
    </tr>
    <tr>
      <th>15</th>
      <td>1</td>
      <td>8</td>
      <td>1827</td>
      <td>0.5221517335</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1</td>
      <td>9</td>
      <td>1564</td>
      <td>0.5521486007</td>
    </tr>
    <tr>
      <th>17</th>
      <td>-1</td>
      <td>9</td>
      <td>734</td>
      <td>0.5521486007</td>
    </tr>
    <tr>
      <th>18</th>
      <td>-1</td>
      <td>10</td>
      <td>629</td>
      <td>0.5782555347</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>10</td>
      <td>1371</td>
      <td>0.5782555347</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 339 entries, 0 to 338
Data columns (total 4 columns):
 #   Column                 Non-Null Count  Dtype  
---  ------                 --------------  -----  
 0   Frequency_consumption  339 non-null    int32  
 1   复购周期                   339 non-null    int64  
 2   复购用户数                  339 non-null    int64  
 3   合计百分比                  339 non-null    float64
dtypes: float64(1), int32(1), int64(2)
memory usage: 9.4 KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sql</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">rebuy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">&#39;复购周期&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;复购用户数&#39;</span><span class="p">,</span> <span class="n">hue</span> <span class="o">=</span> <span class="s1">&#39;Frequency_consumption&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;复购周期&#39;, ylabel=&#39;复购用户数&#39;&gt;
</pre></div>
</div>
<img alt="_images/6c1a5d866a48babae2ef0dfaba8f5f1be0ef6eb9de4bd41a35970676eb13c359.png" src="_images/6c1a5d866a48babae2ef0dfaba8f5f1be0ef6eb9de4bd41a35970676eb13c359.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="rfm">
<h1>RFM用户价值分析<a class="headerlink" href="#rfm" title="Link to this heading">#</a></h1>
<p>通过RFM的这三个指标来建立xyz轴，用这三个维度来划分不同的用户，针对不同分类的用户来进行更加精细的运营，重新定义RFM，具体如下：</p>
<p>R：指用户最近一次购买离表中最近日期的距离</p>
<p>F：指用户购买次数进行指代</p>
<p>M：指用户用券后实际消费金额，例如200:20的优惠券，M = 200-20</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># R：最近用券消费消费时间</span>
<span class="c1"># F：用券消费频率</span>
<span class="c1"># M：用券实际消费金额</span>
<span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">		User_id as &#39;用户ID&#39;,</span>
<span class="s2">		DATEDIFF(&#39;day&#39;, max(Pay_date)::Date, &#39;2023-06-30&#39;::Date) as R,</span>
<span class="s2">		count(*) as F,</span>
<span class="s2">		round(avg(Actual_pay),2) as M </span>
<span class="s2">FROM order_detail</span>
<span class="s2">group by User_id &quot;&quot;&quot;</span>
<span class="n">RFM</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<span class="n">RFM</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户ID</th>
      <th>R</th>
      <th>F</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>44782be9c360d5f806d1d60faa3f0b3a</td>
      <td>2</td>
      <td>125</td>
      <td>34.3600000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>495066eb5297c98d87368b9f7b3ccfb5</td>
      <td>0</td>
      <td>132</td>
      <td>18.6600000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>74cdfb1ef06e8c31831df411887b7293</td>
      <td>0</td>
      <td>633</td>
      <td>56.5000000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5e5d960aff5d0254eff1dd6ca05613fb</td>
      <td>1</td>
      <td>156</td>
      <td>32.2500000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5e44f2eb9b56827200dcfca21040ea8c</td>
      <td>0</td>
      <td>41</td>
      <td>71.7500000000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>47203</th>
      <td>6a264405a916a4a95698ab78d34a19f2</td>
      <td>13</td>
      <td>1</td>
      <td>14.9000000000</td>
    </tr>
    <tr>
      <th>47204</th>
      <td>c8dcf989f71da0085a188d5ecca9a5a2</td>
      <td>86</td>
      <td>1</td>
      <td>69.9000000000</td>
    </tr>
    <tr>
      <th>47205</th>
      <td>b8b96d2d86577d2a9624114525df6be5</td>
      <td>151</td>
      <td>1</td>
      <td>26.8000000000</td>
    </tr>
    <tr>
      <th>47206</th>
      <td>adbd4f9aec407eff36bccf77b5ad9e07</td>
      <td>44</td>
      <td>1</td>
      <td>241.0000000000</td>
    </tr>
    <tr>
      <th>47207</th>
      <td>5031a5f6309bce260a57a8526a9cf510</td>
      <td>13</td>
      <td>1</td>
      <td>21.4800000000</td>
    </tr>
  </tbody>
</table>
<p>47208 rows × 4 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RFM</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>R</th>
      <th>F</th>
      <th>M</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>47208.0000000000</td>
      <td>47208.0000000000</td>
      <td>47208.0000000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>36.2260210134</td>
      <td>32.6964921200</td>
      <td>51.3548080834</td>
    </tr>
    <tr>
      <th>std</th>
      <td>45.5094999753</td>
      <td>58.0147054336</td>
      <td>69.9930663422</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.0000000000</td>
      <td>1.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>3.0000000000</td>
      <td>3.0000000000</td>
      <td>22.9000000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>15.0000000000</td>
      <td>10.0000000000</td>
      <td>34.1100000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>55.0000000000</td>
      <td>37.0000000000</td>
      <td>56.7025000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>180.0000000000</td>
      <td>942.0000000000</td>
      <td>3680.0000000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>25%的人在5天内有过消费</p>
<section id="id27">
<h2>1️⃣ RFM 数据分布：直方图<a class="headerlink" href="#id27" title="Link to this heading">#</a></h2>
<p>目的：观察 R、F、M 的分布情况，识别偏态、离群点。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置画布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># 直方图绘制 RFM 三个指标的分布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Recency 分布&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Frequency 分布&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Monetary 分布&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5c04229f164f867c48ce6abc9981b6c16bac6917b4509dc4fcbcb6a9af61c2cb.png" src="_images/5c04229f164f867c48ce6abc9981b6c16bac6917b4509dc4fcbcb6a9af61c2cb.png" />
</div>
</div>
</section>
<section id="id28">
<h2>2️⃣ RFM 三变量关系：散点图<a class="headerlink" href="#id28" title="Link to this heading">#</a></h2>
<p>目的：观察 R、F、M 三者之间的关系，比如消费次数和消费金额的相关性。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">RFM</span><span class="p">,</span> <span class="n">diag_kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span> <span class="n">plot_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;RFM 变量关系&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/872b3c0b2aaeb363614aad01434a4c990351afbda6591627e97c964f6662649d.png" src="_images/872b3c0b2aaeb363614aad01434a4c990351afbda6591627e97c964f6662649d.png" />
</div>
</div>
</section>
<section id="rfm-k-means">
<h2>3️⃣ RFM 分群：K-Means 聚类<a class="headerlink" href="#rfm-k-means" title="Link to this heading">#</a></h2>
<p>目的：将用户按 RFM 评分分成不同群体，观察高价值用户、低价值用户的分布情况。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 数据标准化</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">RFM_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">RFM</span><span class="p">[[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]])</span>

<span class="c1"># K-Means 聚类</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;Cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">RFM_scaled</span><span class="p">)</span>

<span class="c1"># 可视化不同群体的分布</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">RFM</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;用户群体划分（基于 RFM 聚类）&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6b2e9c7d4a8825d93ae3a4538906333550af9fbdbdb4b829d227e8208d6d0979.png" src="_images/6b2e9c7d4a8825d93ae3a4538906333550af9fbdbdb4b829d227e8208d6d0979.png" />
</div>
</div>
<p>📌 解释：</p>
<p>使用 KMeans 进行聚类，分成 4 个用户群体。</p>
<p>通过 scatterplot() 观察 购买频次（F）和消费金额（M） 的聚类情况。</p>
</section>
<section id="id29">
<h2>4️⃣ 各群体的 RFM 指标箱线图<a class="headerlink" href="#id29" title="Link to this heading">#</a></h2>
<p>目的：比较不同用户群体的 RFM 指标分布，找出高价值用户与低价值用户的差异。</p>
<p>📌 解释：</p>
<p>boxplot() 可以看出不同群体的 RFM 值分布，发现异常值或极端用户。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">RFM</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> 分布（按用户群体）&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f322a0d2752e93370ed53599d8e91732b1dc924ccdcc33ef32a2b856c3c68b44.png" src="_images/f322a0d2752e93370ed53599d8e91732b1dc924ccdcc33ef32a2b856c3c68b44.png" />
</div>
</div>
</section>
<section id="id30">
<h2>5️⃣ RFM 得分热力图<a class="headerlink" href="#id30" title="Link to this heading">#</a></h2>
<p>目的：查看不同 R、F、M 组合的用户分布，发现最优用户群。</p>
<p>📌 解释：</p>
<p>qcut() 将 R、F、M 分为 4 个评分（1-4），4 代表高价值用户。</p>
<p>heatmap() 直观显示 R-F 组合的用户消费金额（M）。</p>
<p>可以看到哪些群体的用户消费能力最强。</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RFM 评分（按百分位数）</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;R_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;F_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;M_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">RFM</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="c1"># 计算 R 和 F 组合的平均 M 值</span>
<span class="n">rfm_pivot</span> <span class="o">=</span> <span class="n">RFM</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;R_score&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;F_score&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>

<span class="c1"># 绘制热力图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">rfm_pivot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;R-F 组合的 M 平均值&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d74c34d1f9deba5466a01fcf3f8806246ada7bd07922d21004423c871c7752ec.png" src="_images/d74c34d1f9deba5466a01fcf3f8806246ada7bd07922d21004423c871c7752ec.png" />
</div>
</div>
</section>
<section id="id31">
<h2>用户价值分类统计<a class="headerlink" href="#id31" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">with DESC_RFM20 as(</span>
<span class="s2">SELECT </span>
<span class="s2">	R,F,M,</span>
<span class="s2">	PERCENT_RANK() over ( ORDER BY R ) AS PERCENT_R,</span>
<span class="s2">	PERCENT_RANK() over ( ORDER BY F DESC ) AS PERCENT_F, </span>
<span class="s2">	PERCENT_RANK() over ( ORDER BY M DESC ) AS PERCENT_M</span>
<span class="s2">FROM RFM)</span>

<span class="s2">SELECT &#39;R&#39; as tag, MAX(R) as &#39;阈值&#39;</span>
<span class="s2">FROM DESC_RFM20</span>
<span class="s2">WHERE PERCENT_R&lt;=0.20</span>
<span class="s2">UNION </span>
<span class="s2">SELECT &#39;F&#39; as tag, MIN(F) as &#39;阈值&#39;</span>
<span class="s2">FROM DESC_RFM20</span>
<span class="s2">WHERE PERCENT_F&lt;=0.2</span>
<span class="s2">UNION</span>
<span class="s2">SELECT &#39;M&#39; as tag, MIN(M) as &#39;阈值&#39;</span>
<span class="s2">FROM DESC_RFM20</span>
<span class="s2">WHERE PERCENT_M&lt;=0.2</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tag</th>
      <th>阈值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>F</td>
      <td>48.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>R</td>
      <td>2.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>M</td>
      <td>65.6200000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select </span>
<span class="s2">coalesce(RFM.用户ID, tmp.用户ID) as 用户ID,</span>
<span class="s2">case when R&lt;=5 and F&gt;=28 and M&gt;=76.86 then &#39;重要价值客户&#39;</span>
<span class="s2">when R&lt;=5 and F&gt;=28 and M&lt;76.86 then &#39;一般价值客户&#39;</span>
<span class="s2">when R&lt;=5 and F&lt;28 and M&gt;=76.86 then &#39;重要发展客户&#39;</span>
<span class="s2">when R&lt;=5 and F&lt;28 and M&lt;76.86 then &#39;一般发展客户&#39;</span>
<span class="s2">when R&gt;5 and F&gt;=28 and M&gt;=76.86 then &#39;重要唤回客户&#39;</span>
<span class="s2">when R&gt;5 and F&gt;=28 and M&lt;76.86 then &#39;一般唤回客户&#39;</span>
<span class="s2">when R&gt;5 and F&lt;28 and M&gt;=76.86 then &#39;重要挽留客户&#39;</span>
<span class="s2">when R&gt;5 and F&lt;28 and M&lt;76.86 then &#39;一般挽留客户&#39;</span>
<span class="s2">when R is null then &#39;不存在消费记录的用户&#39;</span>
<span class="s2">end as &#39;用户价值族群&#39;</span>
<span class="s2">from RFM</span>
<span class="s2">FULL join (select distinct User_id 用户ID from user_coupon_receive) tmp on RFM.用户ID = tmp.用户ID</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">user_RFM</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

<span class="n">user_RFM</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户ID</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0e22c035960968d76081373133fdf55e</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>1</th>
      <td>78a95eb83301f5f727f6141c8bb798a2</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>2</th>
      <td>6121622ad0d46fd2ea8d11fdbe761686</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <th>3</th>
      <td>e3465919afd0c4e52c0db3506e0f0e36</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>4</th>
      <td>e3c0372a7c967f12b721b2c3213b98db</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>49668</th>
      <td>edae8f646ef36f3146736735af306d6d</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>49669</th>
      <td>8d2a60a7283d2462ec8e3c545af66d3a</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>49670</th>
      <td>27ede92657665505db524f15cf6bdc3b</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <th>49671</th>
      <td>adbd4f9aec407eff36bccf77b5ad9e07</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <th>49672</th>
      <td>5031a5f6309bce260a57a8526a9cf510</td>
      <td>一般挽留客户</td>
    </tr>
  </tbody>
</table>
<p>49673 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select 用户价值族群,count(用户ID) as 用户数,</span>
<span class="s2">concat(round(count(用户ID)/(SELECT COUNT(*) FROM user_RFM)*100,2),&#39;%&#39;) as 用户数占比</span>
<span class="s2">from user_RFM</span>
<span class="s2">group by 用户价值族群</span>
<span class="s2">order by 用户价值族群;&quot;&quot;&quot;</span>

<span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户价值族群</th>
      <th>用户数</th>
      <th>用户数占比</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>一般价值客户</td>
      <td>8772</td>
      <td>17.66%</td>
    </tr>
    <tr>
      <th>1</th>
      <td>一般发展客户</td>
      <td>4740</td>
      <td>9.54%</td>
    </tr>
    <tr>
      <th>2</th>
      <td>一般唤回客户</td>
      <td>4521</td>
      <td>9.1%</td>
    </tr>
    <tr>
      <th>3</th>
      <td>一般挽留客户</td>
      <td>21870</td>
      <td>44.03%</td>
    </tr>
    <tr>
      <th>4</th>
      <td>不存在消费记录的用户</td>
      <td>2465</td>
      <td>4.96%</td>
    </tr>
    <tr>
      <th>5</th>
      <td>重要价值客户</td>
      <td>618</td>
      <td>1.24%</td>
    </tr>
    <tr>
      <th>6</th>
      <td>重要发展客户</td>
      <td>834</td>
      <td>1.68%</td>
    </tr>
    <tr>
      <th>7</th>
      <td>重要唤回客户</td>
      <td>345</td>
      <td>0.69%</td>
    </tr>
    <tr>
      <th>8</th>
      <td>重要挽留客户</td>
      <td>5508</td>
      <td>11.09%</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id32">
<h1>RFM + 用户转化分析<a class="headerlink" href="#id32" title="Link to this heading">#</a></h1>
<section id="id33">
<h2>不同价值族群的转化漏斗<a class="headerlink" href="#id33" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>

<span class="s1">select</span>
<span class="s1">    count(distinct User_id) as getcoupons_users</span>
<span class="s1">    ,用户价值族群</span>
<span class="s1">from user_coupon_receive</span>
<span class="s1">left join user_RFM on User_id = 用户ID</span>
<span class="s1">where Coupon_id is not null</span>
<span class="s1">group by 2</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>┌──────────────────┬──────────────────────┐
│ getcoupons_users │     用户价值族群     │
│      int64       │       varchar        │
├──────────────────┼──────────────────────┤
│             4649 │ 一般发展客户         │
│             4518 │ 一般唤回客户         │
│             5360 │ 重要挽留客户         │
│             2464 │ 不存在消费记录的用户 │
│              824 │ 重要发展客户         │
│            21211 │ 一般挽留客户         │
│              345 │ 重要唤回客户         │
│             8771 │ 一般价值客户         │
│              618 │ 重要价值客户         │
└──────────────────┴──────────────────────┘
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">-- 所有用户</span>
<span class="s2">with t1 as </span>
<span class="s2">(</span>
<span class="s2">    select</span>
<span class="s2">         count(distinct User_id) as all_users,用户价值族群</span>
<span class="s2">     from (</span>
<span class="s2">         SELECT * FROM</span>
<span class="s2">         (</span>
<span class="s2">          select User_id from order_detail</span>
<span class="s2">          union all</span>
<span class="s2">          select User_id from user_visit_detail</span>
<span class="s2">          union all</span>
<span class="s2">          select User_id from user_coupon_receive</span>
<span class="s2">         ) left join user_RFM on User_id = 用户ID</span>
<span class="s2">     )</span>
<span class="s2">     group by 2</span>
<span class="s2">),</span>
<span class="s2">-- 领券用户</span>
<span class="s2">t2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as getcoupons_users</span>
<span class="s2">    ,用户价值族群</span>
<span class="s2">from user_coupon_receive</span>
<span class="s2">left join user_RFM on User_id = 用户ID</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">group by 2</span>
<span class="s2">),</span>
<span class="s2">-- 首次用券核销用户</span>
<span class="s2">a1 as(</span>
<span class="s2">select</span>
<span class="s2">    User_id,</span>
<span class="s2">    用户价值族群,</span>
<span class="s2">    min(Pay_date) as first_date</span>
<span class="s2">from order_detail</span>
<span class="s2">left join user_RFM on User_id = 用户ID</span>
<span class="s2">where Coupon_id is not null</span>
<span class="s2">group by User_id, 用户价值族群),</span>
<span class="s2">-- 用券后复购用户</span>
<span class="s2">a2 as(</span>
<span class="s2">select</span>
<span class="s2">    count(distinct User_id) as second_user,</span>
<span class="s2">    用户价值族群</span>
<span class="s2">from a1</span>
<span class="s2">inner join </span>
<span class="s2">(</span>
<span class="s2">    select * from order_detail</span>
<span class="s2">    where Coupon_id is not null</span>
<span class="s2">) as order_detail</span>
<span class="s2">using(User_id)</span>
<span class="s2">where order_detail.Pay_date	&gt;first_date</span>
<span class="s2">group by 2</span>
<span class="s2">)</span>
<span class="s2">SELECT </span>
<span class="s2">    t1.用户价值族群,</span>
<span class="s2">    t1.all_users AS 全体用户,</span>
<span class="s2">    getcoupons_users AS 领券用户,</span>
<span class="s2">    coalesce(首次用券核销用户, 0) AS 首次用券核销用户 ,</span>
<span class="s2">    coalesce(second_user, 0) AS 用券后复购用户</span>
<span class="s2">    </span>
<span class="s2">FROM </span>
<span class="s2">    t1</span>
<span class="s2">LEFT JOIN </span>
<span class="s2">    t2</span>
<span class="s2">ON t1.用户价值族群 = t2.用户价值族群</span>
<span class="s2">LEFT JOIN </span>
<span class="s2">    (SELECT COUNT(DISTINCT User_id) AS 首次用券核销用户, 用户价值族群 FROM a1 GROUP BY 用户价值族群) AS a1_data</span>
<span class="s2">ON t1.用户价值族群 = a1_data.用户价值族群</span>
<span class="s2">LEFT JOIN a2</span>
<span class="s2">ON t1.用户价值族群 = a2.用户价值族群</span>
<span class="s2">WHERE t1.用户价值族群	is not null</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户价值族群</th>
      <th>全体用户</th>
      <th>领券用户</th>
      <th>首次用券核销用户</th>
      <th>用券后复购用户</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>一般发展客户</td>
      <td>4740</td>
      <td>4649</td>
      <td>3378</td>
      <td>2471</td>
    </tr>
    <tr>
      <th>1</th>
      <td>一般价值客户</td>
      <td>8772</td>
      <td>8771</td>
      <td>8559</td>
      <td>8382</td>
    </tr>
    <tr>
      <th>2</th>
      <td>重要价值客户</td>
      <td>618</td>
      <td>618</td>
      <td>604</td>
      <td>589</td>
    </tr>
    <tr>
      <th>3</th>
      <td>一般唤回客户</td>
      <td>4521</td>
      <td>4518</td>
      <td>4390</td>
      <td>4272</td>
    </tr>
    <tr>
      <th>4</th>
      <td>重要挽留客户</td>
      <td>5508</td>
      <td>5360</td>
      <td>4002</td>
      <td>1930</td>
    </tr>
    <tr>
      <th>5</th>
      <td>重要发展客户</td>
      <td>834</td>
      <td>824</td>
      <td>677</td>
      <td>481</td>
    </tr>
    <tr>
      <th>6</th>
      <td>一般挽留客户</td>
      <td>21870</td>
      <td>21211</td>
      <td>12872</td>
      <td>7475</td>
    </tr>
    <tr>
      <th>7</th>
      <td>重要唤回客户</td>
      <td>345</td>
      <td>345</td>
      <td>339</td>
      <td>324</td>
    </tr>
    <tr>
      <th>8</th>
      <td>不存在消费记录的用户</td>
      <td>2465</td>
      <td>2464</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 获取所有用户类型</span>
<span class="n">user_types</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;用户价值族群&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># 设置子图布局（2 列）</span>
<span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_types</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># 计算行数</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">subplot_titles</span><span class="o">=</span><span class="n">user_types</span><span class="p">)</span>

<span class="c1"># 定义颜色方案</span>
<span class="n">color_palette</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FFD500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffc000&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffab00&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff9500&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff8000&#39;</span><span class="p">]</span>
<span class="n">line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;wheat&quot;</span><span class="p">]</span>
<span class="c1"># 遍历每个用户类型并绘制漏斗图</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">funnel_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;阶段&quot;</span><span class="p">:</span> <span class="s2">&quot;全体用户&quot;</span><span class="p">,</span> <span class="s2">&quot;人数&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;全体用户&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;阶段&quot;</span><span class="p">:</span> <span class="s2">&quot;领券用户&quot;</span><span class="p">,</span> <span class="s2">&quot;人数&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;领券用户&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;阶段&quot;</span><span class="p">:</span> <span class="s2">&quot;首次用券核销用户&quot;</span><span class="p">,</span> <span class="s2">&quot;人数&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;首次用券核销用户&quot;</span><span class="p">]},</span>
        <span class="p">{</span><span class="s2">&quot;阶段&quot;</span><span class="p">:</span> <span class="s2">&quot;用券后复购用户&quot;</span><span class="p">,</span> <span class="s2">&quot;人数&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;用券后复购用户&quot;</span><span class="p">]}</span>
    <span class="p">]</span>
    <span class="n">funnel_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">funnel_data</span><span class="p">)</span>

    <span class="c1"># 计算相对初始值的百分比</span>
    <span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;percent_initial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;人数&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;人数&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Funnel</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;人数&quot;</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">funnel_df</span><span class="p">[</span><span class="s2">&quot;阶段&quot;</span><span class="p">],</span>
        <span class="n">textinfo</span><span class="o">=</span><span class="s2">&quot;value+percent initial&quot;</span><span class="p">,</span>
        <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;inside&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color_palette</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">funnel_df</span><span class="p">)],</span>  <span class="c1"># 限制颜色数量</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">funnel_df</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">line_colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">funnel_df</span><span class="p">)])</span>
        <span class="p">),</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
        <span class="n">connector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;用户价值族群&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># 确定子图位置</span>
    <span class="n">row_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">col_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row_num</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col_num</span><span class="p">)</span>

<span class="c1"># **调整图表尺寸，防止显示不全**</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;📊 不同用户价值族群的转化漏斗&quot;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkblue&quot;</span><span class="p">)),</span>
    <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">),</span>
    <span class="n">height</span><span class="o">=</span><span class="n">rows</span> <span class="o">*</span> <span class="mi">600</span><span class="p">,</span>  <span class="c1"># **动态调整高度**</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1400</span><span class="p">,</span>  <span class="c1"># **加宽图表**</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">80</span><span class="p">),</span>  <span class="c1"># **增加边距，防止裁剪**</span>
    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># 关闭全局图例</span>
<span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>复购率: 一般挽留客户(34%) &lt; 重要挽留客户(35%) &lt; 一般发展客户(52%) &lt; 重要发展客户(58%)</p>
<p>其中一般挽留客户占总客户的44%, <strong>是需要重点关注的目标</strong></p>
<ol class="arabic simple">
<li><p>是不是人均领券次数太少了？</p></li>
<li><p>优惠力度不够？优惠占比小？</p></li>
<li><p>优惠门槛高？</p></li>
<li><p>消费水平和消费券的优惠差距过大（分差）</p></li>
</ol>
</section>
<section id="id34">
<h2>不同用户价值族群的消费分布<a class="headerlink" href="#id34" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select t1.*, t2.用户价值族群 from order_detail t1</span>
<span class="s1">left join user_RFM t2 on t1.User_id = t2.用户ID</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置样式</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>


<span class="c1"># 指定一个支持中文的字体 (如 SimHei)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimHei&#39;</span><span class="p">]</span>  <span class="c1"># 或 &#39;Microsoft YaHei&#39;, &#39;Arial Unicode MS&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 解决负号显示问题</span>

<span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;重要挽留客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;重要发展客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;一般挽留客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;一般发展客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#FF9900&quot;</span><span class="p">,</span>
    <span class="s2">&quot;一般价值客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;一般唤回客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;重要价值客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;重要唤回客户&quot;</span><span class="p">:</span> <span class="s2">&quot;#0066FF&quot;</span>
<span class="p">}</span>


<span class="c1"># 创建画布</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Actual_pay_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Actual_pay&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">])</span>
<span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">])</span>

<span class="c1"># 绘制 Actual_pay 的小提琴图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;用户价值族群&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Actual_pay_log&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">wide_df</span><span class="p">[</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
               <span class="n">palette</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;不同用户价值族群的 消费能力 分布&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Actual Pay&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># 绘制 Reduce_amount 的小提琴图</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;用户价值族群&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Reduce_amount_log&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">wide_df</span><span class="p">[</span><span class="n">wide_df</span><span class="p">[</span><span class="s1">&#39;Reduce_amount&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
               <span class="n">palette</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;不同用户价值族群的 优惠金额 分布&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Reduce Amount&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="c1"># 添加网格</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="c1"># 调整布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d2687d16c7cee5808a4fab7ae9b30bb3b2d189ed60e9ab44fce8926f378365e2.png" src="_images/d2687d16c7cee5808a4fab7ae9b30bb3b2d189ed60e9ab44fce8926f378365e2.png" />
</div>
</div>
<p>结论:</p>
<ol class="arabic simple">
<li><p>横线代表中位数，一般挽留客户消费水平处于中间位置，其中也有少部分人消费水平低于其他群体。</p></li>
<li><p>领到券的人，一般挽留客户的优惠水平略低于其他群体</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        用户价值族群, </span>
<span class="s1">        coupon_type,</span>
<span class="s1">        count(*) as 消费次数, </span>
<span class="s1">        sum(if(reduce_amount &gt; 0, 1, 0)) as 优惠次数,</span>
<span class="s1">        sum(reduce_amount) * 100 / sum(actual_pay + reduce_amount) as 优惠比例</span>
<span class="s1">from wide_df</span>
<span class="s1">group by 1, 2</span>
<span class="s1">order by 优惠次数 asc</span>
<span class="s1">LIMIT 50</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户价值族群</th>
      <th>Coupon_type</th>
      <th>消费次数</th>
      <th>优惠次数</th>
      <th>优惠比例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>重要价值客户</td>
      <td>6.0000000000</td>
      <td>357</td>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>重要唤回客户</td>
      <td>6.0000000000</td>
      <td>220</td>
      <td>0.0000000000</td>
      <td>0.0000000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>重要发展客户</td>
      <td>6.0000000000</td>
      <td>279</td>
      <td>1.0000000000</td>
      <td>0.0039345325</td>
    </tr>
    <tr>
      <th>3</th>
      <td>重要挽留客户</td>
      <td>9.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>11.2026976396</td>
    </tr>
    <tr>
      <th>4</th>
      <td>重要发展客户</td>
      <td>20013.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>1.9000000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>一般发展客户</td>
      <td>0.0000000000</td>
      <td>14</td>
      <td>1.0000000000</td>
      <td>0.7675814532</td>
    </tr>
    <tr>
      <th>6</th>
      <td>重要唤回客户</td>
      <td>20014.0000000000</td>
      <td>35</td>
      <td>1.0000000000</td>
      <td>0.0564652739</td>
    </tr>
    <tr>
      <th>7</th>
      <td>重要发展客户</td>
      <td>9.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>8.1147040879</td>
    </tr>
    <tr>
      <th>8</th>
      <td>一般发展客户</td>
      <td>4.0000000000</td>
      <td>209</td>
      <td>1.0000000000</td>
      <td>0.9800932592</td>
    </tr>
    <tr>
      <th>9</th>
      <td>重要价值客户</td>
      <td>10015.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>99.7142857143</td>
    </tr>
    <tr>
      <th>10</th>
      <td>一般发展客户</td>
      <td>11.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>5.0985723997</td>
    </tr>
    <tr>
      <th>11</th>
      <td>一般挽留客户</td>
      <td>4.0000000000</td>
      <td>455</td>
      <td>1.0000000000</td>
      <td>0.6873075865</td>
    </tr>
    <tr>
      <th>12</th>
      <td>重要唤回客户</td>
      <td>11.0000000000</td>
      <td>1</td>
      <td>1.0000000000</td>
      <td>2.4965672201</td>
    </tr>
    <tr>
      <th>13</th>
      <td>重要挽留客户</td>
      <td>10015.0000000000</td>
      <td>2</td>
      <td>2.0000000000</td>
      <td>99.8305084746</td>
    </tr>
    <tr>
      <th>14</th>
      <td>重要发展客户</td>
      <td>5.0000000000</td>
      <td>3</td>
      <td>2.0000000000</td>
      <td>14.4224279411</td>
    </tr>
    <tr>
      <th>15</th>
      <td>重要唤回客户</td>
      <td>0.0000000000</td>
      <td>101</td>
      <td>2.0000000000</td>
      <td>0.0553615594</td>
    </tr>
    <tr>
      <th>16</th>
      <td>重要唤回客户</td>
      <td>20013.0000000000</td>
      <td>2</td>
      <td>2.0000000000</td>
      <td>1.9000000000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>重要价值客户</td>
      <td>9.0000000000</td>
      <td>2</td>
      <td>2.0000000000</td>
      <td>9.5583787054</td>
    </tr>
    <tr>
      <th>18</th>
      <td>重要价值客户</td>
      <td>20014.0000000000</td>
      <td>107</td>
      <td>3.0000000000</td>
      <td>0.0753504739</td>
    </tr>
    <tr>
      <th>19</th>
      <td>重要挽留客户</td>
      <td>6.0000000000</td>
      <td>1132</td>
      <td>3.0000000000</td>
      <td>0.0033927776</td>
    </tr>
    <tr>
      <th>20</th>
      <td>一般唤回客户</td>
      <td>0.0000000000</td>
      <td>90</td>
      <td>3.0000000000</td>
      <td>0.1607451480</td>
    </tr>
    <tr>
      <th>21</th>
      <td>重要发展客户</td>
      <td>20014.0000000000</td>
      <td>68</td>
      <td>3.0000000000</td>
      <td>0.1146895059</td>
    </tr>
    <tr>
      <th>22</th>
      <td>重要挽留客户</td>
      <td>20013.0000000000</td>
      <td>4</td>
      <td>4.0000000000</td>
      <td>1.8074445240</td>
    </tr>
    <tr>
      <th>23</th>
      <td>重要唤回客户</td>
      <td>4.0000000000</td>
      <td>838</td>
      <td>4.0000000000</td>
      <td>0.1648535642</td>
    </tr>
    <tr>
      <th>24</th>
      <td>一般挽留客户</td>
      <td>0.0000000000</td>
      <td>34</td>
      <td>4.0000000000</td>
      <td>0.6178659368</td>
    </tr>
    <tr>
      <th>25</th>
      <td>重要发展客户</td>
      <td>10.0000000000</td>
      <td>5</td>
      <td>5.0000000000</td>
      <td>4.4132790663</td>
    </tr>
    <tr>
      <th>26</th>
      <td>重要发展客户</td>
      <td>4.0000000000</td>
      <td>359</td>
      <td>5.0000000000</td>
      <td>2.1766331651</td>
    </tr>
    <tr>
      <th>27</th>
      <td>一般价值客户</td>
      <td>11.0000000000</td>
      <td>5</td>
      <td>5.0000000000</td>
      <td>5.6787538466</td>
    </tr>
    <tr>
      <th>28</th>
      <td>一般唤回客户</td>
      <td>4.0000000000</td>
      <td>966</td>
      <td>5.0000000000</td>
      <td>0.9737230097</td>
    </tr>
    <tr>
      <th>29</th>
      <td>重要价值客户</td>
      <td>4.0000000000</td>
      <td>1375</td>
      <td>5.0000000000</td>
      <td>0.1742538029</td>
    </tr>
    <tr>
      <th>30</th>
      <td>重要唤回客户</td>
      <td>10.0000000000</td>
      <td>6</td>
      <td>6.0000000000</td>
      <td>5.6299484008</td>
    </tr>
    <tr>
      <th>31</th>
      <td>重要发展客户</td>
      <td>0.0000000000</td>
      <td>49</td>
      <td>8.0000000000</td>
      <td>0.7047541745</td>
    </tr>
    <tr>
      <th>32</th>
      <td>重要价值客户</td>
      <td>0.0000000000</td>
      <td>165</td>
      <td>8.0000000000</td>
      <td>0.1492591319</td>
    </tr>
    <tr>
      <th>33</th>
      <td>一般发展客户</td>
      <td>20013.0000000000</td>
      <td>8</td>
      <td>8.0000000000</td>
      <td>8.1488736533</td>
    </tr>
    <tr>
      <th>34</th>
      <td>重要挽留客户</td>
      <td>10.0000000000</td>
      <td>9</td>
      <td>9.0000000000</td>
      <td>4.8535628983</td>
    </tr>
    <tr>
      <th>35</th>
      <td>重要发展客户</td>
      <td>2.0000000000</td>
      <td>18</td>
      <td>9.0000000000</td>
      <td>9.3583112923</td>
    </tr>
    <tr>
      <th>36</th>
      <td>重要挽留客户</td>
      <td>20014.0000000000</td>
      <td>199</td>
      <td>11.0000000000</td>
      <td>0.2989058502</td>
    </tr>
    <tr>
      <th>37</th>
      <td>重要唤回客户</td>
      <td>5.0000000000</td>
      <td>17</td>
      <td>11.0000000000</td>
      <td>12.3944512335</td>
    </tr>
    <tr>
      <th>38</th>
      <td>一般发展客户</td>
      <td>9.0000000000</td>
      <td>11</td>
      <td>11.0000000000</td>
      <td>20.7667347675</td>
    </tr>
    <tr>
      <th>39</th>
      <td>一般唤回客户</td>
      <td>10015.0000000000</td>
      <td>11</td>
      <td>11.0000000000</td>
      <td>99.7764227642</td>
    </tr>
    <tr>
      <th>40</th>
      <td>重要挽留客户</td>
      <td>5.0000000000</td>
      <td>15</td>
      <td>13.0000000000</td>
      <td>20.0105370515</td>
    </tr>
    <tr>
      <th>41</th>
      <td>一般发展客户</td>
      <td>5.0000000000</td>
      <td>14</td>
      <td>13.0000000000</td>
      <td>8.7873051180</td>
    </tr>
    <tr>
      <th>42</th>
      <td>重要价值客户</td>
      <td>10.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>2.5288341646</td>
    </tr>
    <tr>
      <th>43</th>
      <td>重要发展客户</td>
      <td>10012.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>3.6629645451</td>
    </tr>
    <tr>
      <th>44</th>
      <td>重要唤回客户</td>
      <td>10012.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>3.5352481628</td>
    </tr>
    <tr>
      <th>45</th>
      <td>一般唤回客户</td>
      <td>9.0000000000</td>
      <td>14</td>
      <td>14.0000000000</td>
      <td>14.8440579572</td>
    </tr>
    <tr>
      <th>46</th>
      <td>重要唤回客户</td>
      <td>2.0000000000</td>
      <td>52</td>
      <td>14.0000000000</td>
      <td>2.9033441981</td>
    </tr>
    <tr>
      <th>47</th>
      <td>一般价值客户</td>
      <td>0.0000000000</td>
      <td>286</td>
      <td>15.0000000000</td>
      <td>0.2457638080</td>
    </tr>
    <tr>
      <th>48</th>
      <td>一般发展客户</td>
      <td>6.0000000000</td>
      <td>1176</td>
      <td>16.0000000000</td>
      <td>0.1742201137</td>
    </tr>
    <tr>
      <th>49</th>
      <td>一般价值客户</td>
      <td>10015.0000000000</td>
      <td>17</td>
      <td>17.0000000000</td>
      <td>99.4443041172</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide_coupon_receive_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select t1.*, t2.用户价值族群 from user_coupon_receive t1</span>
<span class="s1">left join user_RFM t2 on t1.User_id = t2.用户ID</span>
<span class="s1">where coupon_id is not null                                  </span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">        用户价值族群, </span>
<span class="s1">        count(*) as 领券次数, </span>
<span class="s1">        sum(Price_limit) as 优惠券门槛,</span>
<span class="s1">        优惠券门槛 / 领券次数 as 人均门槛</span>
<span class="s1">from wide_coupon_receive_df</span>
<span class="s1">group by 1</span>
<span class="s1">order by 人均门槛 desc</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户价值族群</th>
      <th>领券次数</th>
      <th>优惠券门槛</th>
      <th>人均门槛</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>重要唤回客户</td>
      <td>28095</td>
      <td>1977254.2400000002</td>
      <td>70.3774422495</td>
    </tr>
    <tr>
      <th>1</th>
      <td>重要价值客户</td>
      <td>59412</td>
      <td>4150307.9600000009</td>
      <td>69.8563919747</td>
    </tr>
    <tr>
      <th>2</th>
      <td>重要发展客户</td>
      <td>27938</td>
      <td>1874132.2400000002</td>
      <td>67.0818326294</td>
    </tr>
    <tr>
      <th>3</th>
      <td>重要挽留客户</td>
      <td>134340</td>
      <td>8655225.5100000054</td>
      <td>64.4277617240</td>
    </tr>
    <tr>
      <th>4</th>
      <td>不存在消费记录的用户</td>
      <td>32388</td>
      <td>1844636.7600000005</td>
      <td>56.9543275287</td>
    </tr>
    <tr>
      <th>5</th>
      <td>一般发展客户</td>
      <td>136510</td>
      <td>6722328.8800000055</td>
      <td>49.2442229873</td>
    </tr>
    <tr>
      <th>6</th>
      <td>一般挽留客户</td>
      <td>470007</td>
      <td>21924276.4899999797</td>
      <td>46.6467020491</td>
    </tr>
    <tr>
      <th>7</th>
      <td>一般唤回客户</td>
      <td>355740</td>
      <td>15531050.5200000033</td>
      <td>43.6584317760</td>
    </tr>
    <tr>
      <th>8</th>
      <td>一般价值客户</td>
      <td>934956</td>
      <td>40790025.7799998894</td>
      <td>43.6277490919</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id35">
<h1>优惠券RFM<a class="headerlink" href="#id35" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select a1.cnt * 100 /a2.cnt as 占比 , a1.用户价值族群, COALESCE(a1.Coupon_type::STRING, &#39;UnKnown&#39;) as Coupon_type</span>
<span class="s1">from</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, 用户价值族群, Coupon_type from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2,3</span>
<span class="s1">) a1 join</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, 用户价值族群 from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2</span>
<span class="s1">) a2 using(用户价值族群)</span>
<span class="s1">order by 用户价值族群,占比	DESC</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="c1"># 绘制分布图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;占比&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result_df</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>

<span class="c1"># 设置图表标题和标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;用户价值族群与Coupon_type占比分布&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;占比 (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># 旋转x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3bac56e44f4e47e21058a321931782a49e4b77933e11180ff103632ba112c66d.png" src="_images/3bac56e44f4e47e21058a321931782a49e4b77933e11180ff103632ba112c66d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result_df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select a1.cnt * 100 /a2.cnt as 占比 , a1.用户价值族群, COALESCE(a1.Coupon_type::STRING, &#39;UnKnown&#39;) as Coupon_type</span>
<span class="s1">from</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, 用户价值族群, 优惠券类别	 as Coupon_type from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2,3</span>
<span class="s1">) a1 join</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, 用户价值族群 from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2</span>
<span class="s1">) a2 using(用户价值族群)</span>
<span class="s1">order by 用户价值族群,占比	DESC</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="c1"># 绘制分布图</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;占比&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">result_df</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>

<span class="c1"># 设置图表标题和标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;用户价值族群与优惠券类别	占比分布&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;占比 (%)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>  <span class="c1"># 旋转x轴标签</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># 显示图表</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/t6/xmvwdhg96gsfj8tw02j7mgmr0000gn/T/ipykernel_74226/3574943240.py:26: UserWarning:

Glyph 9 (	) missing from font(s) SimHei.

/Users/liangkaixin/Documents/Notes/商业分析/.venv/lib/python3.10/site-packages/IPython/core/pylabtools.py:170: UserWarning:

Glyph 9 (	) missing from font(s) SimHei.
</pre></div>
</div>
<img alt="_images/9f8b80561ca5fd778b50123162e1751c0c929ccaa38981d4f1cc0845b7fc5cf3.png" src="_images/9f8b80561ca5fd778b50123162e1751c0c929ccaa38981d4f1cc0845b7fc5cf3.png" />
</div>
</div>
<section id="id36">
<h2>不同用户价值族群使用的优惠券类型占比<a class="headerlink" href="#id36" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_data</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_type&#39;</span><span class="p">])[</span><span class="s1">&#39;占比&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># 设置画布大小</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># 获取每个用户价值族群的独特值</span>
<span class="n">user_groups</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#FFFACD&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFEB3B&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFDD44&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFB300&#39;</span><span class="p">,</span> <span class="s1">&#39;#F4A300&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFA500&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFFF00&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFD85C&#39;</span><span class="p">]</span>
<span class="n">unique_coupon_types</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># [&#39;#FFD500&#39;, &#39;#ffc000&#39;, &#39;#ffab00&#39;, &#39;#ff9500&#39;, &#39;#ff8000&#39;, &#39;#ff6b00&#39;]</span>

<span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;UnKnown&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>  <span class="c1"># 浅灰色（未知）</span>
    <span class="s1">&#39;低比例优惠低价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#fff6d6&#39;</span><span class="p">,</span>  <span class="c1"># 浅黄色</span>
    <span class="s1">&#39;低比例优惠中等优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffeead&#39;</span><span class="p">,</span>  <span class="c1"># 中等黄色</span>
    <span class="s1">&#39;中比例优惠低价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffe682&#39;</span><span class="p">,</span>  <span class="c1"># 亮黄色</span>
    <span class="s1">&#39;中比例优惠中等优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span>  <span class="c1"># 金色</span>
    <span class="s1">&#39;中比例优惠高价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFBA66&#39;</span><span class="p">,</span>  <span class="c1"># 深金色</span>
    <span class="s1">&#39;高比例优惠中等优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF8C00&#39;</span><span class="p">,</span>  <span class="c1"># 橙黄色</span>
    <span class="s1">&#39;高比例优惠高价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#CC7000&#39;</span><span class="p">,</span>  <span class="c1"># 深橙色</span>
<span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

<span class="c1"># 循环绘制每个用户价值族群的饼图</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_groups</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 设置每个饼图的位置，这里我们假设有8个族群</span>
    <span class="n">group_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
    <span class="n">explode</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;占比&#39;</span><span class="p">]]</span>  <span class="c1"># 如果占比小于1%就爆开</span>

    <span class="c1"># 获取颜色列表</span>
    <span class="n">colors_for_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]]</span>

    <span class="c1"># 画饼图，不显示百分比</span>
    <span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;占比&#39;</span><span class="p">],</span> 
                            <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span>  <span class="c1"># 设置饼图的起始角度</span>
                            <span class="n">colors</span><span class="o">=</span><span class="n">colors_for_group</span><span class="p">,</span>  <span class="c1"># 更柔和的色彩</span>
                            <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">},</span>  <span class="c1"># 添加黑色边框</span>
                            <span class="n">explode</span> <span class="o">=</span> <span class="n">explode</span><span class="p">,</span>
                            <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 添加阴影效果</span>
    
    <span class="c1"># 设置标题</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># 修改文本标签样式</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>  <span class="c1"># 黑色加粗的标签</span>

<span class="c1"># 设置类别显示在右侧</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">wedges</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Coupon Type&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 设置整体布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6b26da304d8598360bef0d560f58fe5f47234e1e7fd0cdb514a55e14bba8ed51.png" src="_images/6b26da304d8598360bef0d560f58fe5f47234e1e7fd0cdb514a55e14bba8ed51.png" />
</div>
</div>
<p>使用黄色系的颜色来表示不同的优惠券类型，并且重要性越高，颜色越深，为每种优惠券类型选择不同的黄色或金色系渐变颜色。</p>
</section>
<section id="top1unkown">
<h2>不同用户价值族群使用的优惠券类型占比(去除top1和Unkown)<a class="headerlink" href="#top1unkown" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grouped_data</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select a1.cnt * 100 /a2.cnt as 占比 , a1.用户价值族群, COALESCE(a1.Coupon_type::STRING, &#39;UnKnown&#39;) as Coupon_type</span>
<span class="s1">from</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, 用户价值族群, 优惠券类别	 as Coupon_type from wide_df</span>
<span class="s1">    where coupon_id is not null and 优惠券类别 is not null</span>
<span class="s1">    group by 2,3</span>
<span class="s1">) a1 join</span>
<span class="s1">(</span>
<span class="s1">    select   count(*) as cnt, 用户价值族群 from wide_df</span>
<span class="s1">    where coupon_id is not null                 </span>
<span class="s1">    group by 2</span>
<span class="s1">) a2 using(用户价值族群)</span>
<span class="s1">order by 用户价值族群,占比	DESC         </span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="s1">&#39;Coupon_type&#39;</span><span class="p">])[</span><span class="s1">&#39;占比&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="c1"># 设置画布大小</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># 获取每个用户价值族群的独特值</span>
<span class="n">user_groups</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>


<span class="n">color_mapping</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;UnKnown&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span>  <span class="c1"># 浅灰色（未知）</span>
    <span class="s1">&#39;低比例优惠低价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#fff6d6&#39;</span><span class="p">,</span>  <span class="c1"># 浅黄色</span>
    <span class="s1">&#39;低比例优惠中等优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffeead&#39;</span><span class="p">,</span>  <span class="c1"># 中等黄色</span>
    <span class="s1">&#39;中比例优惠低价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#ffe682&#39;</span><span class="p">,</span>  <span class="c1"># 亮黄色</span>
    <span class="s1">&#39;中比例优惠中等优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFD700&#39;</span><span class="p">,</span>  <span class="c1"># 金色</span>
    <span class="s1">&#39;中比例优惠高价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#FFBA66&#39;</span><span class="p">,</span>  <span class="c1"># 深金色</span>
    <span class="s1">&#39;高比例优惠中等优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF8C00&#39;</span><span class="p">,</span>  <span class="c1"># 橙黄色</span>
    <span class="s1">&#39;高比例优惠高价优惠券&#39;</span><span class="p">:</span> <span class="s1">&#39;#CC7000&#39;</span><span class="p">,</span>  <span class="c1"># 深橙色</span>
<span class="p">}</span>

<span class="n">display</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">[</span><span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;6.0&#39;</span><span class="p">])</span>

<span class="c1"># 自定义autopct函数</span>
<span class="k">def</span><span class="w"> </span><span class="nf">custom_autopct</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s1">&#39;低比例优惠低价优惠券&#39;</span><span class="p">:</span>  <span class="c1"># 仅在 Coupon_type == 6.0 时显示</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%&#39;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span>



<span class="c1"># 循环绘制每个用户价值族群的饼图</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_groups</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 设置每个饼图的位置，这里我们假设有8个族群</span>
    <span class="n">group_data</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="p">[</span><span class="n">grouped_data</span><span class="p">[</span><span class="s1">&#39;用户价值族群&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
    <span class="n">explode</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;占比&#39;</span><span class="p">]]</span>  <span class="c1"># 如果占比小于1%就爆开</span>

    <span class="c1"># 获取颜色列表</span>
    <span class="n">colors_for_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]]</span>


    <span class="c1"># 画饼图，不显示百分比</span>
    <span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;占比&#39;</span><span class="p">],</span> 
                            <span class="n">startangle</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span>  <span class="c1"># 设置饼图的起始角度</span>
                            <span class="n">colors</span><span class="o">=</span><span class="n">colors_for_group</span><span class="p">,</span>  <span class="c1"># 更柔和的色彩</span>
                            <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">},</span>  <span class="c1"># 添加黑色边框</span>
                            <span class="n">explode</span> <span class="o">=</span> <span class="n">explode</span><span class="p">,</span>
                            <span class="n">autopct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pct</span><span class="p">:</span> <span class="n">custom_autopct</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;占比&#39;</span><span class="p">],</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]),</span>
                            <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 添加阴影效果</span>
    
    <span class="c1"># 设置标题</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># 修改文本标签样式</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># 黑色加粗的标签</span>

    <span class="k">for</span> <span class="n">autotext</span><span class="p">,</span> <span class="n">ctype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">autotexts</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">!=</span> <span class="s1">&#39;低比例优惠低价优惠券&#39;</span><span class="p">:</span>
            <span class="n">autotext</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># 隐藏非 6.0 的百分比</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">autotext</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>


<span class="c1"># 设置类别显示在右侧</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">wedges</span><span class="p">,</span> <span class="n">group_data</span><span class="p">[</span><span class="s1">&#39;Coupon_type&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Coupon Type&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 设置整体布局</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>用户价值族群</th>
      <th>Coupon_type</th>
      <th>占比</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div><img alt="_images/18637d61ca14c57cda8629b960f62d1da6f33f1614b74ec84ecaad74dbc37cd7.png" src="_images/18637d61ca14c57cda8629b960f62d1da6f33f1614b74ec84ecaad74dbc37cd7.png" />
</div>
</div>
</section>
<section id="id37">
<h2>结论<a class="headerlink" href="#id37" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>中比例低价优惠券，发放最多，我认为是促活用的。<br />
因为它在活跃度较高的一般价值客户中，占比也是最大的</p></li>
<li><p>低比例低价值优惠券会导致复购率降低，甚至导致客户流失。复购低的人群，往往是使用此类优惠券较多的人群。</p></li>
</ol>
<p>策略：
促活可以多发放中比例低价优惠券；降低流失率，应该减少降低无效券投放</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id38">
<h1>风控<a class="headerlink" href="#id38" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">with t1 AS</span>
<span class="s2">(</span>
<span class="s2">    select count(*) as 领券总数,User_id AS 用户ID, Receive_date from user_coupon_receive</span>
<span class="s2">           WHERE Coupon_id IS NOT NULL</span>
<span class="s2">           group by 2, 3</span>
<span class="s2">)</span>
<span class="s2">SELECT * FROM t1 LEFT JOIN user_RFM USING(用户ID)</span>
<span class="s2">WHERE Receive_date IS NOT NULL</span>
<span class="s2">order by 领券总数 DESC</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>领券总数</th>
      <th>用户ID</th>
      <th>Receive_date</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>50</td>
      <td>64f7f49aa3a6f2d3bdf579dc20f5ee7b</td>
      <td>2023-05-19</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>1</th>
      <td>50</td>
      <td>135b607fa436226daf62b1cbf777c917</td>
      <td>2023-01-16</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>2</th>
      <td>45</td>
      <td>135b607fa436226daf62b1cbf777c917</td>
      <td>2023-05-27</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>3</th>
      <td>42</td>
      <td>02b1727ae62d6484c3bce3b666242ead</td>
      <td>2023-03-01</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>4</th>
      <td>40</td>
      <td>3c9e89409f0884ec9e905c40323230a4</td>
      <td>2023-04-15</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>5</th>
      <td>37</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-11</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>6</th>
      <td>36</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-01-20</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>7</th>
      <td>34</td>
      <td>da4a52ebccf7f143e38876c966b1ff38</td>
      <td>2023-05-12</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>8</th>
      <td>34</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-03-18</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>9</th>
      <td>34</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-15</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>10</th>
      <td>31</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-12</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>11</th>
      <td>30</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-03-14</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>12</th>
      <td>30</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-16</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>13</th>
      <td>30</td>
      <td>8d7c90fa30a96097c5737ecafe4e57db</td>
      <td>2023-03-25</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>14</th>
      <td>30</td>
      <td>ff64a6c6c5790b859c1e97249f36c0ba</td>
      <td>2023-02-25</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>15</th>
      <td>30</td>
      <td>7ecc2f8801ba553a8f9bd7dddd451104</td>
      <td>2023-03-02</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>16</th>
      <td>29</td>
      <td>9672b53f7f3eb658c50707c4956a0e2f</td>
      <td>2023-02-01</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>17</th>
      <td>29</td>
      <td>7ecc2f8801ba553a8f9bd7dddd451104</td>
      <td>2023-04-15</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>18</th>
      <td>29</td>
      <td>a2fde3de810b2a1f6e2adb9f6f1c0e23</td>
      <td>2023-01-01</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>19</th>
      <td>28</td>
      <td>25820554dbcb7f9ccecf8a2a8d37dc6b</td>
      <td>2023-06-27</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>20</th>
      <td>28</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-17</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>21</th>
      <td>27</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-19</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>22</th>
      <td>26</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-14</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>23</th>
      <td>26</td>
      <td>9fa9ac51e71c8c059e04f274d5bd6efc</td>
      <td>2023-04-11</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>24</th>
      <td>26</td>
      <td>bd089a2eb4fe30f3c645ec0e0c058631</td>
      <td>2023-03-18</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>25</th>
      <td>25</td>
      <td>e683073f2f24ab8e307fbc3138416393</td>
      <td>2023-02-27</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>26</th>
      <td>25</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-01-31</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>27</th>
      <td>24</td>
      <td>a256356289a2cf4edd3b0324baed4af5</td>
      <td>2023-05-28</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <th>28</th>
      <td>24</td>
      <td>386ae42393c05364eb5ce86c62f6453e</td>
      <td>2023-02-12</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>29</th>
      <td>24</td>
      <td>5d22212c8e0f5a9d037a889bf5736920</td>
      <td>2023-05-14</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>30</th>
      <td>24</td>
      <td>a132a4442bb94ceeee4fb152cce9114a</td>
      <td>2023-04-29</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>31</th>
      <td>24</td>
      <td>da4a52ebccf7f143e38876c966b1ff38</td>
      <td>2023-02-17</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>32</th>
      <td>23</td>
      <td>1b4b18d638b91be57261530cced8310c</td>
      <td>2023-01-07</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>33</th>
      <td>23</td>
      <td>8ac16d0d02600988ae6c33ea5f4b99cd</td>
      <td>2023-05-18</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>34</th>
      <td>23</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-03-09</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>35</th>
      <td>22</td>
      <td>1cf1420b93c1057f0bf545fb69a3dd2e</td>
      <td>2023-06-02</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>36</th>
      <td>22</td>
      <td>6e0dd657a906a6e72c3dab7993cc711a</td>
      <td>2023-04-01</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>37</th>
      <td>22</td>
      <td>c7d5e76428b24a9f05498ec8497e95c4</td>
      <td>2023-04-14</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>38</th>
      <td>22</td>
      <td>6b182b745c1de380287c392e2c18e59a</td>
      <td>2023-01-13</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>39</th>
      <td>22</td>
      <td>950cdda64940171d81ed541e87d6cc6b</td>
      <td>2023-03-29</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>40</th>
      <td>21</td>
      <td>ff110421440d8fcd5a53a784068c7610</td>
      <td>2023-06-18</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>41</th>
      <td>21</td>
      <td>c5e87601fa9bcb3bf0b11895f743b0eb</td>
      <td>2023-01-28</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>42</th>
      <td>21</td>
      <td>203059efeae080497a881e1d5d88d378</td>
      <td>2023-01-07</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>43</th>
      <td>21</td>
      <td>0c1a17aed80a169a0c0d3bb80b17fd2e</td>
      <td>2023-03-03</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <th>44</th>
      <td>20</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-06-15</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>45</th>
      <td>20</td>
      <td>fec7766b5ea29350082a73e014f22358</td>
      <td>2023-02-06</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <th>46</th>
      <td>20</td>
      <td>f014d8b4e73de415465ba0eefdaa7793</td>
      <td>2023-04-09</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <th>47</th>
      <td>20</td>
      <td>d3b489224bd01e3c0eaf131b48500602</td>
      <td>2023-03-01</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>48</th>
      <td>20</td>
      <td>1299c85e6d75198f5ca20a91baae51b4</td>
      <td>2023-02-19</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <th>49</th>
      <td>20</td>
      <td>8ac16d0d02600988ae6c33ea5f4b99cd</td>
      <td>2023-06-21</td>
      <td>一般价值客户</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select sum(Reduce_amount) as 总优惠, sum(Actual_pay) as 总支出, User_id  from order_detail</span>
<span class="s2">       WHERE Coupon_id IS NOT NULL </span>
<span class="s2">       AND User_id in (&#39;8ebe6816c6b51ad2c3afed2812a053b5&#39;, &#39;b083832263c1b4225990438b03056786&#39;, &#39;bc326638e3ef950e4377b0113afeab3c&#39;)</span>
<span class="s2">       group by 3</span>
<span class="s2">       -- order by cnt DESC</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>总优惠</th>
      <th>总支出</th>
      <th>User_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>458.0000000000</td>
      <td>5513.2000000000</td>
      <td>bc326638e3ef950e4377b0113afeab3c</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8.0000000000</td>
      <td>23.8000000000</td>
      <td>b083832263c1b4225990438b03056786</td>
    </tr>
    <tr>
      <th>2</th>
      <td>615.5000000000</td>
      <td>7269.9300000000</td>
      <td>8ebe6816c6b51ad2c3afed2812a053b5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;select *  from order_detail</span>
<span class="s2">       WHERE User_id in (&#39;b083832263c1b4225990438b03056786&#39;)</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Shop_id</th>
      <th>Order_id</th>
      <th>Coupon_id</th>
      <th>Coupon_type</th>
      <th>Biz_code</th>
      <th>Pay_date</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
      <th>优惠券类别</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>b96db70b506332a7a4f44c156cb4ca1b</td>
      <td>56d7a4c731ab3923c4ff3007b21fc662</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-06-16</td>
      <td>26.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>b96db70b506332a7a4f44c156cb4ca1b</td>
      <td>ea2da07a9a424042b9594caad4918f90</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-06-13</td>
      <td>21.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>74ffd5ce40ba21c957ddb90b0e6f3f1a</td>
      <td>c5a3728a57b6c6261a8446b1df2e94f1</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-06-27</td>
      <td>24.2800000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>6791fffb08d1b564733985c881280191</td>
      <td>020f2f6488f87d4039e5d9fb97fc0533</td>
      <td>df8e3a90599dd80c9d69d5533d472560</td>
      <td>1.0000000000</td>
      <td>D</td>
      <td>2023-04-19</td>
      <td>23.8000000000</td>
      <td>8.0000000000</td>
      <td>中比例优惠低价优惠券</td>
    </tr>
    <tr>
      <th>4</th>
      <td>b083832263c1b4225990438b03056786</td>
      <td>6791fffb08d1b564733985c881280191</td>
      <td>020f2f6488f87d4039e5d9fb97fc0533</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>2023-04-19</td>
      <td>23.8000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cheats_user</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">select User_id, Receive_date::Date AS Receive_date from user_coupon_receive</span>
<span class="s2">WHERE User_id in (&#39;b083832263c1b4225990438b03056786&#39;)</span>
<span class="s2">      &quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 统计每个 Receive_date 的出现次数</span>
<span class="n">date_counts</span> <span class="o">=</span> <span class="n">cheats_user</span><span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">date_counts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">]</span>

<span class="c1"># 创建一个交互式散点图</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">date_counts</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> 
                 <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Receive_date&#39;</span><span class="p">:</span> <span class="s1">&#39;Receive Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">},</span>
                 <span class="n">title</span><span class="o">=</span><span class="s2">&quot;用户b083832263c1b4225990438b03056786的领券记录&quot;</span><span class="p">)</span>

<span class="c1"># 显示点的坐标</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">),</span>
                  <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Date: %</span><span class="si">{x}</span><span class="s1">&lt;br&gt;Count: %</span><span class="si">{y}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">)</span>

<span class="c1"># 显示图表</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id39">
<h1>模型<a class="headerlink" href="#id39" title="Link to this heading">#</a></h1>
<section id="part-1">
<h2>Part 1 概述<a class="headerlink" href="#part-1" title="Link to this heading">#</a></h2>
<section id="id40">
<h3>标签<a class="headerlink" href="#id40" title="Link to this heading">#</a></h3>
<p>用户是否会复购</p>
</section>
<section id="id41">
<h3>优惠券特征<a class="headerlink" href="#id41" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>被使用次数</p></li>
<li><p>被使用金额</p></li>
<li><p>优惠金额</p></li>
<li><p>优惠金额占比</p></li>
<li><p>优惠券类型</p></li>
<li><p>优惠券复购率</p></li>
</ol>
</section>
<section id="id42">
<h3>用户特征<a class="headerlink" href="#id42" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>用户领取优惠券次数</p></li>
<li><p>用户获得优惠券但没有消费的次数</p></li>
<li><p>用户获得优惠券并核销次数</p></li>
<li><p>复购率</p></li>
<li><p>复购周期</p></li>
<li><p>用户群体类型</p></li>
<li><p>注册时长</p></li>
</ol>
</section>
</section>
<section id="part-2">
<h2>Part 2 标签构建<a class="headerlink" href="#part-2" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    select</span>
<span class="s2">        *exclude(Pay_date),</span>
<span class="s2">        Pay_date::date as Pay_date,</span>
<span class="s2">        优惠券类别,</span>
<span class="s2">        用户价值族群,</span>
<span class="s2">        lead(优惠券类别) over (partition by User_id order by Pay_date::date) as next_优惠券类别,</span>
<span class="s2">        lead(Coupon_id) over (partition by User_id order by Pay_date::date) as next_coupon_id,</span>
<span class="s2">        lead(Coupon_type) over (partition by User_id order by Pay_date::date) as next_Coupon_type,</span>
<span class="s2">        case when next_coupon_id is not null then 1 else 0 end as 是否复购</span>
<span class="s2">    from wide_df</span>
<span class="s2">;</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">train_data</span>  <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="c1"># 自定义列数</span>
<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 想分几列就改这里</span>

<span class="c1"># 获取查询结果</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    select round(sum(是否复购) * 100 / count(*), 2)::FLOAT as 复购率, </span>
<span class="s2">           Coupon_type::INT as Coupon_type, </span>
<span class="s2">           优惠券类别, </span>
<span class="s2">           用户价值族群</span>
<span class="s2">    from train_data    </span>
<span class="s2">    where Coupon_type is not null      </span>
<span class="s2">    group by 2, 3, 4      </span>
<span class="s2">    order by Coupon_type, 复购率, 用户价值族群 desc                   </span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

<span class="c1"># 计算每列的行数</span>
<span class="n">rows_per_col</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>

<span class="c1"># 拆分为多个子 DataFrame</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">rows_per_col</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rows_per_col</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)]</span>

<span class="c1"># 转成 HTML</span>
<span class="n">htmls</span> <span class="o">=</span> <span class="p">[</span><span class="n">subdf</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">subdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>

<span class="c1"># 拼接成横向展示的 HTML</span>
<span class="n">html_output</span> <span class="o">=</span> <span class="s1">&#39;&lt;div style=&quot;display: flex; gap: 10px;&quot;&gt;&#39;</span>
<span class="k">for</span> <span class="n">html</span> <span class="ow">in</span> <span class="n">htmls</span><span class="p">:</span>
    <span class="n">html_output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&lt;div style=&quot;flex: 1;&quot;&gt;</span><span class="si">{</span><span class="n">html</span><span class="si">}</span><span class="s1">&lt;/div&gt;&#39;</span>
<span class="n">html_output</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span>

<span class="c1"># 显示</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">html_output</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div style="display: flex; gap: 10px;"><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>复购率</th>
      <th>Coupon_type</th>
      <th>优惠券类别</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>11.7600002289</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>14.2899999619</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>22.4500007629</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>23.0000000000</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>31.4699993134</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>33.6599998474</td>
      <td>0</td>
      <td>低比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>23.4500007629</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>23.5699996948</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>23.8199996948</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>23.9699993134</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>30.2099990845</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>31.7900009155</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>33.6899986267</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>34.4199981689</td>
      <td>1</td>
      <td>中比例优惠低价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>30.9899997711</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>34.2500000000</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>34.6199989319</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>35.8499984741</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>42.2700004578</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>44.4399986267</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>44.5200004578</td>
      <td>2</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>复购率</th>
      <th>Coupon_type</th>
      <th>优惠券类别</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>34.2099990845</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>38.8300018311</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>40.3100013733</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>43.6199989319</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>47.2799987793</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>54.2999992371</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>55.3800010681</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>61.0800018311</td>
      <td>3</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>21.3199996948</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>24.2700004578</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>24.3999996185</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>26.4599990845</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>32.2999992371</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>32.7999992371</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>34.4000015259</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>36.2799987793</td>
      <td>4</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>20.0000000000</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>21.4300003052</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>28.5499992371</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>32.4300003052</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>35.2900009155</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>38.2700004578</td>
      <td>5</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要价值客户</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>复购率</th>
      <th>Coupon_type</th>
      <th>优惠券类别</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>50.6199989319</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>53.2200012207</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>55.8600006104</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>59.3499984741</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>62.3699989319</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>65.5199966431</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>66.3600006104</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>72.9499969482</td>
      <td>6</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>40.6300010681</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>42.8600006104</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>43.7500000000</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>45.4500007629</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>9</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>26.5300006866</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>28.5699996948</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>33.3300018311</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>35.7099990845</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>40.9500007629</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>43.0400009155</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>80.0000000000</td>
      <td>10</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>11</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>复购率</th>
      <th>Coupon_type</th>
      <th>优惠券类别</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0.0000000000</td>
      <td>11</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>11</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>40.5900001526</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>51.8699989319</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>56.8499984741</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>57.1399993896</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>69.0500030518</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>70.0899963379</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>75.1699981689</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>76.7799987793</td>
      <td>10010</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>42.8600006104</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>49.4399986267</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>57.1399993896</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>63.1599998474</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>68.8899993896</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>71.4300003052</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>74.4899978638</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>83.7200012207</td>
      <td>10012</td>
      <td>高比例优惠高价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>10015</td>
      <td>高比例优惠中等优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>5.8800001144</td>
      <td>10015</td>
      <td>高比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>21.3700008392</td>
      <td>10015</td>
      <td>高比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>29.1700000763</td>
      <td>10015</td>
      <td>高比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>45.4500007629</td>
      <td>10015</td>
      <td>高比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>10015</td>
      <td>高比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
  </tbody>
</table></div><div style="flex: 1;"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>复购率</th>
      <th>Coupon_type</th>
      <th>优惠券类别</th>
      <th>用户价值族群</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>25.0000000000</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>30.2999992371</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>31.6100006104</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>39.6399993896</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>52.7299995422</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>57.1399993896</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>64.7600021362</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>69.0899963379</td>
      <td>20011</td>
      <td>中比例优惠高价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>0.0000000000</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>40.7400016785</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>45.8300018311</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>重要唤回客户</td>
    </tr>
    <tr>
      <td>64.1500015259</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>87.5000000000</td>
      <td>20013</td>
      <td>中比例优惠中等优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>44.7200012207</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <td>49.8300018311</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般挽留客户</td>
    </tr>
    <tr>
      <td>50.0000000000</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要发展客户</td>
    </tr>
    <tr>
      <td>51.8100013733</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般发展客户</td>
    </tr>
    <tr>
      <td>63.5499992371</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <td>65.5599975586</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般唤回客户</td>
    </tr>
    <tr>
      <td>66.5400009155</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>一般价值客户</td>
    </tr>
    <tr>
      <td>68.5699996948</td>
      <td>20014</td>
      <td>低比例优惠低价优惠券</td>
      <td>重要唤回客户</td>
    </tr>
  </tbody>
</table></div></div></div></div>
</div>
</section>
<section id="part-3">
<h2>Part 3 特征工程<a class="headerlink" href="#part-3" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>User_id</th>
      <th>Shop_id</th>
      <th>Order_id</th>
      <th>Coupon_id</th>
      <th>Coupon_type</th>
      <th>Biz_code</th>
      <th>Actual_pay</th>
      <th>Reduce_amount</th>
      <th>优惠券类别</th>
      <th>用户价值族群</th>
      <th>Actual_pay_log</th>
      <th>Reduce_amount_log</th>
      <th>Pay_date</th>
      <th>优惠券类别_1</th>
      <th>用户价值族群_1</th>
      <th>next_优惠券类别</th>
      <th>next_coupon_id</th>
      <th>next_Coupon_type</th>
      <th>是否复购</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>7550d9c1ef1e3db78ad6a37fa2cd9243</td>
      <td>b7a7240fd7d3ed8ed7e5f15b520a1ce1</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>29.5000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>3.4177266836</td>
      <td>0.0000000000</td>
      <td>2023-04-06</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>2ada2f83375207b727b13c0062476ac4</td>
      <td>e8107199a708ff092071515e3577a9e1</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>29.4000000000</td>
      <td>0.5200000000</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>3.4314032237</td>
      <td>0.4187103349</td>
      <td>2023-04-06</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>0e044139182fcf8efd31986105dde5d5</td>
      <td>d1f6536632f023a097885c015cb5a90b</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>24.0000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>3.2188758249</td>
      <td>0.0000000000</td>
      <td>2023-04-07</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>0e044139182fcf8efd31986105dde5d5</td>
      <td>a00153b3e64e712244722f355b1effc3</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>30.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>3.4626060098</td>
      <td>0.0000000000</td>
      <td>2023-04-08</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9520a932cd79c952c1f4555ae1d2fedc</td>
      <td>0e044139182fcf8efd31986105dde5d5</td>
      <td>76417c49260f5295bc14f3aadf8a8568</td>
      <td>None</td>
      <td>NaN</td>
      <td>D</td>
      <td>30.9000000000</td>
      <td>0.0000000000</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>3.4626060098</td>
      <td>0.0000000000</td>
      <td>2023-04-09</td>
      <td>None</td>
      <td>一般价值客户</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. 用户复购率</span>
<span class="c1"># 2. 用户在Coupon_type下的复购率</span>
<span class="c1"># 3. 用户核销率</span>
<span class="n">fea</span> <span class="o">=</span> <span class="n">query_df</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">select </span>
<span class="s1">train_data.*exclude(Coupon_type),</span>
<span class="s1">train_data.Coupon_type::varchar as Coupon_type,</span>

<span class="s1">              </span>
<span class="s1">count(*) over (partition by train_data.User_id) * 100 / coalesce(用户领券数, 0)  用户核销率,                   </span>
<span class="s1">sum(是否复购) over (partition by train_data.User_id, train_data.Coupon_type) * 100 / count(*) over (partition by train_data.User_id, train_data.Coupon_type) as 用户在此类优惠券下的复购率,</span>
<span class="s1">sum(Reduce_amount) over (partition by train_data.User_id, train_data.Coupon_type) * 100/ sum(Actual_pay + Reduce_amount) over (partition by train_data.User_id, train_data.Coupon_type)  as 用户在此类优惠券下的优惠占比,      </span>


<span class="s1">sum(是否复购) over (partition by train_data.Coupon_type) * 100  / count(*) over (partition by train_data.Coupon_type) as 优惠券复购率,               </span>
<span class="s1">count(*) over (partition by train_data.Coupon_type) * 100 / coalesce(优惠券发放数, 0)  优惠券核销率,</span>
<span class="s1">sum(Reduce_amount) over (partition by train_data.Coupon_type) * 100/ sum(Actual_pay + Reduce_amount) over (partition by train_data.Coupon_type)  as 此类优惠券的优惠占比,</span>
<span class="s1">      </span>
<span class="s1">sum(Reduce_amount) over (partition by train_data.Coupon_id) * 100/ sum(Actual_pay + Reduce_amount) over (partition by train_data.Coupon_id)  as 此优惠券的优惠占比                              </span>
<span class="s1">                                                  </span>
<span class="s1">from train_data</span>
<span class="s1">left join(select User_id, count(*) 用户领券数 from user_coupon_receive group by 1) t1 on train_data.User_id = t1.User_id                   </span>
<span class="s1">left join(select Coupon_type, count(*) 优惠券发放数 from user_coupon_receive group by 1) t2 on train_data.Coupon_type = t2.Coupon_type                </span>

<span class="s1">where train_data.Coupon_type is not null         </span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fea</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;User_id&#39;,
 &#39;Shop_id&#39;,
 &#39;Order_id&#39;,
 &#39;Coupon_id&#39;,
 &#39;Biz_code&#39;,
 &#39;Actual_pay&#39;,
 &#39;Reduce_amount&#39;,
 &#39;优惠券类别&#39;,
 &#39;用户价值族群&#39;,
 &#39;Actual_pay_log&#39;,
 &#39;Reduce_amount_log&#39;,
 &#39;Pay_date&#39;,
 &#39;优惠券类别_1&#39;,
 &#39;用户价值族群_1&#39;,
 &#39;next_优惠券类别&#39;,
 &#39;next_coupon_id&#39;,
 &#39;next_Coupon_type&#39;,
 &#39;是否复购&#39;,
 &#39;Coupon_type&#39;,
 &#39;用户核销率&#39;,
 &#39;用户在此类优惠券下的复购率&#39;,
 &#39;用户在此类优惠券下的优惠占比&#39;,
 &#39;优惠券复购率&#39;,
 &#39;优惠券核销率&#39;,
 &#39;此类优惠券的优惠占比&#39;,
 &#39;此优惠券的优惠占比&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-4">
<h2>Part 4 模型<a class="headerlink" href="#part-4" title="Link to this heading">#</a></h2>
<p>我们会用：</p>
<p>📦 scikit-learn</p>
<p>🧠 模型：LogisticRegression（逻辑回归，快速可解释）</p>
<p>🔍 特征：Coupon_type, 优惠券类别, 用户价值族群, next_优惠券类别, next_Coupon_type 等等</p>
<p>🧪 切分训练 / 测试集，评估准确率、召回率等</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">catboost</span><span class="w"> </span><span class="kn">import</span> <span class="n">CatBoostClassifier</span><span class="p">,</span> <span class="n">Pool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">classification_report</span>

<span class="c1"># 特征列（可以加更多你觉得重要的）</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &#39;User_id&#39;,</span>
    <span class="c1"># &#39;Coupon_id&#39;,</span>
    <span class="c1"># &#39;Pay_date&#39;,</span>
    <span class="s1">&#39;优惠券类别&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;用户价值族群&#39;,</span>
    <span class="c1"># &#39;next_优惠券类别&#39;,</span>
    <span class="c1"># &#39;next_coupon_id&#39;,</span>
    <span class="c1"># &#39;next_Coupon_type&#39;,</span>
    <span class="s1">&#39;Coupon_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;用户核销率&#39;</span><span class="p">,</span>
    <span class="s1">&#39;用户在此类优惠券下的复购率&#39;</span><span class="p">,</span>
    <span class="s1">&#39;优惠券复购率&#39;</span><span class="p">,</span>
    <span class="s1">&#39;优惠券核销率&#39;</span><span class="p">,</span>
    <span class="s1">&#39;用户在此类优惠券下的优惠占比&#39;</span><span class="p">,</span>
    <span class="s1">&#39;此类优惠券的优惠占比&#39;</span><span class="p">,</span>
    <span class="s1">&#39;此优惠券的优惠占比&#39;</span>
 <span class="p">]</span>

<span class="c1"># 标明哪些是类别特征（CatBoost 可以直接处理）</span>
<span class="n">cat_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &#39;用户价值族群&#39;,</span>
    <span class="s1">&#39;优惠券类别&#39;</span><span class="p">,</span>
    <span class="c1"># &#39;Coupon_type&#39;</span>
<span class="p">]</span>


<span class="c1"># 丢掉缺失目标行（标签没缺也OK）</span>
<span class="n">df_model</span> <span class="o">=</span> <span class="n">fea</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;优惠券类别&#39;</span><span class="p">])</span>

<span class="c1"># 特征 + 标签</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df_model</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_model</span><span class="p">[</span><span class="s1">&#39;是否复购&#39;</span><span class="p">]</span>

<span class="c1"># 划分训练集 / 测试集</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>



<span class="c1"># 建模</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CatBoostClassifier</span><span class="p">(</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>

<span class="c1"># 拟合</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cat_features</span><span class="o">=</span><span class="n">cat_features</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># 预测</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># 输出结果</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0:	learn: 0.2573504	test: 0.2554246	best: 0.2554246 (0)	total: 70.1ms	remaining: 21s
50:	learn: 0.3214085	test: 0.3189272	best: 0.3189272 (50)	total: 2.79s	remaining: 13.6s
100:	learn: 0.3276372	test: 0.3258103	best: 0.3258103 (100)	total: 5.23s	remaining: 10.3s
150:	learn: 0.3270367	test: 0.3249316	best: 0.3260667 (101)	total: 7.69s	remaining: 7.59s
200:	learn: 0.3273544	test: 0.3255151	best: 0.3260667 (101)	total: 10.1s	remaining: 4.97s
250:	learn: 0.3280593	test: 0.3258080	best: 0.3260667 (101)	total: 12.5s	remaining: 2.44s
299:	learn: 0.3287711	test: 0.3266151	best: 0.3266341 (298)	total: 15.1s	remaining: 0us

bestTest = 0.3266341375
bestIteration = 298

Shrink model to first 299 iterations.
              precision    recall  f1-score   support

           0       0.69      0.95      0.80    124018
           1       0.72      0.21      0.33     67931

    accuracy                           0.69    191949
   macro avg       0.70      0.58      0.56    191949
weighted avg       0.70      0.69      0.63    191949
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">precision_recall_curve</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">precision</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">recall</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Threshold=0.3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precision-Recall vs Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/67b7f360512682ec456b561297296e70e29417b9dc9358557a0e6d6c8f7afcd1.png" src="_images/67b7f360512682ec456b561297296e70e29417b9dc9358557a0e6d6c8f7afcd1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">get_feature_importance</span><span class="p">(</span><span class="n">prettified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Feature Id</th>
      <th>Importances</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>用户在此类优惠券下的复购率</td>
      <td>81.2997303654</td>
    </tr>
    <tr>
      <th>1</th>
      <td>优惠券复购率</td>
      <td>5.6868594536</td>
    </tr>
    <tr>
      <th>2</th>
      <td>优惠券类别</td>
      <td>3.0069474692</td>
    </tr>
    <tr>
      <th>3</th>
      <td>用户核销率</td>
      <td>2.3678478861</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Coupon_type</td>
      <td>1.9523072000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>优惠券核销率</td>
      <td>1.8432244646</td>
    </tr>
    <tr>
      <th>6</th>
      <td>此类优惠券的优惠占比</td>
      <td>1.3471976073</td>
    </tr>
    <tr>
      <th>7</th>
      <td>此优惠券的优惠占比</td>
      <td>1.2608870207</td>
    </tr>
    <tr>
      <th>8</th>
      <td>用户在此类优惠券下的优惠占比</td>
      <td>1.2349985332</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">背景介绍 <strong>优惠券营销：提升获客与用户复购的关键策略</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2"><strong>优惠券的主要分类</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3"><strong>1️⃣ 按使用门槛划分</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4"><strong>2️⃣ 按优惠方式划分</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5"><strong>3️⃣ 按使用范围划分</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6"><strong>优惠券的挑战与优化方向</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7"><strong>✅ 解决方案：个性化精准投放</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">📊 <strong>数据集说明</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">描述性统计(文字)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">描述性统计(图)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">优惠券金额与门槛金额分布对比</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">优惠券类型分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">描述性统计</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">分类依据</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kmeans">选择1 Kmeans分类</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">选择2 阈值分类</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">分类依据(图)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">实际优惠金额与实付金额对比</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">趋势分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">人均使用优惠券次数</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">领券总数分布</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">漏斗模型</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">分析目的</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">用户转化分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">用户复购转化率分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">通过复购率对优惠券分析</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">通过使用速度分层</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm">RFM用户价值分析</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">1️⃣ RFM 数据分布：直方图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">2️⃣ RFM 三变量关系：散点图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rfm-k-means">3️⃣ RFM 分群：K-Means 聚类</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">4️⃣ 各群体的 RFM 指标箱线图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">5️⃣ RFM 得分热力图</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">用户价值分类统计</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">RFM + 用户转化分析</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">不同价值族群的转化漏斗</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">不同用户价值族群的消费分布</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">优惠券RFM</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">不同用户价值族群使用的优惠券类型占比</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#top1unkown">不同用户价值族群使用的优惠券类型占比(去除top1和Unkown)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">结论</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">风控</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">模型</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1">Part 1 概述</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">标签</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">优惠券特征</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">用户特征</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2">Part 2 标签构建</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3">Part 3 特征工程</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4">Part 4 模型</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>